/**
 * dash.service
 * 权限管理，模块加载与初始化
 */

angular.module('dash.service', [])
    // 好友服务
    .factory('AddNewUserService', function (HttpPromiseService, REGISTER_URL) {
        return {
            init: function () {
                // 模拟数据插入数据库
                var data = [
                    // { _id: 17, username: 'ydkf', nickname: "亿达别苑客服", headimg: null },
                    // { _id: 18, username: 'ydgczg', nickname: "亿达别苑工程主管", headimg: null },
                    // { _id: 384, username: 'py', nickname: "彭奕", headimg: "15602452846-201609051736.png" },
                    // { _id: 386, username: 'lxq', nickname: "刘新琼", headimg: null },
                    // { _id: 388, username: 'yxy', nickname: "袁晓勇", headimg: "13760425110-201609191259.png" },
                    // { _id: 412, username: 'heyc', nickname: "何总", headimg: "15602452846-201609051736.png" },
                    // { _id: 414, username: 'wanhuali', nickname: "万华利", headimg: null },
                    // { _id: 415, username: 'lijm', nickname: "李建民", headimg: "lijm-201609220947.png" },
                    // { _id: 417, username: 'xiaorj', nickname: "肖荣界", headimg: null },
                    // { _id: 419, username: 'liws', nickname: "李文帅", headimg: null },
                    // { _id: 420, username: 'chengh', nickname: "陈国辉", headimg: null },
                    // { _id: 421, username: 'yeyj', nickname: "叶昱君", headimg: null },
                    // { _id: 422, username: 'guozc', nickname: "郭仲春", headimg: null },
                    // { _id: 423, username: 'lib', nickname: "李斌", headimg: null },
                    // { _id: 424, username: 'zhouw', nickname: "周文", headimg: "zhouw-201609202117.png" },
                    // { _id: 425, username: 'tiankq', nickname: "田克清", headimg: null },
                    // { _id: 426, username: 'daibl', nickname: "戴白露", headimg: null },
                    // { _id: 427, username: 'haungjy', nickname: "黄金云", headimg: null },
                    // { _id: 428, username: 'gaomx', nickname: "高明霞", headimg: null },
                    // { _id: 431, username: 'zhongsy', nickname: "钟盛樱", headimg: null },
                    // { _id: 432, username: 'zhul', nickname: "朱雷", headimg: null },
                    // { _id: 433, username: 'dl', nickname: "戴露", headimg: "dl-201609191259.png" },
                    // { _id: 434, username: 'hj', nickname: "黄健", headimg: "hj-201609202146.png" },
                    // { _id: 435, username: 'zf', nickname: "周枫", headimg: "zf-201609202116.png" },
                    // { _id: 437, username: 'sxh', nickname: "宋细辉", headimg: "sxh-201609191313.png" },
                    // { _id: 441, username: 'ld', nickname: "卢蝶", headimg: "ld-201609201557.png" },
                    // { _id: 442, username: 'lp', nickname: "李萍", headimg: "lp-201609200945.png" }
                ];
                for (var i = 0; i < data.length; i++) {
                    var params = {
                        username: data[i].username,
                        nickname: data[i].nickname,
                        headimg: data[i].headimg,
                        password: '123'
                    };
                    HttpPromiseService.getData(REGISTER_URL, params).then(function (data) {
                        console.log(data);
                    });
                }
            }
        };
    })
    .factory('AddNewGroupService', function (HttpPromiseService, LOAD_ALL_USER_URL, ADD_FRIEND_URL) {
        return {
            init: function () {
                // 模拟数据插入好友列表
                HttpPromiseService.getData(LOAD_ALL_USER_URL, {}).then(function (data) {
                    var _ids = '';
                    for (var i = 0; i < data.length; i++) {
                        _ids += data[i]._id;
                        _ids += ";"
                    }
                    var params = {
                        username: 'py',
                        _ids: _ids,
                    };

                    HttpPromiseService.getData(ADD_FRIEND_URL, params).then(function (data) {
                       
                        console.log(data);
                    });
                    console.log(data);
                });
            }
        }
    })

    .factory('loadAllFriend', function (HttpPromiseService, LOAD_FRIENDS_URL) {
        return {
            init: function () {
                // 模拟数据插入好友列表
                var params = {
                    username: 'py',
                };
                HttpPromiseService.getData(LOAD_FRIENDS_URL, params).then(function (data) {
                     debugger;
                    console.log(data);
                });
            }
        }
    })
/*
 * controller负责数据对接与权限控制
 */
angular.module('dash', ["dash.service"])
  .controller('DashCtrl', function ($scope, AddNewUserService, AddNewGroupService, loadAllFriend) {
    // 构建消息UI模板
    $scope.buildTplUrl = function (type) {

      /** 业务类模板 */
      var tplUrl;
      switch (type) {
        case 'industry':
          tplUrl = 'industry';
          break;
        case 'medical':
          tplUrl = 'medical';
          break;
        case 'aircondition':
          tplUrl = 'aircondition';
          buildAircondition();
          break;
        default:
        // TODO：隐藏业务tab
      }
      return 'module/dash/business/' + tplUrl + '/' + tplUrl + '.html';
    };

    /**
     * 构建Aircondition业务
     */
    $scope.expanders = [
      {
        title: 'Click me to expand',
        text: 'Hi there folks, I am the content that was hidden but is now shown.'
      },
      {
        title: 'Click this',
        text: 'I am even better text than you have seen previously'
      },
      {
        title: 'Test',
        text: 'test'
      }];
    function buildAircondition() {

    }

    $scope.addNewUser = function () {
      alert('addNewUser');
      AddNewUserService.init();
      console.log("测试添加用户...");
    };
    $scope.addNewGroup = function () {
      alert('addNewGroup');
      AddNewGroupService.init();
      console.log("测试发起群聊...");
    };
    $scope.addGroupMember = function () {
      alert('loadAllFriend');
      loadAllFriend.init();
      console.log("测试添加群成员...");
    };
  })

// 指令实现
var dash=angular.module('dash');
dash.directive('accordion', function() {
    return {
        restrict : 'EA',
        replace : true,
        transclude : true,
        template : '<div ng-transclude></div>',
        controller : function() {
            var expanders = [];
            this.gotOpened = function(selectedExpander) {
                angular.forEach(expanders, function(expander) {
                    if (selectedExpander != expander) {
                        expander.showMe = false;
                    }
                });
            }
            this.addExpander = function(expander) {
                expanders.push(expander);
            }
        }
    }
});

dash.directive('expander', function() {
    return {
        restrict : 'EA',
        replace : true,
        transclude : true,
        require : '^?accordion',
        scope : {
            title : '=expanderTitle'
        },
        template : '<div>'
                   + '<div class="title" ng-click="toggle()">{{title}}</div>'
                   + '<div class="body" ng-show="showMe" ng-transclude></div>'
                   + '</div>',
        link: function(scope, element, attrs, accordionController) {
            scope.showMe = false;
            accordionController.addExpander(scope);
            scope.toggle = function toggle() {
                scope.showMe = !scope.showMe;
                accordionController.gotOpened(scope);
            }
        }
    }
});

/**
 * 指令集
 */
angular.module('chat.directive', [])
    .directive('videoView', function ($rootScope, $timeout) {
        return {
            restrict: 'E',
            template: '<div class="video-container"></div>',
            replace: true,
            link: function (scope, element, attrs) {
                function updatePosition() {
                    try {
                        cordova.plugins.phonertc.setVideoView({
                            container: element[0],
                            local: {
                                position: [10, 10],
                                size: [100, 100]
                            }
                        });
                    } catch (err) {
                        alert('direc' + err);
                    }
                }
                $timeout(updatePosition, 500);
                $rootScope.$on('videoView.updatePosition', updatePosition);
            }
        }
    })
    // 弹框背景
    .directive('rjCloseBackDrop', [function () {
        return {
            scope: false,
            restrict: 'A',
            replace: false,
            link: function (scope, iElm, iAttrs, controller) {
                var htmlEl = angular.element(document.querySelector('html'));
                htmlEl.on("click", function (event) {
                    if (event.target.nodeName === "HTML" &&
                        scope.popup.optionsPopup && scope.popup.isPopup) {
                        scope.popup.optionsPopup.close();
                        scope.popup.isPopup = false;
                    }
                });
            }
        };
    }])
    // 长按弹出框
    .directive('rjHoldActive', ['$ionicGesture', '$timeout', '$ionicBackdrop',
        function ($ionicGesture, $timeout, $ionicBackdrop) {
            return {
                scope: false,
                restrict: 'A',
                replace: false,
                link: function (scope, iElm, iAttrs, controller) {
                    $ionicGesture.on("hold", function () {
                        iElm.addClass('active');
                        $timeout(function () {
                            iElm.removeClass('active');
                        }, 300);
                    }, iElm);
                }
            };
        }
    ])
    // 进入时隐藏tab，退出时显示(用于聊天)
    .directive('hideTabsxietong', function ($rootScope) {
        return {
            restrict: 'A',
            link: function ($scope, $el) {
                $scope.$on("$ionicView.beforeEnter", function () {
                    $rootScope.hideTabsxietong = true;
                });
                $scope.$on("$ionicView.beforeLeave", function () {
                    $rootScope.hideTabsxietong = false;
                });
            }
        };
    });

angular.module('chat.directive')
    .directive('chatInput', function (PhotoAndImages, $timeout) {
        return {
            restrict: "E",
            templateUrl: 'module/chat/directives/chatinput/chatinput.tpl',
            replace: true,
            scope: {
                sendmessage: "=textMessage",
                onShowFace: "=onShowFace",
                onShowPhonebar: "=onShowPhonebar",
                onSendTextMessage: "&onSendTextMessage",
                onVoiceHold: "&onVoiceHold",
                onVoiceRelease: "&onVoiceRelease",
            },
            link: function (scope, element, attrs, controller) {
                scope.isVoiceMethod = true;
                scope.isStartRecord = 0,

                scope.switchInputMethod = function (evtobj) {
                    if (scope.isVoiceMethod = !scope.isVoiceMethod, scope.isVoiceMethod) {
                        var i = 1;
                    } else {
                        var input = evtobj.currentTarget.parentNode.querySelector("textarea");
                        scope.isStartRecord = !1;
                        $timeout(function () {
                            // input.focus()
                        }, 500);
                    }
                }

                scope.onSendMessage = function () {
                    scope.onSendTextMessage()();
                    //scope.sendmessage = '';
                    $timeout(function () {
                        document.querySelector("#text_content").focus();
                    }, 0);
                }
                scope.onVoiceHold = function () { }
                scope.onVoiceRelease = function () { }

            }
        };
    });

angular.module('chat.directive')
    .directive('chatMessagePanel', function ($ionicModal, $timeout) {
        return {
            restrict: "E",
            templateUrl: 'module/chat/directives/chatmessagepanel/chatmessagepanel.tpl',
            replace: true,
            scope: {
                messageList: "=messageList",
            },
            link: function (scope, element, attrs, controller) {
                var mediaRec;
                scope.play = function (voiFile, type) {
                    if (mediaRec) {
                        mediaRec.stop();
                        mediaRec.release();
                    }
                    var target = angular.element(event.target).find("i");
                    if (type == "you") {
                        target.addClass("web_wechat_voice_gray_playing");
                    } else {
                        target.addClass("web_wechat_voice_playing");
                    }
                    if (isIOS) {
                        voiFile = voiFile.replace('file://', '');
                    }
                    mediaRec = new Media(voiFile,
                        // 成功操作
                        function () {
                            if (type == "you") {
                                target.removeClass("web_wechat_voice_gray_playing");
                            } else {
                                target.removeClass("web_wechat_voice_playing");
                            }
                            console.log("play():Audio Success");
                        },
                        // 失败操作
                        function (err) {
                            if (type == "you") {
                                target.removeClass("web_wechat_voice_gray_playing");
                            } else {
                                target.removeClass("web_wechat_voice_playing");
                            }
                            console.log("play():Audio Error: " + err.code);
                        }
                    );
                    //开始播放录音
                    mediaRec.play();
                    return false;
                };

                $ionicModal.fromTemplateUrl('module/chat/directives/chatmessagepanel/message/BigImage.html', {
                    scope: scope,
                    animation: 'slide-in-up'
                }).then(function (modal) {
                    scope.modal = modal;
                });
                scope.openImage = function (data) {
                    scope.imageData = data;
                    scope.modal.show();
                };
                scope.closeModal = function () {
                    scope.modal.hide();
                };
                scope.openImage = function (data) {
                    scope.imageData = data;
                    scope.modal.show();
                };
                // 构建消息UI模板
                scope.buildUrl = function (type) {
                    var tmpName;
                    switch (type) {
                        case 'RC:TxtMsg':
                            tmpName = 'txt';
                            break;
                        case 'RC:ImgMsg':
                            tmpName = 'img';
                            break;
                        case 'RC:DizNtf':
                            tmpName = 'diz';
                            break;
                        case 'RC:LBSMsg':
                            tmpName = 'lbs';
                            break;
                        case 'RC:ImgTextMsg':
                            tmpName = 'imgtext';
                            break;
                        case 'RC:VcMsg':
                            tmpName = 'vc';
                            break;
                        default:

                    }
                    return 'module/chat/directives/chatmessagepanel/message/' + tmpName + '.html';
                }
            }
        };
    });

angular.module('chat.directive')
    .directive('chatToolBar', function(PhotoAndImages) {
        return {
            restrict: "E",
            templateUrl: 'module/chat/directives/chattoolbar/chattoolbar.tpl',
            replace: true,
            scope: {
                sendPhoto: "&sendPhoto",
                conversationType:"=conversationType"
            },
            link: function(scope, element, attrs, controller) {
                scope.takePic = function(way) {
                    var options;
                    // 从相册中选择
                    if (way) {
                        options = {
                            quality: 80,
                            targetWidth: 320,
                            targetHeight: 320,
                            saveToPhotoAlbum: false,
                            sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
                            destinationType: Camera.DestinationType.FILE_URI
                        };
                        PhotoAndImages.getImages(options).then(function(data) {
                            scope.sendPhoto()(data);
                        });
                    } else {
                        // 拍照获取
                        options = {
                            quality: 80,
                            targetWidth: 320,
                            targetHeight: 320,
                            saveToPhotoAlbum: false,
                            sourceType: Camera.PictureSourceType.Camera,
                            destinationType: Camera.DestinationType.FILE_URI
                        };
                        PhotoAndImages.getPhoto(options).then(function(data) {
                            scope.sendPhoto()(data);
                        });
                    }
                }
            }
        };
    });

angular.module('chat.directive')
    .directive('messageList', function ($ionicPopup) {
        return {
            restrict: "E",
            templateUrl: 'module/chat/directives/messagelist/messagelist.tpl',
            replace: true,
            scope: {
                friendsMessage: "=friendsMessage",
                gotoChatDetils: "&gotoChatDetils2",
                markMessage: "&markMessage2",
                deleteMessage: "&deleteMessage2",
            },
            link: function (scope, element, attrs, controller) {
                scope.popup = {
                    isPopup: false,
                    index: 0
                };
                // 弹出框
                scope.popupMessageOpthins = function (message) {
                    scope.popup.index = scope.friendsMessage.indexOf(message);
                    scope.popup.optionsPopup = $ionicPopup.show({
                        templateUrl: "module/chat/directives/messagelist/popup.html",
                        scope: scope,
                    });
                    scope.popup.isPopup = true;
                };
                // 设为已读
                scope.markMessage_local = function () {
                    var index = scope.popup.index;
                    scope.popup.optionsPopup.close();
                    scope.popup.isPopup = false;
                    scope.markMessage()(index);
                };
                // 删除消息
                scope.deleteMessage_local = function () {
                    var index = scope.popup.index;
                    scope.popup.optionsPopup.close();
                    scope.popup.isPopup = false;
                    scope.deleteMessage()(index);
                };

                scope.gotoChatDetils_local = function (friend, $index) {
                    scope.gotoChatDetils()(friend, $index);
                }
            }
        };
    });

/**
 * 指令集
 */
angular.module('chat.directive')
    .directive("ngTouchend", function() {
        return {
            controller: function($scope, $element, $attrs) {
                $element.bind('touchend', onTouchEnd);

                function onTouchEnd(event) {
                    var method = $element.attr('ng-touchend');
                    $scope.$event = event;
                    $scope.$apply(method);
                };
            }
        };
    }).directive("ngTouchmove", function() {
        return {
            controller: function($scope, $element, $attrs) {
                $element.bind('touchstart', onTouchStart);

                function onTouchStart(event) {
                    event.preventDefault();
                    $element.bind('touchmove', onTouchMove);
                    $element.bind('touchend', onTouchEnd);
                };

                function onTouchMove(event) {
                    var method = $element.attr('ng-touchmove');
                    $scope.$event = event;
                    $scope.$apply(method);
                };

                function onTouchEnd(event) {
                    event.preventDefault();
                    $element.unbind('touchmove', onTouchMove);
                    $element.unbind('touchend', onTouchEnd);
                };
            }
        };
    }).directive('contactNav', [function() {
        return {
            restrict: "E",
            template: '<div class="nav-container">'
            + '    <ul class="alpha-nav" '
            + '        ng-touchmove="goList($event)" '
            + '        ng-touchend="hidePromptBox()" '
            + '        ng-touchstart="goListByTap($event)">'
            + '        <li ng-repeat="charobj in navCharList_local" '
            + '              data-id="{{charobj.id}}">{{charobj.firstChar}} '
            + '        </li> '
            + '        <div class="prompt-box" ng-show="tipObj.isShow">{{tipObj.content}}</div> '
            + '    </ul> '
            + '</div>',
            replace: true,
            scope: {
                navCharList_local: "=navCharList",
                charClickCb: "&charClickCb"
            },
            link: function(scope, element, attrs, controller) {
                // 滚动的指定元素
                var _delegateHandle = attrs["delegateHandleName"];
                scope.tipObj = {
                    "isShow": false,
                    "content":''
                };

                /*
                 * 隐藏提示框
                 * @param {object} event [release事件对象]
                 * */
                scope.hidePromptBox = function(event) {
                    scope.tipObj = { "isShow": false };
                };

                /*
                 * 用户单击
                 * @param {object} event [release事件对象]
                 * */
                scope.goListByTap = function(event) {
                    var nodeName = event.target.nodeName.toUpperCase();
                    if (nodeName !== "LI") {
                        return;
                    }
                    // 事件源
                    var target = angular.element(event.target);
                    // 首字母
                    var firstCode = target.html();
                    // 导航事件回调
                    var aaaa = scope.charClickCb()(firstCode);

                    //标签id
                    var id = target.attr("data-id");
                    scope.tipObj = { "isShow": true, "content": firstCode };

                    scrollCharToTop(id, _delegateHandle);
                };

                /*
                 * 用户滑动
                 * @param {object} event [release事件对象]
                 * */
                scope.goList = function(event) {
                    var nodeName = event.target.nodeName.toUpperCase();
                    if (nodeName !== "LI") {
                        return;
                    }
                    // 根据坐标来获取元素！
                    var ttt = document.elementFromPoint(
                        event.changedTouches[0].pageX,
                        event.changedTouches[0].pageY
                    );
                    nodeName = ttt ? ttt.nodeName.toUpperCase() : "";
                    if (nodeName !== "LI") {
                        return;
                    }
                    var target = angular.element(ttt);
                    var firstCode = target.html().trim();
                    // 导航事件回调
                    scope.charClickCb()(firstCode);
                    // 导航id
                    var id = target.attr("data-id");
                    // 提示框
                    scope.tipObj = { "isShow": true, "content": firstCode };
                    scrollCharToTop(id, _delegateHandle);
                };

                /*
                 * 通讯录滚动逻辑
                 * @param {object} id [首字母元素ID]
                 * @param {object} _delegateHandle [容器对象]
                 * */
                function scrollCharToTop(id, _delegateHandle) {
                    var charPos = angular.element(document.querySelectorAll("#_" + id));
                    var contactContainer = angular.element(document.querySelectorAll("#" + _delegateHandle));
                    if (charPos.length === 1) {
                        scrollTop = charPos[0].offsetTop;
                        // 27为元素高度
                        contactContainer[0].scrollTop = scrollTop - 27;
                    } else {
                        throw ("nav not exits or more than one");
                    }
                }
            }
        };
    }]);

angular.module('chat.directive')
    .directive('phoneContact', function ($state, $ionicLoading,
        $ionicScrollDelegate, $timeout) {
        return {
            restrict: "E",
            templateUrl: 'module/chat/directives/phonecontact/phonecontact.tpl',
            replace: true,
            transclude : true,
            scope: {
                friendsList_local: "=friendsList",
                groupsList_local: "=groupsList",
            },
            link: function (scope, element, attrs, controller) {
                scope.initTalk = function (friendID, username, type, $event) {
                    $state.go('tab.chatDetail', {
                        messageId: '1', name: username, targetId: friendID,
                        conversationType: type
                    });
                    $event.stopPropagation();
                    $event.preventDefault();
                }
                // 联系人右边导航栏
                scope.cri = { DataValue: '' };
            }
        };
    });

angular.module('chat.directive')
    .directive('qqFace',function() {
        return {
            restrict: "E",
            templateUrl: 'module/chat/directives/qqface/qqface.tpl',
            replace: true,
            scope: {
                selectQqFace: "&selectQqFace"
            },
            link: function(scope, element, attrs, controller) {
                // 表情选择事件
                scope.chooseFace = function(evt) {
                    if (evt.srcElement.title) {
                        var text_content = document.querySelector("#text_content");
                        scope.selectQqFace()("[" + event.srcElement.title + "]");
                    }
                }
            }
        };
    });

angular.module('chat.directive')
    .directive('resFriendTeam', function ($ionicLoading, $timeout, ResFriend, ResTeam) {
        return {
            restrict: "E",
            templateUrl: 'module/chat/directives/resfriendteam/resfriendteam.tpl',
            replace: true,
            scope: {
                groupinviteList_local: "=groupinviteList",
                friendinviteList_local: "=friendinviteList",
                responseReq_local: "&responseReq",
            },
            link: function (scope, element, attrs, controller) {
                scope.responseReq_local = function (id, name, type, state, $index) {
                    if (type == "PRIVATE") {
                        // 好友请求 UserID, FriendID, state
                        ResFriend(curUID, id, state, callback);
                    } else {
                        // 团队邀请 groupID, MemberID, state
                        ResTeam(id, curUID, state, callback);
                    }
                    var showMsg = '';
                    function callback(data) {
                        // 成功后删掉记录并刷新好友列表
                        var obj = {};
                        if (type == "PRIVATE") {
                            if (state == '1') {
                                showMsg = "您已添加" + name + "为好友!";
                                // 同步至融云(可选，已在服务端做同步)
                            } else {
                                showMsg = "您已拒绝" + name + "的好友请求!";
                            }
                            $ionicLoading.show({
                                template: showMsg
                            });
                            // 添加到通讯录
                            obj.id = id;
                            obj.name = name;
                            obj.alpha = makePy(obj.name)[0][0].toUpperCase();
                            obj.conversationType = 'PRIVATE';
                            obj.portrait = null;
                            $timeout(function () {
                                $ionicLoading.hide();
                            }, 750);
                            scope.responseReq()(obj, $index);
                        } else {
                            if (state == '1') {
                                showMsg = "您已加入群" + name + "!";
                            } else {
                                showMsg = "您已拒绝加入群" + name + "!";
                            }
                            $ionicLoading.show({
                                template: showMsg
                            });
                            // 添加到通讯录
                            obj.id = 'cre_' + id;
                            obj.number = 10;
                            obj.max_number = 30;
                            obj.name = name;
                            obj.conversationType = 'GROUP';
                            obj.type = 'create';
                            obj.portrait = null;//'亿达别苑维修工_200.png';
                            $timeout(function () {
                                $ionicLoading.hide();
                            }, 750);
                            scope.responseReq()(obj, $index, type);
                        }
                    }
                }
            }
        };
    });

angular.module('chat.directive')
    .directive('searchAutoComplete', function ($parse, $http, $sce, $timeout, $rootScope) {
        return {
            restrict: 'EA',
            scope: {
                "id": "@id",
                "placeholder": "@placeholder",
                "selectCompany": "=selectcompany",
                "selectedObject": "=selectedobject",
                "searchStr": "@searchstr",
                "url": "@url",
                "paramName1": "@paramname",
                "dataField": "@datafield",
                "titleField": "@titlefield",
                "descriptionField": "@descriptionfield",
                "imageField": "@imagefield",
                "imageUri": "@imageuri",
                "inputClass": "@inputclass",
                "userPause": "@pause",
                "localData": "=localdata",
                "searchFields": "@searchfields",
                "minLengthUser": "@minlength",
                "matchClass": "@matchclass"
            },
            templateUrl: 'module/chat/directives/searchautocomplete/searchautocomplete.tpl',
            link: function ($scope, elem, attrs) {
                $scope.lastSearchTerm = null;
                $scope.currentIndex = null;
                $scope.justChanged = false;
                $scope.searchTimer = null;
                $scope.hideTimer = null;
                $scope.searching = false;
                $scope.pause = 500;
                $scope.minLength = 3;
                $scope.searchStr = null;

                if ($scope.minLengthUser && $scope.minLengthUser != "") {
                    $scope.minLength = $scope.minLengthUser;
                }
                if ($scope.userPause) {
                    $scope.pause = $scope.userPause;
                }
                isNewSearchNeeded = function (newTerm, oldTerm) {
                    return newTerm.length >= $scope.minLength && newTerm != oldTerm
                }
                $scope.processResults = function (responseData, str) {
                    if (responseData && responseData.length > 0) {
                        $scope.results = [];
                        var titleFields = [];
                        if ($scope.titleField && $scope.titleField != "") {
                            titleFields = $scope.titleField.split(",");
                        }
                        for (var i = 0; i < responseData.length; i++) {
                            // Get title variables
                            var titleCode = [];
                            for (var t = 0; t < titleFields.length; t++) {
                                titleCode.push(responseData[i][titleFields[t]]);
                            }
                            var description = "";
                            if ($scope.descriptionField) {
                                description = responseData[i][$scope.descriptionField];
                            }
                            var imageUri = "";
                            if ($scope.imageUri) {
                                imageUri = $scope.imageUri;
                            }
                            var image = "";
                            if ($scope.imageField) {
                                image = imageUri + responseData[i][$scope.imageField];
                            }
                            var text = titleCode.join(' ');
                            if ($scope.matchClass) {
                                var re = new RegExp(str, 'i');
                                var strPart = text.match(re)[0];
                                text = $sce.trustAsHtml(text.replace(re, '<span class="' + $scope.matchClass + '">' + strPart + '</span>'));
                            }
                            var resultRow = {
                                title: text,
                                description: description,
                                image: image,
                                originalObject: responseData[i]
                            }
                            $scope.results[$scope.results.length] = resultRow;
                        }
                    } else {
                        $scope.results = [];
                    }
                }

                $scope.searchTimerComplete = function (str) {
                    // Begin the search
                    if (str.length >= $scope.minLength) {
                        if ($scope.localData) {
                            var searchFields = $scope.searchFields.split(",");
                            var matches = [];
                            for (var i = 0; i < $scope.localData.length; i++) {
                                var match = false;
                                for (var s = 0; s < searchFields.length; s++) {
                                    match = match || (typeof $scope.localData[i][searchFields[s]] === 'string' &&
                                        typeof str === 'string' && $scope.localData[i][searchFields[s]].toLowerCase().indexOf(str.toLowerCase()) >= 0);
                                }
                                if (match) {
                                    matches[matches.length] = $scope.localData[i];
                                }
                            }
                            $scope.searching = false;
                            $scope.processResults(matches, str);
                        } else {
                            var paramename = '?' + encodeURIComponent($scope.paramName1) + '=' + encodeURIComponent(str);
                            paramename += '&company=' + encodeURIComponent($scope.selectCompany.title);
                            $http.get($scope.url + paramename, {}).
                                success(function (responseData, status, headers, config) {
                                    $scope.searching = false;
                                    // debugger;
                                    // (($scope.dataField) ? responseData[$scope.dataField] : responseData )
                                    $scope.processResults(responseData, str);
                                }).
                                error(function (data, status, headers, config) {
                                    console.log("error");
                                });
                        }
                    }
                }

                $scope.hideResults = function () {
                    $scope.hideTimer = $timeout(function () {
                        $scope.showDropdown = false;
                    }, $scope.pause);
                };

                $scope.resetHideResults = function () {
                    if ($scope.hideTimer) {
                        $timeout.cancel($scope.hideTimer);
                    };
                };
                $scope.hoverRow = function (index) {
                    $scope.currentIndex = index;
                }
                $scope.keyPressed = function (event) {
                    if (!(event.which == 38 || event.which == 40 || event.which == 13)) {
                        if (!$scope.searchStr || $scope.searchStr == "") {
                            $scope.showDropdown = false;
                            $scope.lastSearchTerm = null
                        } else if (isNewSearchNeeded($scope.searchStr, $scope.lastSearchTerm)) {
                            $scope.lastSearchTerm = $scope.searchStr
                            $scope.showDropdown = true;
                            $scope.currentIndex = -1;
                            $scope.results = [];
                            if ($scope.searchTimer) {
                                $timeout.cancel($scope.searchTimer);
                            }
                            $scope.searching = true;

                            $scope.searchTimer = $timeout(function () {
                                $scope.searchTimerComplete($scope.searchStr);
                            }, $scope.pause);
                        }
                    } else {
                        event.preventDefault();
                    }
                }
                $scope.selectResult = function (result) {
                    if ($scope.matchClass) {
                        result.title = result.title.toString().replace(/(<([^>]+)>)/ig, '');
                    }
                    $scope.searchStr = $scope.lastSearchTerm = result.title;
                    $timeout(function () {
                        $scope.selectedObject.title = result.title;
                        $scope.selectedObject.originalObject = result.originalObject;
                    }, 10);
                    //$rootScope.selectedObject = result;
                    $scope.showDropdown = false;
                    $scope.results = [];
                    //$scope.$apply();
                }

                var inputField = elem.find('input');

                inputField.on('keyup', $scope.keyPressed);
                elem.on("keyup", function (event) {
                    if (event.which === 40) {
                        if ($scope.results && ($scope.currentIndex + 1) < $scope.results.length) {
                            $scope.currentIndex++;
                            $scope.$apply();
                            event.preventDefault;
                            event.stopPropagation();
                        }
                        $scope.$apply();
                    } else if (event.which == 38) {
                        if ($scope.currentIndex >= 1) {
                            $scope.currentIndex--;
                            $scope.$apply();
                            event.preventDefault;
                            event.stopPropagation();
                        }

                    } else if (event.which == 13) {
                        if ($scope.results && $scope.currentIndex >= 0 && $scope.currentIndex < $scope.results.length) {
                            $scope.selectResult($scope.results[$scope.currentIndex]);
                            $scope.$apply();
                            event.preventDefault;
                            event.stopPropagation();
                        } else {
                            $scope.results = [];
                            $scope.$apply();
                            event.preventDefault;
                            event.stopPropagation();
                        }

                    } else if (event.which == 27) {
                        $scope.results = [];
                        $scope.showDropdown = false;
                        $scope.$apply();
                    } else if (event.which == 8) {
                        $scope.selectedObject = null;
                        $scope.$apply();
                    }
                });
            }
        };
    })
/// 字符转码
; angular.module('chat.filter', [])
    .filter('trustHtml', function ($sce) {
        return function (input) {
            return $sce.trustAsHtml(input);
        }
    });

'use strict';
angular.module('chat.route', [])
    .config(['$stateProvider', function ($stateProvider) {
        $stateProvider
            .state('tab.call', {
                cache: false,
                url: '/call/:contactName?isCalling',
                controller: 'CallCtrl',
                templateUrl: 'module/chat/pages/call/call.html'
            })
            .state('tab.chat', {
                url: '/chat',
                views: {
                    'tab-chat': {
                        templateUrl: 'module/chat/tpl/contacts.html',
                        controller: 'contacts'
                    }
                }
            })
            .state('tab.friendInfo', {
                url: '/friendInfo/:targetId/:targetName/:conversationType',
                cache: false,
                views: {
                    'tab-chat': {
                        templateUrl: 'module/chat/pages/friendinfo/friendinfo.html',
                        controller: 'friendInfoCtrl'
                    }
                }
            })
            .state('tab.groupInfo', {
                url: '/groupInfo/:targetId/:targetName/:groupType/:conversationType',
                cache: false,
                views: {
                    'tab-chat': {
                        templateUrl: 'module/chat/pages/groupinfo/groupinfo.html',
                        controller: 'groupInfoCtrl'
                    }
                }
            })
            .state('tab.chatDetail', {
                url: '/chat-detail',
                params: { messageId: null, name: null, targetId: null, conversationType: null },
                views: {
                    'tab-chat': {
                        templateUrl: 'module/chat/pages/chatdetail/chatdetail.html',
                        controller: 'chatDetail'
                    }
                }
            })
            .state('tab.addGroup', {
                url: '/addGroup',
                views: {
                    'tab-chat': {
                        templateUrl: 'module/chat/pages/addgroup/addgroup.html',
                        controller: 'addGroupCtrl'
                    }
                }
            })
            .state('tab.addGroupmember', {
                url: '/addGroupmember',
                params: { GroupID: null },
                views: {
                    'tab-chat': {
                        templateUrl: 'module/chat/pages/addgroupmember/addgroupmember.html',
                        controller: 'addGroupmember'
                    }
                }
            })
            .state('tab.addFriend', {
                url: '/addFriend',
                views: {
                    'tab-chat': {
                        templateUrl: 'module/chat/pages/addfriend/addfriend.html',
                        controller: 'addFriendCtrl'
                    }
                }
            });
    }]);

;
var chats = angular.module('chat.services', []);

// 用户全局引用
chats.factory('initRong', function ($rootScope, $state, RONGYUN_APPKEY) {
    function initRong(token) {
        $rootScope.arrMsgs = new Array();
        $rootScope.arrCons = new Array();
        // 融云初始化
        RongCloudLibPlugin.init({
            appKey: RONGYUN_APPKEY
        },
            function (ret, err) {
                if (ret) {
                    // alert('init:' + JSON.stringify(ret));
                }
                if (err) {
                    alert('init error:' + JSON.stringify(err));
                }
            }
        );
        RongCloudLibPlugin.setConnectionStatusListener(
            function (ret, err) {
                if (ret) {
                    // 只允许单用户登录
                    if (ret.result.connectionStatus == 'KICKED') {
                        alert('您的帐号已在其他端登录!');
                        $rootScope.hideTabs = false;
                        //$ionicHistory.clearCache();
                        $state.go('login');
                    }
                }
                if (err) {
                    alert('setConnectionStatusListener error:' + JSON.stringify(err));
                }
            }
        );
        // 建立连接
        RongCloudLibPlugin.connect({
            token: token
        },
            function (ret, err) {
                if (ret) {
                    $rootScope.$apply();
                }
                if (err) {
                    alert('init error:' + JSON.stringify(err));
                }
            }
        );
        // 消息接收
        RongCloudLibPlugin.setOnReceiveMessageListener(
            function (ret, err) {
                // 接收消息
                if (ret) {
                    $rootScope.arrMsgs.push(JSON.stringify(ret.result.message));
                    $rootScope.$apply();
                }
                if (err) {
                    alert('setOnReceiveMessageListener error:' + JSON.stringify(err));
                }
            }
        );
    }
    return {
        init: initRong
    };
})
    // 好友服务
    .factory('Friends', function (RequestUrl, Signaling, UserService, $interval, LOAD_FRIENDS_URL, HttpPromiseService) {
        var currentUser = UserService.getUserinfo();
        var loaded = false;
        var friends = [];
        var userids = [];
        var curUID = '';
        function getFriends(callback) {
            var params = {
                username: currentUser.username,
            };
            HttpPromiseService.getData(LOAD_FRIENDS_URL, params).then(function (data) {
                console.log(data);
                callback(data.friends);
            });
        }
        function loadData(callback) {
            getFriends(function (retdata) {
                friends = [];
                var dataLen = retdata.length;
                for (var i = 0; i < dataLen; i++) {
                    var obj = {};
                    obj.id = retdata[i]._id;
                    obj.name = retdata[i].nickname == null ? retdata[i].username : retdata[i].nickname;
                    obj.alpha = makePy(obj.name)[0][0].toUpperCase();
                    obj.conversationType = 'PRIVATE';
                    obj.online = '0';
                    obj.Mobile = "212312312222";//测试
                    obj.portrait = retdata[i].headimg ? (RequestUrl + 'Images/Photo/' + retdata[i].headimg) : null;
                    friends.push(obj);
                }
                // 按首字母排序
                friends = friends.sort(function (a, b) {
                    var bool = a.alpha > b.alpha;
                    return bool ? 1 : -1;
                });
                // 删除本人
                var retIndex;
                for (var i = 0; i < friends.length; i++) {
                    if (friends[i].id == curUID) {
                        retIndex = i;
                        break;
                    }
                }
                if (retIndex) {
                    friends.splice(retIndex, 1);
                }
                // 首字母索引位置计算
                var friendCount = friends.length;
                var nowalpha = '';
                var alphaCount = 0;
                for (var m = 0; m < friendCount; m++) {
                    var tmp = friends[m];
                    if (tmp.alpha != nowalpha) {
                        nowalpha = obj.alpha;
                        alphaCount++;
                    }
                    userids.push(tmp.id);
                }
                callback(friends);
                Signaling.emit('checkOnline', userids);
                checkOnlineCallback(callback);
            });
        }
        // 刷新在线列表(10s)
        $interval(function () {
            if (loaded) {
                Signaling.emit('checkOnline', userids);
            }
        }, 10000);
        // 获取在线列表
        function checkOnlineCallback(callback) {
            if (!loaded) {
                loaded = true;
                Signaling.on('checkOnline_suc', function (ids) {
                    var friendlistCount = friends.length;
                    for (var m = 0; m < friendlistCount; m++) {
                        var tmp = friends[m];
                        for (var n = 0; n < ids.length; n++) {
                            if (tmp.id == ids[n].id) {
                                friends[m].online = "1";
                            }
                        }
                    }
                    if (callback) {
                        callback(friends);
                    }
                });
            }
        }

        return {
            // 获取好友列表
            all: function (callback) {
                //return;
                if (friends.length > 0) {
                    callback(friends);
                } else {
                    loadData(callback);
                    $interval(function () {
                        loadData(callback);
                    }, 20000);
                }
            },
            // 获取单个好友
            get: function (friendId) {
                var retIndex = -1;
                for (var i = 0; i < friends.length; i++) {
                    if (friends[i].id == friendId) {
                        retIndex = i;
                        break;
                    }
                }
                return retIndex > -1 ? friends[retIndex] : null;
            },
            //（未启用）
            set: function (val) {
                friends = val;
            },
            //（未启用）
            add: function (friend) { }
        }
    })
    // 搜多用户添加好友
    .factory('SearchUsers', function (UserService, $interval, SEARCH_FRIENDS_URL, HttpPromiseService) {
        return {
            load: function (str) {
                var params = {
                    username: str
                }
                return HttpPromiseService.getData(SEARCH_FRIENDS_URL, params).then(function (data) {
                    return data;
                });
            }
        }
    })
    // 群组服务
    .factory('Groups', function (Signaling, UserService, $rootScope,
        $interval, LOAD_GROUPS_URL, HttpPromiseService) {
        var groups = [];
        var curUID = '';
        var currentUser = UserService.getUserinfo();
        // 后台请求数据
        function loadData(callback) {
            var params = {
                username: currentUser.username,
            };
            HttpPromiseService.getData(LOAD_GROUPS_URL, params).then(function (grouplist) {
                console.log(grouplist);
                groups = [];
                for (var i = 0; i < grouplist.length; i++) {
                    var group = {};
                    group.id = grouplist[i]._id;
                    group.name = grouplist[i].groupname;
                    group.number = 12;
                    group.max_number = 13;
                    group.conversationType = 'GROUP';
                    group.type = 'create';
                    group.members = grouplist[i].members;
                    groups.push(group);
                }
                callback(groups)
            });
        }

        return {
            all: function (callback) {
                if (groups.length > 0) {
                    callback(groups);
                } else {
                    loadData(callback);
                    $interval(function () {
                        loadData(callback);
                    }, 10000);
                    $rootScope.$on("change Project", function (evt, PCode, PName) {
                        loadData(callback);
                    });
                }
            },
            set: function (val) {
                groups = val;
            },
            get: function (groupId) {
                var retIndex = -1;
                for (var i = 0; i < groups.length; i++) {
                    if (groups[i].id == groupId) {
                        retIndex = i;
                        break;
                    }
                }
                return retIndex > -1 ? groups[retIndex] : null;
            },
            // 获取组内成员
            getGroupMembers: function (groupId, cb) {
                var retIndex = -1;
                for (var i = 0; i < groups.length; i++) {
                    if (groupId == groups[i].id) {
                        return cb(groups[i].members);
                    }
                }
                return [];
            }
        }
    })
    // 创建组
    .factory('CreateGroups', function (UserService, HttpPromiseService, CREATE_GROUP_URL) { // 成功
        var currentUser = UserService.getUserinfo();
        return {
            create: function (group) {
                var params = {
                    userid: currentUser._id,
                    groupname: group.name,
                    groupimg: '',
                    members: group.member
                };
                return HttpPromiseService.getData(CREATE_GROUP_URL, params);
            }
        }
    })
    // 发送加好友请求
    .factory('AddFriendRequest', function (UserService, HttpPromiseService, REQ_FRIEND_URL) { // 成功
        var currentUser = UserService.getUserinfo();
        return {
            init: function (friendid, cb) {
                var params = {
                    userid: currentUser._id,
                    friendid: friendid
                };
                HttpPromiseService.getData(REQ_FRIEND_URL, params).then(function (data) {
                    cb(data);
                });
            }
        }
    })
    // 发送入群请求
    .factory('AddGroupRequest', function (UserService, HttpPromiseService, REQ_GROUP_MEMBER_URL) { // 成功
        return {
            init: function (friendid, groupid, cb) {
                var currentUser = UserService.getUserinfo();
                var params = {
                    userid: currentUser._id,
                    friendid: friendid,
                    groupid: groupid
                };
                HttpPromiseService.getData(REQ_GROUP_MEMBER_URL, params).then(function (data) {
                    console.log(data);
                    cb(data);
                });
            }
        }
    })
    // 加载好友请求
    .service("FindFriendsReq", function ($http, httpXhr, $interval, UserService, HttpPromiseService, LOAD_FRIEND_REQUEST_URL) {
        var friendRquestList = [];
        var intervalid = 0;
        var currentUser = UserService.getUserinfo();
        function FindFriendsReq(callback) {
            var params = {
                username: currentUser.username,
            };
            HttpPromiseService.getData(LOAD_FRIEND_REQUEST_URL, params).then(function (res_friendlist) {
                friendRquestList = [];
                for (var i = 0; i < res_friendlist.length; i++) {
                    var reqfrom = res_friendlist[i].from;
                    console.log(res_friendlist);
                    var friendRquest = {};
                    friendRquest.id = reqfrom._id;
                    friendRquest.name = reqfrom.nickname;
                    friendRquest.info = "[" + reqfrom.nickname + "]" + "请求添加您为好友！";
                    friendRquest.portrait = reqfrom.headimg;
                    friendRquest.type = "PRIVATE";
                    friendRquestList.push(friendRquest);
                }
                callback(friendRquestList);
            });
        }

        var friendsReqApi = {
            all: function (userid, callback) {
                if (friendRquestList.length > 0) {
                    callback(friendRquestList);
                } else {
                    FindFriendsReq(userid, callback);
                    clearInterval(intervalid);
                    intervalid = $interval(function () {
                        FindFriendsReq(userid, callback);
                    }, 20000);
                }
            }
        };
        return friendsReqApi;
    })
    // 加载团队请求
    .service("findTeamsReq", function ($http, httpXhr, $interval, UserService, HttpPromiseService, LOAD_GROUP_REQUEST_URL) {
        var teamRquestList = [];
        var intervalid = 0;
        var currentUser = UserService.getUserinfo();
        function findTeamsReq(callback) {
            var params = {
                username: currentUser.username
            };
            HttpPromiseService.getData(LOAD_GROUP_REQUEST_URL, params).then(function (data) {
                console.log(data);
                teamRquestList = [];
                var dataLen = data.length;
                for (var i = 0; i < dataLen; i++) {
                    var groupRquest = {};
                    var tempdata = data[i];
                    groupRquest.id = tempdata.groupid._id;
                    groupRquest.name = tempdata.groupid.groupname;
                    groupRquest.info = (tempdata.from.nickname == null ? "(无名)" : tempdata.from.nickname) + "邀您加入群:" + "[" + tempdata.groupid.groupname + "]";
                    groupRquest.portrait = null;
                    groupRquest.type = "GROUP";
                    teamRquestList.push(groupRquest);
                }
                callback(teamRquestList);
            });
        }
        var teamsReqApi = {
            all: function (userid, callback) {
                if (teamRquestList.length > 0) {
                    callback(teamRquestList);
                } else {
                    findTeamsReq(userid, callback);
                    clearInterval(intervalid);
                    intervalid = $interval(function () {
                        findTeamsReq(userid, callback);
                    }, 10000);
                }
            }
        };
        return teamsReqApi;
    })
    // 好友请求服务
    .service("ResFriend", function ($http, httpXhr, $timeout, UserService, HttpPromiseService, RES_FRIEND_REQUEST) {
        // UserID 自己
        // FriendID:接收人
        // state{0：发邀请，1:接受，-1：拒绝}
        var currentUser = UserService.getUserinfo();
        function ResFriend(FriendID, state, callback) {
            var params = {
                userid: currentUser._id,
                friendid: FriendID,
                state: state
            };
            HttpPromiseService.getData(RES_FRIEND_REQUEST, params).then(function (data) {
                console.log(data);
                callback(data);
            });
        }
        return ResFriend;
    })
    // 群组请求服务
    .service("ResTeam", function ($http, httpXhr, $timeout, HttpPromiseService, RES_GROUP_REQUEST) {
        // groupID 群组名称
        // FriendID:发起请求的人
        // MemberID:自己
        // state{0：发邀请，1:接受，-1：拒绝}
        function ResTeam(groupID, FriendID, MemberID, state, callback) {
            var obj = { groupID: groupID.substr(4), MemberID: MemberID, state: state };
            var params = {
                userid: MemberID,
                friendid: FriendID,
                groupid: groupID,
                state: state
            };
            HttpPromiseService.getData(RES_GROUP_REQUEST, params).then(function (data) {
                debugger;
                console.log(data);
                callback(data);
            });
        }
        return ResTeam;
    })

    // 协同全局未读消息计算
    .service("chatUnreadMessage", function ($rootScope) {
        var messages = 0;
        var chatUnreadMessageservive = {
            getUnreadMessage: function () {
                return messages;
            },
            setUnreadMessage: function (val) {
                messages = val;
                $rootScope.chatUnreadMessageNum = val;
                return;
            },
            addUnreadMessage: function (val) {
                messages += val;
                $rootScope.chatUnreadMessageNum = messages;
                return;
            }
        }
        return chatUnreadMessageservive;
    })
    // 全局消息监听
    .service("newMessageEventService", function ($rootScope) {
        var msgService = {
            broadcast: function (data) {
                $rootScope.$broadcast("newMsg", data);
            },
            listen: function (callback) {
                $rootScope.$on("newMsg", callback);
            }
        };
        return msgService;
    })
    // 未读消息模拟（For PC）
    .service("unreadMessages", function ($http, $rootScope, $timeout) {
        var unreadMessages = [
            { unreadMessageCount: 2, latestMessage: 'ficl upi' },
        ];
        var util = {
            getUnreadList: function () {
                var arr = [{
                    targetId: 11,
                    senderUserId: 1,
                    sentTime: '2016-06-01 10:00',
                    unreadMessageCount: 2,
                    latestMessage: 'i am bat11!',
                    conversationType: 'PRIVATE',
                    conversationTitle: '陌生人'
                }, {
                    targetId: 12,
                    senderUserId: 1,
                    sentTime: '2016-06-01 10:00',
                    unreadMessageCount: 2,
                    latestMessage: 'i am bat12!',
                    conversationType: 'PRIVATE',
                    conversationTitle: '陌生人'
                }, {
                    targetId: 14,
                    senderUserId: 1,
                    sentTime: '2016-06-01 10:00',
                    unreadMessageCount: 2,
                    latestMessage: 'i am bat14!',
                    conversationType: 'PRIVATE',
                    conversationTitle: '陌生人'
                }, {
                    targetId: 13,
                    senderUserId: 1,
                    sentTime: '2016-06-01 10:00',
                    unreadMessageCount: 2,
                    latestMessage: 'i am bat13!',
                    conversationType: 'PRIVATE',
                    conversationTitle: '陌生人'
                }, {
                    targetId: 16,
                    senderUserId: 1,
                    sentTime: '2016-06-01 10:00',
                    unreadMessageCount: 2,
                    latestMessage: 'i am bat!12',
                    conversationType: 'PRIVATE',
                    conversationTitle: '陌生人'
                },];
                // 模拟新消息
                $timeout(function () {
                    $rootScope.$broadcast("newMsg",
                        '{"targetId": 11, "senderUserId": 1, "sentTime":"2016-06-01 10:00", '
                        + '"content": {"text":"new message"}, "conversationType": "PRIVATE", "objectName": "RC:TxtMsg"}');
                }, 4000);
                return arr;
            },
        }
        return util;
    })
    // 黑名单服务
    .factory('Blacklist', function () {
        var lists = [
            { id: 'group1', username: 'group1', portrait: 'img/personPhoto.png' },
        ];
        return {
            all: function () {
                return lists;
            },
            set: function (val) {
                lists = val;
            },
            addOne: function (val) {
                lists.push(val);
            },
            removeOne: function (val) {
                for (var i = 0; i < lists.length; i++) {
                    if (lists[i].id == val) {
                        lists.splice(i, 1);
                        break;
                    }
                }
            },
            get: function (id) {
                // Simple index lookup
                var retIndex = -1;
                for (var i = 0; i < lists.length; i++) {
                    if (lists[i].id == id) {
                        retIndex = i;
                        break;
                    }
                }
                return retIndex > -1 ? lists[retIndex] : null;
            }
        }
    })
    // 格式化融云错误
    .factory('FormateRongyunErr', function (myNote) {
        return {
            formate: function (err) {
                var errcode = 1;
                if (err && err.code) {
                    errcode = err.code;
                } else if (err && err.result) {
                    errcode = err.result.code;
                }
                switch (errcode) {
                    case 30001:
                        myNote.myNotice('网络出现问题，请检查网络! 30001');
                        break;
                    case -10000:
                        myNote.myNotice('网络出现问题，请检查网络!-10000');
                        break;
                    case -1:
                        myNote.myNotice('初始化失败！重启试试？! -1');
                        break;
                    default:
                        break;
                }
            }
        }
    })
    // 融云服务
    .factory('rongyunService', function ($q, FormateRongyunErr) {
        return {
            /**
             * 获取历史数据
             */
            getConversationList: function (targetid, ctype) {
                var oldestMessageId = 0;
                var promise = $q.defer();
                RongCloudLibPlugin.getConversationList(
                    function (ret, err) {
                        if (ret) {
                            promise.resolve(ret);
                        }
                        if (err) {
                            FormateRongyunErr.formate(err);
                        }
                    }
                );
            },
            getHistoryMsg: function (targetid, ctype) {
                var oldestMessageId = 0;
                var promise = $q.defer();
                RongCloudLibPlugin.getHistoryMessages({
                    conversationType: ctype,
                    targetId: targetid,
                    count: 5,
                    oldestMessageId: oldestMessageId
                },
                    function (ret, err) {
                        if (ret) {
                            var result = new Array(),
                                tmp;
                            for (var i = ret.result.length - 1; i >= 0; i--) {
                                tmp = ret.result[i];
                                tmp = myUtil.resolveMsg(tmp);
                                result.push(tmp);
                            }
                            var hisArr = result.concat($scope.hisMsgs);
                            promise.resolve(hisArr);

                        }
                        if (err) {
                            alert("getHistoryMessages error: " + JSON.stringify(err));
                        }
                    }
                );
            },
            sendMessage: function (ctype, target, content) {
                var promise = $q.defer();
                RongCloudLibPlugin.sendTextMessage({
                    conversationType: ctype,
                    targetId: target,
                    text: content,
                    extra: "extra text"
                },
                    function (ret, err) {
                        if (ret) {
                            //消息此时未发送成功，可以加入样式标明
                            if (ret.status == "prepare") {
                                // alert('你发了文字消息：' +JSON.stringify(ret));
                                promise.resolve(ret.result.message);
                            }
                            //成功后更新样式
                            if (ret.status == "success") {
                                // alert("success");
                            }
                        }
                        if (err) {
                            alert("发送文本消息 error: " + JSON.stringify(err));
                        }
                    }
                );
            },
            clearMessagesUnreadStatus: function (conversationType, targetId) {
                var promise = $q.defer();
                RongCloudLibPlugin.clearMessagesUnreadStatus({
                    conversationType: conversationType,
                    targetId: targetId
                },
                    function (ret, err) {
                        promise.resolve(ret);
                        if (err) {
                            alert("标为已读 error: " + JSON.stringify(err));
                        }
                    }
                );
            },
            getLatestMsg: function (targetid, ctype) {
                var promise = $q.defer();
                RongCloudLibPlugin.getLatestMessages({
                    conversationType: ctype,
                    targetId: targetid,
                    count: 15
                },
                    function (ret, err) {
                        //alert("getLatestMessages ret:" + JSON.stringify(ret));
                        if (ret) {
                            var result = [];
                            var tmp;
                            for (var i = ret.result.length - 1; i >= 0; i--) {
                                tmp = ret.result[i];
                                if (ctype == "GROUP" && members.length > 0) {
                                    for (var m = 0; m < members.length; m++) {
                                        if (members[m].id == tmp.senderUserId) {
                                            tmp.name = members[m].name;
                                        }
                                    }
                                }
                                tmp = myUtil.resolveMsg(tmp);
                                // 处理IOS倒序顺序bug
                                if (isIOS) {
                                    result.push(tmp);
                                } else {
                                    result.unshift(tmp);
                                }
                            }
                            promise.resolve(result);
                        }
                        if (err) {
                            alert("getLatestMessages error: " + JSON.stringify(err));
                        }
                    }
                );
            },
            sendImageMessage: function (ctype, targetId, imageURI) {
                var isIOS = ionic.Platform.isIOS();
                var isAndroid = ionic.Platform.isAndroid();
                var picPath = imageURI;
                if (isIOS) {
                    picPath = imageURI.replace('file://', '');
                }
                if (isAndroid) {
                    if (imageURI.indexOf('?') !== -1) {
                        picPath = imageURI.substring(0, imageURI.indexOf('?'));
                    } else { }
                }
                var promise = $q.defer();
                RongCloudLibPlugin.sendImageMessage({
                    conversationType: ctype,
                    targetId: targetId,
                    imagePath: picPath,
                    extra: ""
                },
                    function (ret, err) {
                        if (ret) {
                            //消息此时未发送成功，可以加入样式标明；成功后更新样式
                            if (ret.status == "prepare") {
                                // alert("prepare");
                                promise.resolve(ret.result.message);

                            }
                            if (ret.status == "success") {
                                //alert("success");
                            }
                        }
                        if (err) {
                            alert("sendImageMessage error: " + JSON.stringify(err));
                        }
                    }
                );
            },
            sendVoiceMessage: function (ctype, targetId, tmpPath, dur) {
                var promise = $q.defer();
                // 发送语音消息
                RongCloudLibPlugin.sendVoiceMessage({
                    conversationType: ctype,
                    targetId: targetId,
                    voicePath: tmpPath,
                    duration: dur,
                    extra: ""
                },
                    function (ret, err) {
                        if (ret) {
                            $scope.lstResult = "sendVoiceMessage:" + JSON.stringify(ret);
                            // TODO:消息此时未发送成功，可以加入样式标明；成功后更新样式
                            if (ret.status == "prepare") {
                                // alert("sendVoiceMessage prepare2:" + JSON.stringify(ret));
                                promise.resolve(data);
                            }
                            // TODO:后续加入发送成功后修改显示样式
                            if (ret.status == "success") {
                                // alert("success");
                            }
                        }
                        if (err) { // TODO:这里需要对错误状态进行判断并友好的提示用户
                            alert("语音消息输入过短! ");
                            //alert("语音消息发送错误: " + JSON.stringify(err));
                        }
                    }
                );
            },
            clearConversition: function (ctype, targetId, tmpPath, dur) {
                var promise = $q.defer();
                RongCloudLibPlugin.clearConversations({
                    conversationTypes: ["PRIVATE", "GROUP"]
                },
                    function (ret, err) {
                        if (ret) {
                            alert("已清除所有会话: " + result.status);
                            promise.resolve();
                        }
                        if (err) {
                            FormateRongyunErr.formate(err);
                        }
                    }
                );
            },
            clearMessagesUnreadStatus: function (targetid, ctype) {
                var promise = $q.defer();
                RongCloudLibPlugin.clearMessagesUnreadStatus({
                    conversationType: type,
                    targetId: targetId
                }, function (ret, err) {
                    // test succeed
                    promise.resolve();
                    if (err) {
                        FormateRongyunErr.formate(err);
                    }
                });
            },
            removeConversation: function (targetid, ctype) {
                var promise = $q.defer();
                RongCloudLibPlugin.removeConversation({
                    conversationType: type,
                    targetId: targetId
                }, function (ret, err) {
                    promise.resolve();
                    //alert(ret.status);
                    if (err) {
                        FormateRongyunErr.formate(err);
                    }
                });
            }
        }
    })
    // 媒体服务(音频)
    .factory('mediaService', function () {
        var isIOS = ionic.Platform.isIOS();
        var isAndroid = ionic.Platform.isAndroid();
        var mediaRec;
        var path = "";
        var src = "cordovaIMVoice.amr";
        if (window.cordova && isIOS) {
            path = cordova.file.documentsDirectory;
            src = "cordovaIMVoice.wav";
        } else if (window.cordova) {
            path = cordova.file.externalApplicationStorageDirectory;
        }
        function getMediaURL(s) {
            if (device.platform.toLowerCase() === "android") return path + s;
            return (path + s).replace('file://', '');
        }
        function getNewMediaURL(s) {
            if (device.platform.toLowerCase() === "android") return path + s;
            return "documents://" + s;
        }
        function getPhoneGapPath() {
            // bug
            var path = window.location.pathname;
            path = path.substr(path, path.length - 9);
            if (isIOS) {
                return 'img/vedio-chat.mp3';
            } else {
                //alert('file://' + path + 'img/vedio-chat.mp3');//路径有问题
                return 'file://' + path + 'img/vedio-chat.mp3';
            }
        };
        return {
            playSound: function () {
                //实例化录音类, src:需要播放的录音的路径
                var ring = new Media(getPhoneGapPath(),
                    function () {
                    }, function (err) {
                    }
                );
                //开始播放录音
                ring.play();
            },
            startRecord: function () {
                if (mediaRec) {
                    mediaRec.release();
                }
                //实例化录音类
                mediaRec = new Media(getNewMediaURL(src),
                    function () { },
                    function (err) { }
                );
                //开始录音
                mediaRec.startRecord();
            },
            finishRecord: function () {
                var promise = $q.defer();
                if (mediaRec) {
                    mediaRec.stopRecord();
                    mediaRec.release();
                }
                //实例化录音类, src:需要播放的录音的路径
                mediaRec = new Media(getMediaURL(src),
                    function () {
                        console.log("touchend():Audio Success");
                    },
                    function (err) {
                        console.log("touchend():Audio Error: " + err.code);
                    }
                );
                mediaRec.play();
                mediaRec.stop();

                //在html中显示当前状态
                var counter = 0;
                var timerDur = setInterval(function () {
                    counter = counter + 100;
                    if (counter > 2000) {
                        clearInterval(timerDur);
                    }
                    var dur = mediaRec.getDuration();
                    if (dur > 0) {
                        clearInterval(timerDur);
                        // alert('mediaRec.getDuration():' + dur);
                        // alert('mediaRec.src:' + mediaRec.src);
                        var tmpPath = mediaRec.src;
                        if (isIOS) {
                            tmpPath = path + src;
                        }
                        tmpPath = tmpPath.replace('file://', '');
                        promise.resolve(tmpPath, mediaRec);
                    }
                }, 100);
            }
        }
    })
    // phonertc服务
    .factory('phoneRTCService', function () {
        return {
            createSession: function (isInitiator) {
                if (isInitiator) {
                    sendMessage('[发起视频通话]');
                }
                console.log(new Date().toString() + ': calling to ' +
                    contactName + ', isInitiator: ' + isInitiator);
                // 自个部署的服务器turn server
                var config = {
                    isInitiator: isInitiator,
                    stun: {
                        host: 'stun:115.29.51.196'
                    },
                    turn: {
                        host: 'turn:115.29.51.196',
                        username: 'test',
                        password: 'test'
                    },
                    streams: {
                        audio: true, // 支持音频
                        video: true, // 支持视频
                    }
                };

                var session = new cordova.plugins.phonertc.Session(config);
            }
        }
    });

angular.module('chat.controllers', [])

    /**聊天界面 */
    .controller('contacts', function ($scope, $state,
        $ionicScrollDelegate, $timeout, $interval, Friends, Groups, $rootScope,
        newMessageEventService, FindFriendsReq, findTeamsReq, rongyunService,
        unreadMessages, chatUnreadMessage,Signaling) {
        Signaling.emit('login', 'cc', 'cc', 'cc');
        // 标记在线
        Signaling.on('login_successful', function (info) {
            console.log('i am here!');
        });
        $scope.data = {
            searchword: ''
        };
        $scope.clearKeyword = function (data) {
            data.scorearchword = '';
        }
        // === tab切换[消息/联系人] ===
        if (!$scope.currentFeedsType) {
            $scope.currentFeedsType = "contacttab";
        }
        $scope.messagetab = "messagetab";
        $scope.contacttab = "contacttab";
        var scrollPositonRec = { 'top': 0, 'left': 0 };
        var scrollPositonJob = { 'top': 0, 'left': 0 };
        $scope.tabswitch = function (feedsType) {
            if ($scope.currentFeedsType == "messagetab") {
                scrollPositonRec = $ionicScrollDelegate.getScrollPosition();
            } else if ($scope.currentFeedsType == "contacttab") {
                scrollPositonJob = $ionicScrollDelegate.getScrollPosition();
            }

            if (feedsType == "messagetab") {
                $ionicScrollDelegate.scrollTo(scrollPositonRec.left, scrollPositonRec.top);
            } else if (feedsType == "contacttab") {
                $ionicScrollDelegate.scrollTo(scrollPositonJob.left, scrollPositonJob.top);
            }

            $scope.currentFeedsType = feedsType;
        }

        $scope.groups = [];
        $scope.friends_list = [];
        $scope.friends_message = [];
        // 好友/团队邀请
        $scope.friendinviteList = [];
        $scope.groupinviteList = [];
        // 加载好友列表
        $scope.navCharArray = [];
        Friends.all(function (data) {
            $scope.friends_list = data;
            var alphaArr = [];
            var alpha_now = '';
            for (var i = 0; i < data.length; i++) {
                if (alpha_now != data[i].alpha) {
                    alphaArr.push({
                        firstChar: data[i].alpha,
                        id: data[i].id
                    });
                    alpha_now = data[i].alpha;
                }
            }
            $scope.navCharArray = alphaArr;
        });
        // 加载群组
        Groups.all(function (data) {
            $scope.groups = data;
        });
        // 加载好友邀请
        FindFriendsReq.all(function (data) {
            $scope.friendinviteList = data;
        });

        $scope.navCallBack = function () { }

        // 加载群组邀请
        findTeamsReq.all(function (data) {
            $scope.groupinviteList = data;
        });
        // 同意与拒绝请求,成功后删掉记录并刷新好友列表
        function responseReq(obj, $index, type) {
            if (type == "PRIVATE") {
                $scope.friends_list.unshift(obj);
                $timeout(function () {
                    $scope.friendinviteList.splice($index, 1);
                }, 400);
            } else {
                $scope.groups.unshift(obj);
                $timeout(function () {
                    $scope.groupinviteList.splice($index, 1);
                }, 400);
            }
        }
        // 添加团队与添加好友
        $scope.addGroup = function () {
            $state.go('tab.addGroup');
        };
        $scope.addFriend = function () {
            $state.go('tab.addFriend');
        };

        // === 融云消息监听 ===
        var newMsgCallBack = function (d, data) {
            jsonMsg = JSON.parse(data);
            jsonMsg.unreadMessageCount = "1";
            var target;
            var groupMemberinfo = null;
            if (jsonMsg.conversationType == "PRIVATE") {
                var friends = $scope.friends_list;
                var friend_nums = friends.length;
                for (var i = 0; i < friend_nums; i++) {
                    if (friends[i].id == jsonMsg.targetId) {
                        target = friends[i];
                        break;
                    }
                }
            } else if (jsonMsg.conversationType == "GROUP") {
                var groups = $scope.groups;
                var groups_nums = groups.length;
                for (var i = 0; i < groups_nums; i++) {
                    if (groups[i].id == jsonMsg.targetId) {
                        target = groups[i];
                        groupMemberinfo = Groups.getGroupMember(jsonMsg.targetId, jsonMsg.senderUserId);
                        break;
                    }
                }
            }
            jsonMsg = myUtil.resolveCon(jsonMsg, 1, target, groupMemberinfo);
            var friends_message = $scope.friends_message;
            var friendLen = friends_message.length;
            for (var i = 0; i < friendLen; i++) {
                if (friends_message[i].targetId == jsonMsg.targetId) {
                    $scope.friends_message[i].unreadMessageCount = $scope.friends_message[i].unreadMessageCount + 1;
                    $scope.friends_message[i].latestMessage = jsonMsg.latestMessage;
                    return;
                }
            }
            // alert('NEW MEG push now');
            $scope.friends_message.push(jsonMsg);
        }
        newMessageEventService.listen(newMsgCallBack);
        // 清除所有会话
        $scope.clearConversition = function () {
            rongyunService.clearConversations().then(function () {
                $scope.$apply(function () {
                    $scope.friends_message = [];
                });
            });
        }
        // 将某人消息设为已读
        function clearSomeoneConversition(targetId, type) {
            rongyunService.clearMessagesUnreadStatus(targetId, type).then(function () { });
        }
        // 将某人消息删除
        function removeSomeoneConversition(targetId, type) {
            rongyunService.removeConversation(targetId, type).then(function () { });
        }

        // 是否已存在消息
        function findInFriends(val) {
            var friends_message = $scope.friends_message;
            var friendLen = friends_message.length;
            for (var i = 0; i < friendLen; i++) {
                if (friends_message[i].targetId == val) {
                    return i;
                }
            }
            return -1;
        }

        // 设为已读
        $scope.markMessage = function (index) {
            var message = $scope.friends_message[index];
            chatUnreadMessage.addUnreadMessage(-message.unreadMessageCount);
            message.unreadMessageCount = 0;
            clearSomeoneConversition(message.targetId, message.conversationType);
        };
        // 删除消息
        // TODO：需要清除消息状态，否则刷新后会再出来(待测)
        $scope.deleteMessage = function (index) {
            var message = $scope.friends_message[index];
            chatUnreadMessage.addUnreadMessage(-message.unreadMessageCount);
            $scope.friends_message.splice(index, 1);
            removeSomeoneConversition(message.targetId, message.conversationType);
        };

        $scope.gotoChatDetils = function (friend, $index) {
            // 清空未读消息
            $scope.friends_message[$index].unreadMessageCount = 0;
            var target;
            if (friend.conversationType == "PRIVATE") {
                var friends = $scope.friends_list;
                var friend_nums = friends.length;
                for (var i = 0; i < friend_nums; i++) {
                    if (friends[i].id == friend.targetId) {
                        target = friends[i];
                        break;
                    }
                }
            } else if (friend.conversationType == "GROUP") {
                var groups = $scope.groups;
                var groups_nums = groups.length;
                for (var i = 0; i < groups_nums; i++) {
                    if (groups[i].id == friend.targetId) {
                        target = groups[i];
                        break;
                    }
                }
            }
            // 转到聊天主界面
            var name = target ? target.name : '[陌生人]';
            $state.go("tab.chatDetail", { targetId: friend.targetId, name: name, conversationType: friend.conversationType });
        }
        // 获取消息列表
        var getConversationList = function () {
            rongyunService.getConversationList().then(function (result) {
                var resultLen = result.length;
                var target;
                var groupMemberinfo = null;
                for (var i = 0; i < resultLen; i++) {
                    if (result[i].conversationType == "PRIVATE") {
                        target = Friends.get(result[i].targetId);
                    } else if (result[i].conversationType == "GROUP") {
                        target = Groups.get(result[i].targetId);
                        try {
                            groupMemberinfo = Groups.getGroupMember(result[i].targetId, result[i].senderUserId);
                        } catch (e) {
                            alert('groupMemberinfo err:' + JSON.stringify(e));
                            break;
                        }
                    }
                    result[i] = myUtil.resolveCon(result[i], 0, target, groupMemberinfo);
                }
                var messageLen = 0;
                for (var j = 0; j < resultLen; j++) {
                    var index = findInFriends(result[j].targetId);
                    if (index == -1) {
                        $scope.friends_message.push(result[j]);
                        messageLen += result[j].unreadMessageCount;
                    } else {
                        $scope.friends_message[index].unreadMessageCount = result[j].unreadMessageCount;
                        $scope.friends_message[index].latestMessage = result[j].latestMessage;
                        messageLen += result[j].unreadMessageCount;
                    }
                }
                chatUnreadMessage.setUnreadMessage(messageLen);
            });
        }
        // 融云初始化
        var init = function () {
            $scope.friends_message = [];
            // TODO:立即加载在信息联系人未加载完成的情况下失效
            // getConversationList();
            $interval(function () {
                getConversationList();
            }, 3000);
        }

        //init();

        initTest();
        function initTest() {
            $scope.friends_message = [];
            var messageLen = 0;
            $interval(function () {
                var ms = unreadMessages.getUnreadList();
                ms = myUtil.resolveCon(ms, 0, null);
                var msLen = ms.length;
                messageLen = 0;
                for (var j = 0; j < msLen; j++) {
                    var index = findInFriends(ms[j].targetId);
                    if (index == -1) {
                        messageLen += ms[j].unreadMessageCount;
                        $scope.friends_message.push(ms[j]);
                    } else {
                        $scope.friends_message[index].unreadMessageCount = ms[j].unreadMessageCount;
                        messageLen += ms[j].unreadMessageCount;
                        $scope.friends_message[index].latestMessage = ms[j].latestMessage;
                    }
                }
                chatUnreadMessage.setUnreadMessage(messageLen);
            }, 10000);
        }
    });

angular.module('chat.controllers')
    .controller('addFriendCtrl', function ($scope, SearchUsers, AddFriendRequest) {
        $scope.friendResults = [];
        $scope.username = '';

        /**
         * 监测搜索名称
         */
        $scope.$watch('username', function (newValue, oldValue) {
            if (newValue != "" && newValue != oldValue) {
                search(newValue);
            }
        });

        /*
        * 清空输入
        */
        $scope.searchClear = function () {
            $scope.username = '';
            $scope.friendResults = [];
        }
        function search(name) {
            SearchUsers.load(name).then(function (data) {
                var ret = [];
                for (var i = 0; i < data.length; i++) {
                    ret.push({
                        nickname: data[i].nickname,
                        _id: data[i]._id
                    });
                }
                $scope.friendResults = ret;
            });
        };

        /*
        * 发起添加好友请求
        */
        $scope.add = function (FriendID) {
          
            //AddFriendRequest(FriendID,function(data){});
        };
    });
angular.module('chat.controllers')
    .controller('addGroupCtrl', function ($scope, $ionicPopup, HttpFactory,
        $ionicHistory, $cordovaContacts, myNote, $timeout, Friends, CreateGroups) {
        $scope.group = {};
        var myPopup = $ionicPopup.show({
            template: '<input type="text" ng-model="group.name">',
            title: '输入组名：',
            scope: $scope,
            buttons: [{
                text: '取消',
                onTap: function (e) {
                    $ionicHistory.goBack(-1);
                }
            }, {
                text: '<b>保存</b>',
                type: 'button-positive',
                onTap: function (e) {
                    if (!$scope.group.name) {
                        myNote.myNotice('组名不能为空！', 3000);
                        e.preventDefault();
                    }
                }
            }
            ]
        });
        myPopup.then(function () {
            myPopup.close();
        });
        Friends.all(function (friends) {
            for (var i = 0; i < friends.length; i++) {
                friends[i].checked = false;
            }

            $scope.friends = friends;
        });

        $scope.sure = function () {
            console.log("$scope.friends:", $scope.friends);
            $scope.group.member = [];
            angular.forEach($scope.friends, function (data) {
                if (!!data.checked) {
                    $scope.group.member.push(data.id);
                }
            });
            creategroup($scope.group);
        };

        function creategroup(team) {
            CreateGroups.create(team).then(function (data) {
                console.log(data);
                if(data.state == -1){
                    alert("创建失败！");
                }else if(data.state = 1){
                    alert("创建成功！");
                }
                $ionicHistory.goBack(-1);
            });
        }

        /**
         * 从通讯录中获取好友 (TODO)
         */
        $scope.getAllContacts = function () {
            var options = {};
            options.multiple = true;
            $cordovaContacts.find(options).then(function (allContacts) {
                // omitting parameter to .find() causes all contacts to be returned
                $scope.contacts = allContacts;
                alert(angular.toJson($scope.contacts[0]));
            }, function (err) {
                alert(err);
            });
        };
    });
angular.module('chat.controllers')
    .controller('chatDetail', function ($scope, $rootScope, $stateParams, newMessageEventService, CacheFactory,
        $ionicScrollDelegate, $timeout, $state, Friends, Groups, $interval, $ionicModal, PhotoAndImages,
        rongyunService, mediaService) {
        var viewScroll = $ionicScrollDelegate.$getByHandle('messageDetailsScroll');
        /***
         * bugfix purpose
         */
        $scope.fixReflowtag = false;
        var targetId = $stateParams.targetId;
        var conversationType = $stateParams.conversationType;
        $scope.name = $stateParams.name ? $stateParams.name : "";
        $scope.conversationType = conversationType;
        // 加载成员，用于显示姓名
        if ($scope.conversationType == "GROUP") {
            getGroupMem();
        }
        var members = [];
        function getGroupMem() {
            if (targetId && targetId.substr(0, 4) == "cre_") {
                getGroupMembers(targetId.substr(4), callback);
            }
            function callback(data) {
                var data = data.data;
                var length = data.length;
                for(var i = 0; i < length; i++) {
                    var obj = {};
                    obj.id = data[i].UserID;
                    obj.name = data[i].UserName;
                    members.push(obj);
                }
                getLatestMsg(targetId, "GROUP");
            }
        }

        // 语音消息交互(BEGIN)
        $scope.recordWait = false;
        $scope.isStartRecord = false;
        $scope.onVoiceHold = function () {
            $scope.isStartRecord = true;
            $scope.recordWait = false;
            try {
                //实例化录音类
                VoicechangeAnimation();
                mediaService.startRecord();
                return false;
            } catch (err) {
                dialog.show('err m:' + err)
            }
        }
        $scope.onVoiceRelease = function () {
            $scope.recordWait = true;
            $timeout(function () {
                $scope.isStartRecord = false;
            }, 1000);
            mediaService.finishRecord().then(function (tmpPath, mediaRec) {
                rongyunService.sendVoiceMessage(conversationType,
                    targetId, tmpPath, dur).then(function (data) {
                        mediaRec.release();
                        appendNewMsg(data, true);
                    });
            });
            return false;
        }
        //  工具栏交互
        $scope.send_content = {
            text: ''
        };
        $scope.showPhonebar = false;
        $scope.onShowPhonebar = function () {
            if (!$scope.showPhonebar) {
                $scope.showPhonebar = true;
                $scope.showWXFace = false;
                scrolltoBottom();
            } else if ($scope.showPhonebar && $scope.showWXFace) {
                $scope.showWXFace = false;
            } else if ($scope.showPhonebar && !$scope.showWXFace) {
                $scope.showPhonebar = false;
            }
        }
        $scope.showWXFace = false;
        $scope.onShowWXFace = function () {
            if (!$scope.showPhonebar) {
                $scope.showPhonebar = true;
                $scope.showWXFace = true;
                scrolltoBottom();
                document.querySelector("#text_content").focus();
            } else if ($scope.showPhonebar && !$scope.showWXFace) {
                $scope.showWXFace = true;
                document.querySelector("#text_content").focus();
            } else if ($scope.showPhonebar && $scope.showWXFace) {
                $scope.showPhonebar = false;
                $scope.showWXFace = false;
            }
        }
        $scope.selectQQFace = function (text_content) {
            $scope.send_content.text = $scope.send_content.text + text_content;
            document.querySelector("#text_content").focus();
        }
        // 拉取历史消息
        $scope.doRefresh = function () {
            console.log('Refreshing!');
            $timeout(function () {
                // 拉取历史消息
                rongyunService.getHistoryMsg(targetId, conversationType)
                    .then(function (data) {
                        $scope.hisMsgs = data;
                    });
                $scope.$broadcast('scroll.refreshComplete');
            }, 200);
        };
        $scope.onSendTextMessage = function () {
            var message = $scope.send_content.text;
            sendMessage(conversationType, targetId, message);
            $scope.send_content.text = '';
            scrolltoBottom();
        }
        $scope.hisMsgs = [];
        var init = function () {
            if (conversationType == 'PRIVATE') {
                getLatestMsg(targetId, 'PRIVATE');
            }
            clearMessagesUnreadStatus();
        }
        //init();

        // ===  融云消息处理(BEGIN) ===
        // 发送文本消息
        function sendMessage(ctype, target, content) {
            rongyunService.sendMessage(ctype, target, content).then(function (data) {
                appendNewMsg(data, true);
            })
        }
        // 标为已读
        function clearMessagesUnreadStatus() {
            var ctype = conversationType;
            var targetid = targetId;
            rongyunService.clearMessagesUnreadStatus(ctype, target).then(function (data) {
            });
        }
        // 获取最新消息
        function getLatestMsg(targetid, ctype) {
            rongyunService.getLatestMsg(targetid, ctype).then(function (data) {
                $scope.hisMsgs = result;
                scrolltoBottom();
            });
        }
        $scope.sendPhoto = sendPhoto;
        // 发送图片(chattoolbar发起)
        function sendPhoto(imageURI) {
            rongyunService.sendImageMessage(conversationType, targetId, imageURI).then(function (data) {
                appendNewMsg(data, true);
            });
        };
        // ===  融云消息处理(END) ===

        // 滚动至底部(有bug)
        function scrolltoBottom() {
            $timeout(function () {
                viewScroll.scrollBottom(true);
            }, 50);
            $scope.fixReflowtag = !$scope.fixReflowtag;
        }

        // 添加新消息
        function appendNewMsg(msg, flag) {
            var curMsg = myUtil.resolveMsg(msg);
            $scope.hisMsgs.push(curMsg);
            scrolltoBottom();
        }

        // 模拟声音大小变化
        $scope.voiceImg = { url: 'assets/img/voice/recog000.png' };
        function VoicechangeAnimation() {
            var voicechange = $interval(function () {
                if (!$scope.recordWait) {
                    var i = Math.round(Math.random() * 9);
                    $scope.voiceImg.url = 'img/voice/recog00' + i + '.png';
                } else {
                    voicechange = undefined;
                }
            }, 400);
        }
        // 视频通话
        $scope.onVoiceCall = function () {
            //alert('chatdetial:' + targetId);
            var obj = { isCalling: true, contactName: targetId };
            $state.go('tab.call', obj);
        }
        $scope.onVedioCall = function () {
            //alert('chatdetial:' + targetId);
            var obj = { isCalling: true, contactName: targetId };
            $state.go('tab.call', obj);
        }
        // 初次加载
        $scope.$on("$ionicView.enter", function () {
            scrolltoBottom();
            console.log('chatdetial.enter');
        });
        window.addEventListener("native.keyboardshow", function (e) {
            scrolltoBottom();
        });

        // 监听消息发送事件(实时刷新消息)
        var newMsgCallBack = function (d, data) {
            var jsonMsg = JSON.parse(data);
            if (targetId == jsonMsg.targetId) {
                // clearMessagesUnreadStatus();
                // 获取群成员姓名
                if (jsonMsg.conversationType == "GROUP") {
                    if (members.length > 0) {
                        for (var m = 0; m < members.length; m++) {
                            if (members[m].id == jsonMsg.senderUserId) {
                                jsonMsg.name = members[m].name;
                            }
                        }
                    }
                }
                console.log('jsonMsg:', jsonMsg);
                var tmpMsg = myUtil.resolveMsg(jsonMsg);
                $scope.hisMsgs.push(tmpMsg);
                scrolltoBottom();
            }
        };
        newMessageEventService.listen(newMsgCallBack);
    })

angular.module('chat.controllers')
.controller('friendInfoCtrl', function ($scope, Friends, Blacklist, $state, $ionicLoading,
     $stateParams, $timeout, ResFriend) {
        $scope.Target = Friends.get($stateParams.targetId);
        var targetId = $stateParams.targetId;
        var targetName = $stateParams.targetName;
        $scope.isFriend = true;

        // 非好友
        if ($scope.Target == null) {
            $scope.isFriend = false;
            $scope.Target = { name: targetName, id: targetId };
        }

        $scope.settings = {
            inBlackList: false
        };
        var lists = Blacklist.all();
        if (!lists.length) {
            // 获取黑名单
            RongCloudLibPlugin.getBlacklist(
                function (ret, err) {
                    if (ret) {
                        console.log('getBlacklist:' + JSON.stringify(ret));
                        var userinfo;
                        for (var i = 0; i < ret.result.length; i++) {
                            userinfo = Friends.get(ret.result[i]);
                            lists.push({ id: ret.result[i], username: userinfo.username, portrait: userinfo.portrait });
                        }
                        Blacklist.set(lists);
                        console.log('Blacklist:' + JSON.stringify(Blacklist.all()));
                        console.log($stateParams.targetId);
                        console.log(JSON.stringify(Blacklist.get($stateParams.targetId)));
                        if (Blacklist.get($stateParams.targetId))
                            $scope.settings.inBlackList = true;
                    }
                    if (err) {
                        console.log('logout error:' + JSON.stringify(err));
                        alert('logout error:' + JSON.stringify(err));
                    }
                }
            );
        }
        else {
            if (Blacklist.get($stateParams.targetId))
                $scope.settings.inBlackList = true;
        }

        // 发送消息,跳转到聊天界面
        $scope.sendMsg = function () {
            //alert('p y is here ready to home:' + $stateParams.targetId + ":" + $stateParams.conversationType);
            $state.go('tab.chatDetail', {
                messageId: '1', name: targetName, targetId: targetId,
                conversationType: $stateParams.conversationType
            });
        }

        //////////////////////////////////////ws////////////////////////////////////////////////
        // 直接视频聊天
        $scope.vedioChat = function () {
            //alert('chatdetial:' + $stateParams.targetId);
            var obj = { isCalling: true, contactName: $stateParams.targetId };
            $state.go('call', obj);
        }

        // 添加陌生人为好友
        $scope.addFriend = function () {
            // 0 为发送好友请求
            ResFriend(targetId, 0, function () {
                // 成功后删掉记录并刷新好友列表
                var showMsg = "您已发送好友请求!";
                $ionicLoading.show({
                    template: showMsg
                });
                $timeout(function () {
                    $ionicLoading.hide();
                }, 750);
            });
        }

        // 添加/移除黑名单
        $scope.chBlackList = function () {
            if ($scope.settings.inBlackList) {
                RongCloudLibPlugin.addToBlacklist({ userId: $stateParams.targetId },
                    function (ret, err) {
                        if (ret) {
                            alert('加入黑名单成功!');
                            var userinfo = Friends.get($stateParams.targetId);
                            Blacklist.addOne({ id: $stateParams.targetId, username: userinfo.username,
                                portrait: userinfo.portrait });
                        }
                        if (err) {
                            alert('addToBlacklist error:' + JSON.stringify(err));
                        }
                    }
                );
            }
            else {
                RongCloudLibPlugin.removeFromBlacklist({ userId: $stateParams.targetId },
                    function (ret, err) {
                        if (ret) {
                            Blacklist.removeOne($stateParams.targetId);
                            alert('移出黑名单成功!');
                        }
                        if (err) {
                            alert('removeFromBlacklist error:' + JSON.stringify(err));
                        }
                    }
                );
            }
        }
    })

angular.module('chat.call', [])
    // 通话
    .controller('CallCtrl', function ($scope, $state, $rootScope, $timeout, $ionicHistory,
        $stateParams, signaling, Friends, rongyunService, mediaService) {
        var duplicateMessages = [];
        // 获取联系人
        $scope.contacts = {};
        // 静音
        $scope.muted = false;
        // 是否通话中
        $scope.callInProgress = false;
        // 是否主动发起
        $scope.isCalling = $stateParams.isCalling === 'true';

        // 响铃
        if (!$scope.isCalling) {
            mediaService.playSound();
        }
        // 查找联系人信息
        var contactUser = Friends.get($stateParams.contactName);
        if (!contactUser) {
            return;
        }
        $scope.contactUser = contactUser;
        $scope.contactName = contactUser.id;

        function call(isInitiator, contactName) {
            if (isInitiator) {
                sendMessage('[发起视频通话]');
            }
            // session通话初始化
            var session = phoneRTCService.createSession();
            session.on('sendMessage', function (data) {
                signaling.emit('sendMessage', contactName, {
                    type: 'phonertc_handshake',
                    data: JSON.stringify(data)
                });
            });
            session.on('answer', function () {
                // console.log('Answered!');
            });
            session.on('disconnect', function () {
                if ($scope.contacts[contactName]) {
                    delete $scope.contacts[contactName];
                }
                if (Object.keys($scope.contacts).length === 0) {
                    signaling.emit('sendMessage', contactName, { type: 'ignore' });
                    //junmback();
                    alert('************disconnects*************');
                }
            });
            session.call();
            // 保存连接
            $scope.contacts[contactName] = session;
        }
        // 拨号[发起]
        if ($scope.isCalling) {
            //alert('发起聊天：' + $scope.contactName + 'is Calling:' + $scope.isCalling);
            signaling.emit('sendMessage', $scope.contactName, { type: 'call' });
        }

        // 忽略
        $scope.ignore = function (msg) {
            alert('忽略');
            if (ring) {
                ring.release();
            }
            sendMessage(msg);
            var contactNames = Object.keys($scope.contacts);
            if (contactNames.length > 0) {
                $scope.contacts[contactNames[0]].disconnect();
            } else {
                signaling.emit('sendMessage', $scope.contactName, { type: 'ignore' });
                $scope.callInProgress = false;
                junmback();
            }
        };

        // 结束通话
        $scope.end = function () {
            alert('结束');
            sendMessage('[结束通话]');
            Object.keys($scope.contacts).forEach(function (contact) {
                $scope.contacts[contact].close();
                delete $scope.contacts[contact];
            });
            signaling.emit('sendMessage', $scope.contactName, { type: 'end' });
            $scope.callInProgress = false;
            junmback();
        };

        // 接听
        $scope.answer = function () {
            //alert('接听');
            if (ring) {
                ring.release();
            }
            if ($scope.callInProgress) {
                alert('*****正在通话中哦*****');
                return;
            }
            $scope.callInProgress = true;
            // 1s 后显示视频
            $timeout($scope.updateVideoPosition, 1000);
            call(false, $scope.contactName);
            // 1.5s 后接听
            setTimeout(function () {
                signaling.emit('sendMessage', $scope.contactName, { type: 'answer' });
            }, 1500);
        };

        // 静音
        // $scope.toggleMute = function () {
        //     $scope.muted = !$scope.muted;
        //     Object.keys($scope.contacts).forEach(function (contact) {
        //         var session = $scope.contacts[contact];
        //         session.streams.audio = !$scope.muted;
        //         session.renegotiate();
        //     });
        // };

        $scope.updateVideoPosition = function () {
            $rootScope.$broadcast('videoView.updatePosition');
        };

        // === socket.io消息分类处理(BEGIN) ===
        function onMessageReceive(name, message) {
            switch (message.type) {
                case 'answer':
                    // alert('************别人点了接听呀*************');
                    $scope.$apply(function () {
                        $scope.callInProgress = true;
                        $timeout($scope.updateVideoPosition, 1000);
                    });

                    var existingContacts = Object.keys($scope.contacts);
                    if (existingContacts.length !== 0) {
                        signaling.emit('sendMessage', name, {
                            type: 'add_to_group',
                            contacts: existingContacts,
                            isInitiator: false
                        });
                    }
                    call(true, name);
                    // alert('************call 方法没有问题呀*************');
                    break;
                // 拒绝接听(忽略)
                case 'ignore':
                    var len = Object.keys($scope.contacts).length;
                    if (len > 0) {
                        if ($scope.contacts[name]) {
                            $scope.contacts[name].close();
                            delete $scope.contacts[name];
                        }
                        var i = $scope.hideFromContactList.indexOf(name);
                        if (i > -1) {
                            $scope.hideFromContactList.splice(i, 1);
                        }

                        if (Object.keys($scope.contacts).length === 0) {
                            $scope.callInProgress = false;
                            junmback();
                        }
                    } else {
                        $scope.callInProgress = false;
                        junmback();
                    }
                    break;
                // 结束通话
                case 'end':
                    // alert('对方已经结束通话');
                    Object.keys($scope.contacts).forEach(function (contact) {
                        $scope.contacts[contact].close();
                        delete $scope.contacts[contact];
                    });
                    $timeout(function () {
                        $scope.callInProgress = false;
                        junmback();
                    }, 1000);
                    break;
                case 'phonertc_handshake':
                    // 本意是屏蔽重复信息，这里我@kobepeng先去掉了
                    //if (duplicateMessages.indexOf(message.data) === -1) {
                    // key : receiveMessage
                    $scope.contacts[name].receiveMessage(JSON.parse(message.data));
                    //   duplicateMessages.push(message.data);
                    // }
                    break;
                case 'add_to_group':
                    alert("add_to_group");
                    message.contacts.forEach(function (contact) {
                        $scope.hideFromContactList.push(contact);
                        call(message.isInitiator, contact);
                        if (!message.isInitiator) {
                            $timeout(function () {
                                signaling.emit('sendMessage', contact, {
                                    type: 'add_to_group',
                                    contacts: [ContactsService.currentName],
                                    isInitiator: true
                                });
                            }, 1500);
                        }
                    });
                    break;
                case 'callInProgress':
                    alert('对方正在通话中!');
                    junmback();
                    break;
                default: break;
            }
        }
        signaling.on('messageReceived', onMessageReceive);
        $scope.$on('$destroy', function () {
            signaling.removeListener('messageReceived', onMessageReceive);
        });
        function sendMessage(content) {
            rongyunService.sendMessage("PRIVATE", contactUser.id, content).then(function (data) {
                appendNewMsg(data, true);
            });
        }
        function junmback() {
            $ionicHistory.goBack(-1);
        }
    });

/**
 * 待测
 */

angular.module('chat.controllers')
    .controller('addGroupmember', function ($scope, $stateParams,
        $ionicPopup, $cordovaContacts, $ionicHistory, myNote, $timeout,
        Friends, Groups, AddGroupRequest) {
        var GroupID = $stateParams.GroupID;
        var group = {};

        // 获取好友列表
        Friends.all(function (frns) {
            var grp = Groups.getGroupMembers(GroupID, function (members) {
                for (var i = 0; i < frns.length; i++) {
                    frns[i].MemberID = "";
                    for (var j = 0; j < members.length; j++) {
                        if (frns[i].id == members[j]._id) {
                            frns[i].checked = true;
                            frns[i].MemberID = "123";
                        }
                    }
                }
                $scope.friends = frns;
            });
        });

        // 提交
        $scope.sure = function () {
            var members = [];
            angular.forEach($scope.friends, function (data) {
                if (!!data.checked && data.MemberID == "") {
                    members.push(data.id);
                }
            });
            addGroupMember(members);
        };

        // 发送入群请求
        function addGroupMember(members) {
            for (var j = 0; j < members.length; j++) {
                // userid，frindid，groupid， 
                AddGroupRequest(members[i], GroupID, function (data) {
                    alert("请求好友们入群发送成功！");
                });
            }
        }
    })
angular.module('chat.controllers')
    .controller('groupInfoCtrl', function ($scope, Groups, $state,
        $stateParams, RequestUrl) {
        $scope.Target = Groups.get($stateParams.targetId);
        var targetId = $stateParams.targetId;
        var targetName = $stateParams.targetName;
        var conversationType = $stateParams.conversationType;

        // 发送群消息
        $scope.sendMsg = function () {
            $state.go('tab.chatDetail',
                { name: targetName, targetId: targetId, conversationType: conversationType });
        }
        // 添加群成员
        $scope.addGroupmember = function () {
            $state.go('tab.addGroupmember',
                { GroupID: targetId });
        }
        $scope.members = [];
        function getGroupMem() {
            Groups.getGroupMembers(targetId, callback);
            function callback(members) {
                var length = members.length;
                $scope.Target.number = length;
                for (var i = 0; i < length; i++) {
                    var obj = {};
                    var temdata = members[i];
                    obj.id = temdata._id;
                    obj.name = temdata.nickname;
                    obj.portrait = temdata.headimg ? RequestUrl + 'Images/Photo/' + temdata.headimg : null;
                    $scope.members.push(obj);
                }
            }
        }
        // 获取群组成员
        getGroupMem();
    });
/**
 * chat模块服务
*/
var chat_modules = ['chat.route', 'chat.controllers', 'chat.services', 'chat.directive', 'chat.filter'];
chat_modules.concat(["chat.call"]);
angular.module('chat', chat_modules)
  // 视频服务配置
  .config(function (SignalingProvider, VEDIO_CHAT_URL) {
    SignalingProvider.setBackendUrl(VEDIO_CHAT_URL);
  })
  /**
   * 服务初始化
   * @param  {[Object]} $state [跳转服务]
   * @param  {[Object]} Signaling [socket.io实例]
   * @param  {[Object]} $ionicLoading [加载弹层]
   * @param  {[Object]} $rootScope [全局scope]
   * @param  {[Object]} newMessageEventService [新消息事件服务]
   */
  .run(function ($state, Signaling, $ionicLoading, $rootScope, newMessageEventService) {
    var chMsg = function (newValue, oldValue) {
      if (newValue !== oldValue) {
        var jsonMsg = newValue.pop();
        if (typeof jsonMsg !== "undefined" && jsonMsg !== "undefined") {
          newMessageEventService.broadcast(jsonMsg);
        }
      }
    };
    // watch items的变化
    var listener = $rootScope.$watch('arrMsgs', chMsg, true);
    Signaling.on('messageReceived', function (name, message, Signaling) {
      switch (message.type) {
        case 'call':
          if ($state.current.name === 'call') {
            Signaling.emit('sendMessage', name, { type: 'callInProgress' });
            return;
          }
          $state.go('call', { isCalling: false, contactName: name });
          break;
      }
    });
  });



//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNoYXQuZGlyZWN0aXZlLmpzIiwiY2hhdGlucHV0L2NoYXRpbnB1dC5qcyIsImNoYXRtZXNzYWdlcGFuZWwvY2hhdG1lc3NhZ2VwYW5lbC5qcyIsImNoYXR0b29sYmFyL2NoYXR0b29sYmFyLmpzIiwibWVzc2FnZWxpc3QvbWVzc2FnZWxpc3QuanMiLCJjb250YWN0bmF2L2NvbnRhY3RuYXYuanMiLCJwaG9uZWNvbnRhY3QvcGhvbmVjb250YWN0LmpzIiwicXFmYWNlL3FxZmFjZS5qcyIsInJlc2ZyaWVuZHRlYW0vcmVzZnJpZW5kdGVhbS5qcyIsInNlYXJjaGF1dG9jb21wbGV0ZS9zZWFyY2hhdXRvY29tcGxldGUuanMiLCJjaGF0LmZpbHRlci5qcyIsImNoYXQucm91dGUuanMiLCJjaGF0LnNlcnZpY2UuanMiLCJjaGF0LmNvbnRyb2xsZXIuanMiLCJhZGRmcmllbmQvYWRkRnJpZW5kLmpzIiwiYWRkZ3JvdXAvYWRkZ3JvdXAuanMiLCJjaGF0ZGV0YWlsL2NoYXREZXRhaWwuanMiLCJmcmllbmRpbmZvL2ZyaWVuZEluZm8uanMiLCJjYWxsL2NhbGwuanMiLCJhZGRncm91cG1lbWJlci9hZGRncm91cG1lbWJlci5qcyIsImdyb3VwaW5mby9ncm91cGluZm8uanMiLCJjaGF0Lm1vZHVsZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzlFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDM0NBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNqR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDNUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQy9DQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsSkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDMUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3BCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN2RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzVOQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDUEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM5RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzk3QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM3UkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDekNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN6RUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2xPQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDaEhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hPQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNwQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJjaGF0Lm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiDmjIfku6Tpm4ZcclxuICovXHJcbmFuZ3VsYXIubW9kdWxlKCdjaGF0LmRpcmVjdGl2ZScsIFtdKVxyXG4gICAgLmRpcmVjdGl2ZSgndmlkZW9WaWV3JywgZnVuY3Rpb24gKCRyb290U2NvcGUsICR0aW1lb3V0KSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJyxcclxuICAgICAgICAgICAgdGVtcGxhdGU6ICc8ZGl2IGNsYXNzPVwidmlkZW8tY29udGFpbmVyXCI+PC9kaXY+JyxcclxuICAgICAgICAgICAgcmVwbGFjZTogdHJ1ZSxcclxuICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRycykge1xyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gdXBkYXRlUG9zaXRpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29yZG92YS5wbHVnaW5zLnBob25lcnRjLnNldFZpZGVvVmlldyh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXI6IGVsZW1lbnRbMF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBbMTAsIDEwXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplOiBbMTAwLCAxMDBdXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhbGVydCgnZGlyZWMnICsgZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAkdGltZW91dCh1cGRhdGVQb3NpdGlvbiwgNTAwKTtcclxuICAgICAgICAgICAgICAgICRyb290U2NvcGUuJG9uKCd2aWRlb1ZpZXcudXBkYXRlUG9zaXRpb24nLCB1cGRhdGVQb3NpdGlvbik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KVxyXG4gICAgLy8g5by55qGG6IOM5pmvXHJcbiAgICAuZGlyZWN0aXZlKCdyakNsb3NlQmFja0Ryb3AnLCBbZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHNjb3BlOiBmYWxzZSxcclxuICAgICAgICAgICAgcmVzdHJpY3Q6ICdBJyxcclxuICAgICAgICAgICAgcmVwbGFjZTogZmFsc2UsXHJcbiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgaUVsbSwgaUF0dHJzLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaHRtbEVsID0gYW5ndWxhci5lbGVtZW50KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2h0bWwnKSk7XHJcbiAgICAgICAgICAgICAgICBodG1sRWwub24oXCJjbGlja1wiLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQudGFyZ2V0Lm5vZGVOYW1lID09PSBcIkhUTUxcIiAmJlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5wb3B1cC5vcHRpb25zUG9wdXAgJiYgc2NvcGUucG9wdXAuaXNQb3B1cCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5wb3B1cC5vcHRpb25zUG9wdXAuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUucG9wdXAuaXNQb3B1cCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH1dKVxyXG4gICAgLy8g6ZW/5oyJ5by55Ye65qGGXHJcbiAgICAuZGlyZWN0aXZlKCdyakhvbGRBY3RpdmUnLCBbJyRpb25pY0dlc3R1cmUnLCAnJHRpbWVvdXQnLCAnJGlvbmljQmFja2Ryb3AnLFxyXG4gICAgICAgIGZ1bmN0aW9uICgkaW9uaWNHZXN0dXJlLCAkdGltZW91dCwgJGlvbmljQmFja2Ryb3ApIHtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIHNjb3BlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsXHJcbiAgICAgICAgICAgICAgICByZXBsYWNlOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgaUVsbSwgaUF0dHJzLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGlvbmljR2VzdHVyZS5vbihcImhvbGRcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpRWxtLmFkZENsYXNzKCdhY3RpdmUnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaUVsbS5yZW1vdmVDbGFzcygnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDMwMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgaUVsbSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgXSlcclxuICAgIC8vIOi/m+WFpeaXtumakOiXj3RhYu+8jOmAgOWHuuaXtuaYvuekuijnlKjkuo7ogYrlpKkpXHJcbiAgICAuZGlyZWN0aXZlKCdoaWRlVGFic3hpZXRvbmcnLCBmdW5jdGlvbiAoJHJvb3RTY29wZSkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsXHJcbiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uICgkc2NvcGUsICRlbCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLiRvbihcIiRpb25pY1ZpZXcuYmVmb3JlRW50ZXJcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuaGlkZVRhYnN4aWV0b25nID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLiRvbihcIiRpb25pY1ZpZXcuYmVmb3JlTGVhdmVcIiwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuaGlkZVRhYnN4aWV0b25nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuIiwiYW5ndWxhci5tb2R1bGUoJ2NoYXQuZGlyZWN0aXZlJylcclxuICAgIC5kaXJlY3RpdmUoJ2NoYXRJbnB1dCcsIGZ1bmN0aW9uIChQaG90b0FuZEltYWdlcywgJHRpbWVvdXQpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICByZXN0cmljdDogXCJFXCIsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnbW9kdWxlL2NoYXQvZGlyZWN0aXZlcy9jaGF0aW5wdXQvY2hhdGlucHV0LnRwbCcsXHJcbiAgICAgICAgICAgIHJlcGxhY2U6IHRydWUsXHJcbiAgICAgICAgICAgIHNjb3BlOiB7XHJcbiAgICAgICAgICAgICAgICBzZW5kbWVzc2FnZTogXCI9dGV4dE1lc3NhZ2VcIixcclxuICAgICAgICAgICAgICAgIG9uU2hvd0ZhY2U6IFwiPW9uU2hvd0ZhY2VcIixcclxuICAgICAgICAgICAgICAgIG9uU2hvd1Bob25lYmFyOiBcIj1vblNob3dQaG9uZWJhclwiLFxyXG4gICAgICAgICAgICAgICAgb25TZW5kVGV4dE1lc3NhZ2U6IFwiJm9uU2VuZFRleHRNZXNzYWdlXCIsXHJcbiAgICAgICAgICAgICAgICBvblZvaWNlSG9sZDogXCImb25Wb2ljZUhvbGRcIixcclxuICAgICAgICAgICAgICAgIG9uVm9pY2VSZWxlYXNlOiBcIiZvblZvaWNlUmVsZWFzZVwiLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgICAgICAgICBzY29wZS5pc1ZvaWNlTWV0aG9kID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHNjb3BlLmlzU3RhcnRSZWNvcmQgPSAwLFxyXG5cclxuICAgICAgICAgICAgICAgIHNjb3BlLnN3aXRjaElucHV0TWV0aG9kID0gZnVuY3Rpb24gKGV2dG9iaikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzY29wZS5pc1ZvaWNlTWV0aG9kID0gIXNjb3BlLmlzVm9pY2VNZXRob2QsIHNjb3BlLmlzVm9pY2VNZXRob2QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IGV2dG9iai5jdXJyZW50VGFyZ2V0LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcihcInRleHRhcmVhXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5pc1N0YXJ0UmVjb3JkID0gITE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlucHV0LmZvY3VzKClcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTAwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgc2NvcGUub25TZW5kTWVzc2FnZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBzY29wZS5vblNlbmRUZXh0TWVzc2FnZSgpKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9zY29wZS5zZW5kbWVzc2FnZSA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIiN0ZXh0X2NvbnRlbnRcIikuZm9jdXMoKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHNjb3BlLm9uVm9pY2VIb2xkID0gZnVuY3Rpb24gKCkgeyB9XHJcbiAgICAgICAgICAgICAgICBzY29wZS5vblZvaWNlUmVsZWFzZSA9IGZ1bmN0aW9uICgpIHsgfVxyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuIiwiYW5ndWxhci5tb2R1bGUoJ2NoYXQuZGlyZWN0aXZlJylcclxuICAgIC5kaXJlY3RpdmUoJ2NoYXRNZXNzYWdlUGFuZWwnLCBmdW5jdGlvbiAoJGlvbmljTW9kYWwsICR0aW1lb3V0KSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcmVzdHJpY3Q6IFwiRVwiLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZVVybDogJ21vZHVsZS9jaGF0L2RpcmVjdGl2ZXMvY2hhdG1lc3NhZ2VwYW5lbC9jaGF0bWVzc2FnZXBhbmVsLnRwbCcsXHJcbiAgICAgICAgICAgIHJlcGxhY2U6IHRydWUsXHJcbiAgICAgICAgICAgIHNjb3BlOiB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlTGlzdDogXCI9bWVzc2FnZUxpc3RcIixcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcikge1xyXG4gICAgICAgICAgICAgICAgdmFyIG1lZGlhUmVjO1xyXG4gICAgICAgICAgICAgICAgc2NvcGUucGxheSA9IGZ1bmN0aW9uICh2b2lGaWxlLCB0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhUmVjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhUmVjLnN0b3AoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFSZWMucmVsZWFzZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gYW5ndWxhci5lbGVtZW50KGV2ZW50LnRhcmdldCkuZmluZChcImlcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT0gXCJ5b3VcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuYWRkQ2xhc3MoXCJ3ZWJfd2VjaGF0X3ZvaWNlX2dyYXlfcGxheWluZ1wiKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuYWRkQ2xhc3MoXCJ3ZWJfd2VjaGF0X3ZvaWNlX3BsYXlpbmdcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0lPUykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2b2lGaWxlID0gdm9pRmlsZS5yZXBsYWNlKCdmaWxlOi8vJywgJycpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBtZWRpYVJlYyA9IG5ldyBNZWRpYSh2b2lGaWxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDmiJDlip/mk43kvZxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT0gXCJ5b3VcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5yZW1vdmVDbGFzcyhcIndlYl93ZWNoYXRfdm9pY2VfZ3JheV9wbGF5aW5nXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQucmVtb3ZlQ2xhc3MoXCJ3ZWJfd2VjaGF0X3ZvaWNlX3BsYXlpbmdcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInBsYXkoKTpBdWRpbyBTdWNjZXNzXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDlpLHotKXmk43kvZxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT0gXCJ5b3VcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5yZW1vdmVDbGFzcyhcIndlYl93ZWNoYXRfdm9pY2VfZ3JheV9wbGF5aW5nXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQucmVtb3ZlQ2xhc3MoXCJ3ZWJfd2VjaGF0X3ZvaWNlX3BsYXlpbmdcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInBsYXkoKTpBdWRpbyBFcnJvcjogXCIgKyBlcnIuY29kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIC8v5byA5aeL5pKt5pS+5b2V6Z+zXHJcbiAgICAgICAgICAgICAgICAgICAgbWVkaWFSZWMucGxheSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgJGlvbmljTW9kYWwuZnJvbVRlbXBsYXRlVXJsKCdtb2R1bGUvY2hhdC9kaXJlY3RpdmVzL2NoYXRtZXNzYWdlcGFuZWwvbWVzc2FnZS9CaWdJbWFnZS5odG1sJywge1xyXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlOiBzY29wZSxcclxuICAgICAgICAgICAgICAgICAgICBhbmltYXRpb246ICdzbGlkZS1pbi11cCdcclxuICAgICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKG1vZGFsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUubW9kYWwgPSBtb2RhbDtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgc2NvcGUub3BlbkltYWdlID0gZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICBzY29wZS5pbWFnZURhdGEgPSBkYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLm1vZGFsLnNob3coKTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBzY29wZS5jbG9zZU1vZGFsID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLm1vZGFsLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICBzY29wZS5vcGVuSW1hZ2UgPSBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLmltYWdlRGF0YSA9IGRhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUubW9kYWwuc2hvdygpO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIC8vIOaehOW7uua2iOaBr1VJ5qih5p2/XHJcbiAgICAgICAgICAgICAgICBzY29wZS5idWlsZFVybCA9IGZ1bmN0aW9uICh0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRtcE5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JDOlR4dE1zZyc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBOYW1lID0gJ3R4dCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkM6SW1nTXNnJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5hbWUgPSAnaW1nJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdSQzpEaXpOdGYnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wTmFtZSA9ICdkaXonO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JDOkxCU01zZyc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBOYW1lID0gJ2xicyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnUkM6SW1nVGV4dE1zZyc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBOYW1lID0gJ2ltZ3RleHQnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ1JDOlZjTXNnJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcE5hbWUgPSAndmMnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ21vZHVsZS9jaGF0L2RpcmVjdGl2ZXMvY2hhdG1lc3NhZ2VwYW5lbC9tZXNzYWdlLycgKyB0bXBOYW1lICsgJy5odG1sJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuIiwiYW5ndWxhci5tb2R1bGUoJ2NoYXQuZGlyZWN0aXZlJylcclxuICAgIC5kaXJlY3RpdmUoJ2NoYXRUb29sQmFyJywgZnVuY3Rpb24oUGhvdG9BbmRJbWFnZXMpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICByZXN0cmljdDogXCJFXCIsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnbW9kdWxlL2NoYXQvZGlyZWN0aXZlcy9jaGF0dG9vbGJhci9jaGF0dG9vbGJhci50cGwnLFxyXG4gICAgICAgICAgICByZXBsYWNlOiB0cnVlLFxyXG4gICAgICAgICAgICBzY29wZToge1xyXG4gICAgICAgICAgICAgICAgc2VuZFBob3RvOiBcIiZzZW5kUGhvdG9cIixcclxuICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvblR5cGU6XCI9Y29udmVyc2F0aW9uVHlwZVwiXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcikge1xyXG4gICAgICAgICAgICAgICAgc2NvcGUudGFrZVBpYyA9IGZ1bmN0aW9uKHdheSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOS7juebuOWGjOS4remAieaLqVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh3YXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1YWxpdHk6IDgwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0V2lkdGg6IDMyMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldEhlaWdodDogMzIwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZVRvUGhvdG9BbGJ1bTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VUeXBlOiBDYW1lcmEuUGljdHVyZVNvdXJjZVR5cGUuUEhPVE9MSUJSQVJZLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb25UeXBlOiBDYW1lcmEuRGVzdGluYXRpb25UeXBlLkZJTEVfVVJJXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFBob3RvQW5kSW1hZ2VzLmdldEltYWdlcyhvcHRpb25zKS50aGVuKGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlLnNlbmRQaG90bygpKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDmi43nhafojrflj5ZcclxuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1YWxpdHk6IDgwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0V2lkdGg6IDMyMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldEhlaWdodDogMzIwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZVRvUGhvdG9BbGJ1bTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VUeXBlOiBDYW1lcmEuUGljdHVyZVNvdXJjZVR5cGUuQ2FtZXJhLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdGluYXRpb25UeXBlOiBDYW1lcmEuRGVzdGluYXRpb25UeXBlLkZJTEVfVVJJXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFBob3RvQW5kSW1hZ2VzLmdldFBob3RvKG9wdGlvbnMpLnRoZW4oZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuc2VuZFBob3RvKCkoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuIiwiYW5ndWxhci5tb2R1bGUoJ2NoYXQuZGlyZWN0aXZlJylcclxuICAgIC5kaXJlY3RpdmUoJ21lc3NhZ2VMaXN0JywgZnVuY3Rpb24gKCRpb25pY1BvcHVwKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcmVzdHJpY3Q6IFwiRVwiLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZVVybDogJ21vZHVsZS9jaGF0L2RpcmVjdGl2ZXMvbWVzc2FnZWxpc3QvbWVzc2FnZWxpc3QudHBsJyxcclxuICAgICAgICAgICAgcmVwbGFjZTogdHJ1ZSxcclxuICAgICAgICAgICAgc2NvcGU6IHtcclxuICAgICAgICAgICAgICAgIGZyaWVuZHNNZXNzYWdlOiBcIj1mcmllbmRzTWVzc2FnZVwiLFxyXG4gICAgICAgICAgICAgICAgZ290b0NoYXREZXRpbHM6IFwiJmdvdG9DaGF0RGV0aWxzMlwiLFxyXG4gICAgICAgICAgICAgICAgbWFya01lc3NhZ2U6IFwiJm1hcmtNZXNzYWdlMlwiLFxyXG4gICAgICAgICAgICAgICAgZGVsZXRlTWVzc2FnZTogXCImZGVsZXRlTWVzc2FnZTJcIixcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcikge1xyXG4gICAgICAgICAgICAgICAgc2NvcGUucG9wdXAgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNQb3B1cDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgaW5kZXg6IDBcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAvLyDlvLnlh7rmoYZcclxuICAgICAgICAgICAgICAgIHNjb3BlLnBvcHVwTWVzc2FnZU9wdGhpbnMgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLnBvcHVwLmluZGV4ID0gc2NvcGUuZnJpZW5kc01lc3NhZ2UuaW5kZXhPZihtZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgICAgICBzY29wZS5wb3B1cC5vcHRpb25zUG9wdXAgPSAkaW9uaWNQb3B1cC5zaG93KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IFwibW9kdWxlL2NoYXQvZGlyZWN0aXZlcy9tZXNzYWdlbGlzdC9wb3B1cC5odG1sXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiBzY29wZSxcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBzY29wZS5wb3B1cC5pc1BvcHVwID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAvLyDorr7kuLrlt7Lor7tcclxuICAgICAgICAgICAgICAgIHNjb3BlLm1hcmtNZXNzYWdlX2xvY2FsID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHNjb3BlLnBvcHVwLmluZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLnBvcHVwLm9wdGlvbnNQb3B1cC5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLnBvcHVwLmlzUG9wdXAgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICBzY29wZS5tYXJrTWVzc2FnZSgpKGluZGV4KTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAvLyDliKDpmaTmtojmga9cclxuICAgICAgICAgICAgICAgIHNjb3BlLmRlbGV0ZU1lc3NhZ2VfbG9jYWwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gc2NvcGUucG9wdXAuaW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUucG9wdXAub3B0aW9uc1BvcHVwLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUucG9wdXAuaXNQb3B1cCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLmRlbGV0ZU1lc3NhZ2UoKShpbmRleCk7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIHNjb3BlLmdvdG9DaGF0RGV0aWxzX2xvY2FsID0gZnVuY3Rpb24gKGZyaWVuZCwgJGluZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUuZ290b0NoYXREZXRpbHMoKShmcmllbmQsICRpbmRleCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfSk7XHJcbiIsIi8qKlxyXG4gKiDmjIfku6Tpm4ZcclxuICovXHJcbmFuZ3VsYXIubW9kdWxlKCdjaGF0LmRpcmVjdGl2ZScpXHJcbiAgICAuZGlyZWN0aXZlKFwibmdUb3VjaGVuZFwiLCBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBjb250cm9sbGVyOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMpIHtcclxuICAgICAgICAgICAgICAgICRlbGVtZW50LmJpbmQoJ3RvdWNoZW5kJywgb25Ub3VjaEVuZCk7XHJcblxyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gb25Ub3VjaEVuZChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBtZXRob2QgPSAkZWxlbWVudC5hdHRyKCduZy10b3VjaGVuZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS4kZXZlbnQgPSBldmVudDtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuJGFwcGx5KG1ldGhvZCk7XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH0pLmRpcmVjdGl2ZShcIm5nVG91Y2htb3ZlXCIsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGNvbnRyb2xsZXI6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykge1xyXG4gICAgICAgICAgICAgICAgJGVsZW1lbnQuYmluZCgndG91Y2hzdGFydCcsIG9uVG91Y2hTdGFydCk7XHJcblxyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gb25Ub3VjaFN0YXJ0KGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICAkZWxlbWVudC5iaW5kKCd0b3VjaG1vdmUnLCBvblRvdWNoTW92ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuYmluZCgndG91Y2hlbmQnLCBvblRvdWNoRW5kKTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gb25Ub3VjaE1vdmUoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbWV0aG9kID0gJGVsZW1lbnQuYXR0cignbmctdG91Y2htb3ZlJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLiRldmVudCA9IGV2ZW50O1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS4kYXBwbHkobWV0aG9kKTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gb25Ub3VjaEVuZChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudW5iaW5kKCd0b3VjaG1vdmUnLCBvblRvdWNoTW92ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudW5iaW5kKCd0b3VjaGVuZCcsIG9uVG91Y2hFbmQpO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KS5kaXJlY3RpdmUoJ2NvbnRhY3ROYXYnLCBbZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgcmVzdHJpY3Q6IFwiRVwiLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9XCJuYXYtY29udGFpbmVyXCI+J1xyXG4gICAgICAgICAgICArICcgICAgPHVsIGNsYXNzPVwiYWxwaGEtbmF2XCIgJ1xyXG4gICAgICAgICAgICArICcgICAgICAgIG5nLXRvdWNobW92ZT1cImdvTGlzdCgkZXZlbnQpXCIgJ1xyXG4gICAgICAgICAgICArICcgICAgICAgIG5nLXRvdWNoZW5kPVwiaGlkZVByb21wdEJveCgpXCIgJ1xyXG4gICAgICAgICAgICArICcgICAgICAgIG5nLXRvdWNoc3RhcnQ9XCJnb0xpc3RCeVRhcCgkZXZlbnQpXCI+J1xyXG4gICAgICAgICAgICArICcgICAgICAgIDxsaSBuZy1yZXBlYXQ9XCJjaGFyb2JqIGluIG5hdkNoYXJMaXN0X2xvY2FsXCIgJ1xyXG4gICAgICAgICAgICArICcgICAgICAgICAgICAgIGRhdGEtaWQ9XCJ7e2NoYXJvYmouaWR9fVwiPnt7Y2hhcm9iai5maXJzdENoYXJ9fSAnXHJcbiAgICAgICAgICAgICsgJyAgICAgICAgPC9saT4gJ1xyXG4gICAgICAgICAgICArICcgICAgICAgIDxkaXYgY2xhc3M9XCJwcm9tcHQtYm94XCIgbmctc2hvdz1cInRpcE9iai5pc1Nob3dcIj57e3RpcE9iai5jb250ZW50fX08L2Rpdj4gJ1xyXG4gICAgICAgICAgICArICcgICAgPC91bD4gJ1xyXG4gICAgICAgICAgICArICc8L2Rpdj4nLFxyXG4gICAgICAgICAgICByZXBsYWNlOiB0cnVlLFxyXG4gICAgICAgICAgICBzY29wZToge1xyXG4gICAgICAgICAgICAgICAgbmF2Q2hhckxpc3RfbG9jYWw6IFwiPW5hdkNoYXJMaXN0XCIsXHJcbiAgICAgICAgICAgICAgICBjaGFyQ2xpY2tDYjogXCImY2hhckNsaWNrQ2JcIlxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICAgICAgICAgIC8vIOa7muWKqOeahOaMh+WumuWFg+e0oFxyXG4gICAgICAgICAgICAgICAgdmFyIF9kZWxlZ2F0ZUhhbmRsZSA9IGF0dHJzW1wiZGVsZWdhdGVIYW5kbGVOYW1lXCJdO1xyXG4gICAgICAgICAgICAgICAgc2NvcGUudGlwT2JqID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIFwiaXNTaG93XCI6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIFwiY29udGVudFwiOicnXHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIC8qXHJcbiAgICAgICAgICAgICAgICAgKiDpmpDol4/mj5DnpLrmoYZcclxuICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBldmVudCBbcmVsZWFzZeS6i+S7tuWvueixoV1cclxuICAgICAgICAgICAgICAgICAqICovXHJcbiAgICAgICAgICAgICAgICBzY29wZS5oaWRlUHJvbXB0Qm94ID0gZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBzY29wZS50aXBPYmogPSB7IFwiaXNTaG93XCI6IGZhbHNlIH07XHJcbiAgICAgICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgICAgIC8qXHJcbiAgICAgICAgICAgICAgICAgKiDnlKjmiLfljZXlh7tcclxuICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBldmVudCBbcmVsZWFzZeS6i+S7tuWvueixoV1cclxuICAgICAgICAgICAgICAgICAqICovXHJcbiAgICAgICAgICAgICAgICBzY29wZS5nb0xpc3RCeVRhcCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVOYW1lID0gZXZlbnQudGFyZ2V0Lm5vZGVOYW1lLnRvVXBwZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVOYW1lICE9PSBcIkxJXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyDkuovku7bmupBcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gYW5ndWxhci5lbGVtZW50KGV2ZW50LnRhcmdldCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g6aaW5a2X5q+NXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0Q29kZSA9IHRhcmdldC5odG1sKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5a+86Iiq5LqL5Lu25Zue6LCDXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFhYWEgPSBzY29wZS5jaGFyQ2xpY2tDYigpKGZpcnN0Q29kZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8v5qCH562+aWRcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSB0YXJnZXQuYXR0cihcImRhdGEtaWRcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUudGlwT2JqID0geyBcImlzU2hvd1wiOiB0cnVlLCBcImNvbnRlbnRcIjogZmlyc3RDb2RlIH07XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHNjcm9sbENoYXJUb1RvcChpZCwgX2RlbGVnYXRlSGFuZGxlKTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgICAgICAqIOeUqOaIt+a7keWKqFxyXG4gICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGV2ZW50IFtyZWxlYXNl5LqL5Lu25a+56LGhXVxyXG4gICAgICAgICAgICAgICAgICogKi9cclxuICAgICAgICAgICAgICAgIHNjb3BlLmdvTGlzdCA9IGZ1bmN0aW9uKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVOYW1lID0gZXZlbnQudGFyZ2V0Lm5vZGVOYW1lLnRvVXBwZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGVOYW1lICE9PSBcIkxJXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyDmoLnmja7lnZDmoIfmnaXojrflj5blhYPntKDvvIFcclxuICAgICAgICAgICAgICAgICAgICB2YXIgdHR0ID0gZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludChcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICBub2RlTmFtZSA9IHR0dCA/IHR0dC5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpIDogXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobm9kZU5hbWUgIT09IFwiTElcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSBhbmd1bGFyLmVsZW1lbnQodHR0KTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3RDb2RlID0gdGFyZ2V0Lmh0bWwoKS50cmltKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5a+86Iiq5LqL5Lu25Zue6LCDXHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcGUuY2hhckNsaWNrQ2IoKShmaXJzdENvZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWvvOiIqmlkXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gdGFyZ2V0LmF0dHIoXCJkYXRhLWlkXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOaPkOekuuahhlxyXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlLnRpcE9iaiA9IHsgXCJpc1Nob3dcIjogdHJ1ZSwgXCJjb250ZW50XCI6IGZpcnN0Q29kZSB9O1xyXG4gICAgICAgICAgICAgICAgICAgIHNjcm9sbENoYXJUb1RvcChpZCwgX2RlbGVnYXRlSGFuZGxlKTtcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgICAgICAqIOmAmuiur+W9lea7muWKqOmAu+i+kVxyXG4gICAgICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGlkIFvpppblrZfmr43lhYPntKBJRF1cclxuICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBfZGVsZWdhdGVIYW5kbGUgW+WuueWZqOWvueixoV1cclxuICAgICAgICAgICAgICAgICAqICovXHJcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzY3JvbGxDaGFyVG9Ub3AoaWQsIF9kZWxlZ2F0ZUhhbmRsZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjaGFyUG9zID0gYW5ndWxhci5lbGVtZW50KGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCIjX1wiICsgaWQpKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY29udGFjdENvbnRhaW5lciA9IGFuZ3VsYXIuZWxlbWVudChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiI1wiICsgX2RlbGVnYXRlSGFuZGxlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXJQb3MubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvcCA9IGNoYXJQb3NbMF0ub2Zmc2V0VG9wO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAyN+S4uuWFg+e0oOmrmOW6plxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250YWN0Q29udGFpbmVyWzBdLnNjcm9sbFRvcCA9IHNjcm9sbFRvcCAtIDI3O1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IChcIm5hdiBub3QgZXhpdHMgb3IgbW9yZSB0aGFuIG9uZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfV0pO1xyXG4iLCJhbmd1bGFyLm1vZHVsZSgnY2hhdC5kaXJlY3RpdmUnKVxyXG4gICAgLmRpcmVjdGl2ZSgncGhvbmVDb250YWN0JywgZnVuY3Rpb24gKCRzdGF0ZSwgJGlvbmljTG9hZGluZyxcclxuICAgICAgICAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSwgJHRpbWVvdXQpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICByZXN0cmljdDogXCJFXCIsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnbW9kdWxlL2NoYXQvZGlyZWN0aXZlcy9waG9uZWNvbnRhY3QvcGhvbmVjb250YWN0LnRwbCcsXHJcbiAgICAgICAgICAgIHJlcGxhY2U6IHRydWUsXHJcbiAgICAgICAgICAgIHRyYW5zY2x1ZGUgOiB0cnVlLFxyXG4gICAgICAgICAgICBzY29wZToge1xyXG4gICAgICAgICAgICAgICAgZnJpZW5kc0xpc3RfbG9jYWw6IFwiPWZyaWVuZHNMaXN0XCIsXHJcbiAgICAgICAgICAgICAgICBncm91cHNMaXN0X2xvY2FsOiBcIj1ncm91cHNMaXN0XCIsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXIpIHtcclxuICAgICAgICAgICAgICAgIHNjb3BlLmluaXRUYWxrID0gZnVuY3Rpb24gKGZyaWVuZElELCB1c2VybmFtZSwgdHlwZSwgJGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHN0YXRlLmdvKCd0YWIuY2hhdERldGFpbCcsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUlkOiAnMScsIG5hbWU6IHVzZXJuYW1lLCB0YXJnZXRJZDogZnJpZW5kSUQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvblR5cGU6IHR5cGVcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyDogZTns7vkurrlj7Povrnlr7zoiKrmoI9cclxuICAgICAgICAgICAgICAgIHNjb3BlLmNyaSA9IHsgRGF0YVZhbHVlOiAnJyB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH0pO1xyXG4iLCJhbmd1bGFyLm1vZHVsZSgnY2hhdC5kaXJlY3RpdmUnKVxyXG4gICAgLmRpcmVjdGl2ZSgncXFGYWNlJyxmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICByZXN0cmljdDogXCJFXCIsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnbW9kdWxlL2NoYXQvZGlyZWN0aXZlcy9xcWZhY2UvcXFmYWNlLnRwbCcsXHJcbiAgICAgICAgICAgIHJlcGxhY2U6IHRydWUsXHJcbiAgICAgICAgICAgIHNjb3BlOiB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RRcUZhY2U6IFwiJnNlbGVjdFFxRmFjZVwiXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcikge1xyXG4gICAgICAgICAgICAgICAgLy8g6KGo5oOF6YCJ5oup5LqL5Lu2XHJcbiAgICAgICAgICAgICAgICBzY29wZS5jaG9vc2VGYWNlID0gZnVuY3Rpb24oZXZ0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2dC5zcmNFbGVtZW50LnRpdGxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0X2NvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3RleHRfY29udGVudFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUuc2VsZWN0UXFGYWNlKCkoXCJbXCIgKyBldmVudC5zcmNFbGVtZW50LnRpdGxlICsgXCJdXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuIiwiYW5ndWxhci5tb2R1bGUoJ2NoYXQuZGlyZWN0aXZlJylcclxuICAgIC5kaXJlY3RpdmUoJ3Jlc0ZyaWVuZFRlYW0nLCBmdW5jdGlvbiAoJGlvbmljTG9hZGluZywgJHRpbWVvdXQsIFJlc0ZyaWVuZCwgUmVzVGVhbSkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHJlc3RyaWN0OiBcIkVcIixcclxuICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdtb2R1bGUvY2hhdC9kaXJlY3RpdmVzL3Jlc2ZyaWVuZHRlYW0vcmVzZnJpZW5kdGVhbS50cGwnLFxyXG4gICAgICAgICAgICByZXBsYWNlOiB0cnVlLFxyXG4gICAgICAgICAgICBzY29wZToge1xyXG4gICAgICAgICAgICAgICAgZ3JvdXBpbnZpdGVMaXN0X2xvY2FsOiBcIj1ncm91cGludml0ZUxpc3RcIixcclxuICAgICAgICAgICAgICAgIGZyaWVuZGludml0ZUxpc3RfbG9jYWw6IFwiPWZyaWVuZGludml0ZUxpc3RcIixcclxuICAgICAgICAgICAgICAgIHJlc3BvbnNlUmVxX2xvY2FsOiBcIiZyZXNwb25zZVJlcVwiLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVyKSB7XHJcbiAgICAgICAgICAgICAgICBzY29wZS5yZXNwb25zZVJlcV9sb2NhbCA9IGZ1bmN0aW9uIChpZCwgbmFtZSwgdHlwZSwgc3RhdGUsICRpbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09IFwiUFJJVkFURVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOWlveWPi+ivt+axgiBVc2VySUQsIEZyaWVuZElELCBzdGF0ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBSZXNGcmllbmQoY3VyVUlELCBpZCwgc3RhdGUsIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDlm6LpmJ/pgoDor7cgZ3JvdXBJRCwgTWVtYmVySUQsIHN0YXRlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFJlc1RlYW0oaWQsIGN1clVJRCwgc3RhdGUsIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNob3dNc2cgPSAnJztcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOaIkOWKn+WQjuWIoOaOieiusOW9leW5tuWIt+aWsOWlveWPi+WIl+ihqFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09IFwiUFJJVkFURVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT0gJzEnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd01zZyA9IFwi5oKo5bey5re75YqgXCIgKyBuYW1lICsgXCLkuLrlpb3lj4shXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g5ZCM5q2l6Iez6J6N5LqRKOWPr+mAie+8jOW3suWcqOacjeWKoeerr+WBmuWQjOatpSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd01zZyA9IFwi5oKo5bey5ouS57udXCIgKyBuYW1lICsgXCLnmoTlpb3lj4vor7fmsYIhXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaW9uaWNMb2FkaW5nLnNob3coe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlOiBzaG93TXNnXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIOa3u+WKoOWIsOmAmuiur+W9lVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLmlkID0gaWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmoubmFtZSA9IG5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouYWxwaGEgPSBtYWtlUHkob2JqLm5hbWUpWzBdWzBdLnRvVXBwZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmouY29udmVyc2F0aW9uVHlwZSA9ICdQUklWQVRFJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5wb3J0cmFpdCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGlvbmljTG9hZGluZy5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCA3NTApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUucmVzcG9uc2VSZXEoKShvYmosICRpbmRleCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGUgPT0gJzEnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvd01zZyA9IFwi5oKo5bey5Yqg5YWl576kXCIgKyBuYW1lICsgXCIhXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dNc2cgPSBcIuaCqOW3suaLkue7neWKoOWFpee+pFwiICsgbmFtZSArIFwiIVwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJGlvbmljTG9hZGluZy5zaG93KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogc2hvd01zZ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyDmt7vliqDliLDpgJrorq/lvZVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5pZCA9ICdjcmVfJyArIGlkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLm51bWJlciA9IDEwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqLm1heF9udW1iZXIgPSAzMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5uYW1lID0gbmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai5jb252ZXJzYXRpb25UeXBlID0gJ0dST1VQJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iai50eXBlID0gJ2NyZWF0ZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmoucG9ydHJhaXQgPSBudWxsOy8vJ+S6v+i+vuWIq+iLkee7tOS/ruW3pV8yMDAucG5nJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkaW9uaWNMb2FkaW5nLmhpZGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDc1MCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZS5yZXNwb25zZVJlcSgpKG9iaiwgJGluZGV4LCB0eXBlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICB9KTtcclxuIiwiYW5ndWxhci5tb2R1bGUoJ2NoYXQuZGlyZWN0aXZlJylcclxuICAgIC5kaXJlY3RpdmUoJ3NlYXJjaEF1dG9Db21wbGV0ZScsIGZ1bmN0aW9uICgkcGFyc2UsICRodHRwLCAkc2NlLCAkdGltZW91dCwgJHJvb3RTY29wZSkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLFxyXG4gICAgICAgICAgICBzY29wZToge1xyXG4gICAgICAgICAgICAgICAgXCJpZFwiOiBcIkBpZFwiLFxyXG4gICAgICAgICAgICAgICAgXCJwbGFjZWhvbGRlclwiOiBcIkBwbGFjZWhvbGRlclwiLFxyXG4gICAgICAgICAgICAgICAgXCJzZWxlY3RDb21wYW55XCI6IFwiPXNlbGVjdGNvbXBhbnlcIixcclxuICAgICAgICAgICAgICAgIFwic2VsZWN0ZWRPYmplY3RcIjogXCI9c2VsZWN0ZWRvYmplY3RcIixcclxuICAgICAgICAgICAgICAgIFwic2VhcmNoU3RyXCI6IFwiQHNlYXJjaHN0clwiLFxyXG4gICAgICAgICAgICAgICAgXCJ1cmxcIjogXCJAdXJsXCIsXHJcbiAgICAgICAgICAgICAgICBcInBhcmFtTmFtZTFcIjogXCJAcGFyYW1uYW1lXCIsXHJcbiAgICAgICAgICAgICAgICBcImRhdGFGaWVsZFwiOiBcIkBkYXRhZmllbGRcIixcclxuICAgICAgICAgICAgICAgIFwidGl0bGVGaWVsZFwiOiBcIkB0aXRsZWZpZWxkXCIsXHJcbiAgICAgICAgICAgICAgICBcImRlc2NyaXB0aW9uRmllbGRcIjogXCJAZGVzY3JpcHRpb25maWVsZFwiLFxyXG4gICAgICAgICAgICAgICAgXCJpbWFnZUZpZWxkXCI6IFwiQGltYWdlZmllbGRcIixcclxuICAgICAgICAgICAgICAgIFwiaW1hZ2VVcmlcIjogXCJAaW1hZ2V1cmlcIixcclxuICAgICAgICAgICAgICAgIFwiaW5wdXRDbGFzc1wiOiBcIkBpbnB1dGNsYXNzXCIsXHJcbiAgICAgICAgICAgICAgICBcInVzZXJQYXVzZVwiOiBcIkBwYXVzZVwiLFxyXG4gICAgICAgICAgICAgICAgXCJsb2NhbERhdGFcIjogXCI9bG9jYWxkYXRhXCIsXHJcbiAgICAgICAgICAgICAgICBcInNlYXJjaEZpZWxkc1wiOiBcIkBzZWFyY2hmaWVsZHNcIixcclxuICAgICAgICAgICAgICAgIFwibWluTGVuZ3RoVXNlclwiOiBcIkBtaW5sZW5ndGhcIixcclxuICAgICAgICAgICAgICAgIFwibWF0Y2hDbGFzc1wiOiBcIkBtYXRjaGNsYXNzXCJcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdtb2R1bGUvY2hhdC9kaXJlY3RpdmVzL3NlYXJjaGF1dG9jb21wbGV0ZS9zZWFyY2hhdXRvY29tcGxldGUudHBsJyxcclxuICAgICAgICAgICAgbGluazogZnVuY3Rpb24gKCRzY29wZSwgZWxlbSwgYXR0cnMpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5sYXN0U2VhcmNoVGVybSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuY3VycmVudEluZGV4ID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICRzY29wZS5qdXN0Q2hhbmdlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNlYXJjaFRpbWVyID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICRzY29wZS5oaWRlVGltZXIgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnBhdXNlID0gNTAwO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLm1pbkxlbmd0aCA9IDM7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2VhcmNoU3RyID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLm1pbkxlbmd0aFVzZXIgJiYgJHNjb3BlLm1pbkxlbmd0aFVzZXIgIT0gXCJcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5taW5MZW5ndGggPSAkc2NvcGUubWluTGVuZ3RoVXNlcjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICgkc2NvcGUudXNlclBhdXNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnBhdXNlID0gJHNjb3BlLnVzZXJQYXVzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlzTmV3U2VhcmNoTmVlZGVkID0gZnVuY3Rpb24gKG5ld1Rlcm0sIG9sZFRlcm0pIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3VGVybS5sZW5ndGggPj0gJHNjb3BlLm1pbkxlbmd0aCAmJiBuZXdUZXJtICE9IG9sZFRlcm1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICRzY29wZS5wcm9jZXNzUmVzdWx0cyA9IGZ1bmN0aW9uIChyZXNwb25zZURhdGEsIHN0cikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZURhdGEgJiYgcmVzcG9uc2VEYXRhLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnJlc3VsdHMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRpdGxlRmllbGRzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkc2NvcGUudGl0bGVGaWVsZCAmJiAkc2NvcGUudGl0bGVGaWVsZCAhPSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZUZpZWxkcyA9ICRzY29wZS50aXRsZUZpZWxkLnNwbGl0KFwiLFwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3BvbnNlRGF0YS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHRpdGxlIHZhcmlhYmxlc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRpdGxlQ29kZSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgdCA9IDA7IHQgPCB0aXRsZUZpZWxkcy5sZW5ndGg7IHQrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlQ29kZS5wdXNoKHJlc3BvbnNlRGF0YVtpXVt0aXRsZUZpZWxkc1t0XV0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRlc2NyaXB0aW9uID0gXCJcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkc2NvcGUuZGVzY3JpcHRpb25GaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gcmVzcG9uc2VEYXRhW2ldWyRzY29wZS5kZXNjcmlwdGlvbkZpZWxkXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbWFnZVVyaSA9IFwiXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLmltYWdlVXJpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VVcmkgPSAkc2NvcGUuaW1hZ2VVcmk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW1hZ2UgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRzY29wZS5pbWFnZUZpZWxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UgPSBpbWFnZVVyaSArIHJlc3BvbnNlRGF0YVtpXVskc2NvcGUuaW1hZ2VGaWVsZF07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IHRpdGxlQ29kZS5qb2luKCcgJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLm1hdGNoQ2xhc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmUgPSBuZXcgUmVnRXhwKHN0ciwgJ2knKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RyUGFydCA9IHRleHQubWF0Y2gocmUpWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSAkc2NlLnRydXN0QXNIdG1sKHRleHQucmVwbGFjZShyZSwgJzxzcGFuIGNsYXNzPVwiJyArICRzY29wZS5tYXRjaENsYXNzICsgJ1wiPicgKyBzdHJQYXJ0ICsgJzwvc3Bhbj4nKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0Um93ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiB0ZXh0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZTogaW1hZ2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxPYmplY3Q6IHJlc3BvbnNlRGF0YVtpXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnJlc3VsdHNbJHNjb3BlLnJlc3VsdHMubGVuZ3RoXSA9IHJlc3VsdFJvdztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5yZXN1bHRzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICRzY29wZS5zZWFyY2hUaW1lckNvbXBsZXRlID0gZnVuY3Rpb24gKHN0cikge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEJlZ2luIHRoZSBzZWFyY2hcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RyLmxlbmd0aCA+PSAkc2NvcGUubWluTGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkc2NvcGUubG9jYWxEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2VhcmNoRmllbGRzID0gJHNjb3BlLnNlYXJjaEZpZWxkcy5zcGxpdChcIixcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAkc2NvcGUubG9jYWxEYXRhLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgcyA9IDA7IHMgPCBzZWFyY2hGaWVsZHMubGVuZ3RoOyBzKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBtYXRjaCB8fCAodHlwZW9mICRzY29wZS5sb2NhbERhdGFbaV1bc2VhcmNoRmllbGRzW3NdXSA9PT0gJ3N0cmluZycgJiZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBzdHIgPT09ICdzdHJpbmcnICYmICRzY29wZS5sb2NhbERhdGFbaV1bc2VhcmNoRmllbGRzW3NdXS50b0xvd2VyQ2FzZSgpLmluZGV4T2Yoc3RyLnRvTG93ZXJDYXNlKCkpID49IDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlc1ttYXRjaGVzLmxlbmd0aF0gPSAkc2NvcGUubG9jYWxEYXRhW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5zZWFyY2hpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5wcm9jZXNzUmVzdWx0cyhtYXRjaGVzLCBzdHIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFtZW5hbWUgPSAnPycgKyBlbmNvZGVVUklDb21wb25lbnQoJHNjb3BlLnBhcmFtTmFtZTEpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHN0cik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbWVuYW1lICs9ICcmY29tcGFueT0nICsgZW5jb2RlVVJJQ29tcG9uZW50KCRzY29wZS5zZWxlY3RDb21wYW55LnRpdGxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRodHRwLmdldCgkc2NvcGUudXJsICsgcGFyYW1lbmFtZSwge30pLlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24gKHJlc3BvbnNlRGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkZWJ1Z2dlcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gKCgkc2NvcGUuZGF0YUZpZWxkKSA/IHJlc3BvbnNlRGF0YVskc2NvcGUuZGF0YUZpZWxkXSA6IHJlc3BvbnNlRGF0YSApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5wcm9jZXNzUmVzdWx0cyhyZXNwb25zZURhdGEsIHN0cik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24gKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZXJyb3JcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmhpZGVSZXN1bHRzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5oaWRlVGltZXIgPSAkdGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5zaG93RHJvcGRvd24gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAkc2NvcGUucGF1c2UpO1xyXG4gICAgICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgICAgICAkc2NvcGUucmVzZXRIaWRlUmVzdWx0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLmhpZGVUaW1lcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkdGltZW91dC5jYW5jZWwoJHNjb3BlLmhpZGVUaW1lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuaG92ZXJSb3cgPSBmdW5jdGlvbiAoaW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY3VycmVudEluZGV4ID0gaW5kZXg7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUua2V5UHJlc3NlZCA9IGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghKGV2ZW50LndoaWNoID09IDM4IHx8IGV2ZW50LndoaWNoID09IDQwIHx8IGV2ZW50LndoaWNoID09IDEzKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoISRzY29wZS5zZWFyY2hTdHIgfHwgJHNjb3BlLnNlYXJjaFN0ciA9PSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd0Ryb3Bkb3duID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUubGFzdFNlYXJjaFRlcm0gPSBudWxsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNOZXdTZWFyY2hOZWVkZWQoJHNjb3BlLnNlYXJjaFN0ciwgJHNjb3BlLmxhc3RTZWFyY2hUZXJtKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmxhc3RTZWFyY2hUZXJtID0gJHNjb3BlLnNlYXJjaFN0clxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNob3dEcm9wZG93biA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY3VycmVudEluZGV4ID0gLTE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUucmVzdWx0cyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRzY29wZS5zZWFyY2hUaW1lcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aW1lb3V0LmNhbmNlbCgkc2NvcGUuc2VhcmNoVGltZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNlYXJjaGluZyA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNlYXJjaFRpbWVyID0gJHRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5zZWFyY2hUaW1lckNvbXBsZXRlKCRzY29wZS5zZWFyY2hTdHIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgJHNjb3BlLnBhdXNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNlbGVjdFJlc3VsdCA9IGZ1bmN0aW9uIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLm1hdGNoQ2xhc3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnRpdGxlID0gcmVzdWx0LnRpdGxlLnRvU3RyaW5nKCkucmVwbGFjZSgvKDwoW14+XSspPikvaWcsICcnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNlYXJjaFN0ciA9ICRzY29wZS5sYXN0U2VhcmNoVGVybSA9IHJlc3VsdC50aXRsZTtcclxuICAgICAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5zZWxlY3RlZE9iamVjdC50aXRsZSA9IHJlc3VsdC50aXRsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNlbGVjdGVkT2JqZWN0Lm9yaWdpbmFsT2JqZWN0ID0gcmVzdWx0Lm9yaWdpbmFsT2JqZWN0O1xyXG4gICAgICAgICAgICAgICAgICAgIH0sIDEwKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyRyb290U2NvcGUuc2VsZWN0ZWRPYmplY3QgPSByZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNob3dEcm9wZG93biA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5yZXN1bHRzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgLy8kc2NvcGUuJGFwcGx5KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGlucHV0RmllbGQgPSBlbGVtLmZpbmQoJ2lucHV0Jyk7XHJcblxyXG4gICAgICAgICAgICAgICAgaW5wdXRGaWVsZC5vbigna2V5dXAnLCAkc2NvcGUua2V5UHJlc3NlZCk7XHJcbiAgICAgICAgICAgICAgICBlbGVtLm9uKFwia2V5dXBcIiwgZnVuY3Rpb24gKGV2ZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50LndoaWNoID09PSA0MCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLnJlc3VsdHMgJiYgKCRzY29wZS5jdXJyZW50SW5kZXggKyAxKSA8ICRzY29wZS5yZXN1bHRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmN1cnJlbnRJbmRleCsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuJGFwcGx5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudC53aGljaCA9PSAzOCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLmN1cnJlbnRJbmRleCA+PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY3VycmVudEluZGV4LS07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuJGFwcGx5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnQud2hpY2ggPT0gMTMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRzY29wZS5yZXN1bHRzICYmICRzY29wZS5jdXJyZW50SW5kZXggPj0gMCAmJiAkc2NvcGUuY3VycmVudEluZGV4IDwgJHNjb3BlLnJlc3VsdHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuc2VsZWN0UmVzdWx0KCRzY29wZS5yZXN1bHRzWyRzY29wZS5jdXJyZW50SW5kZXhdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS4kYXBwbHkoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUucmVzdWx0cyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LndoaWNoID09IDI3KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5yZXN1bHRzID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5zaG93RHJvcGRvd24gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnQud2hpY2ggPT0gOCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuc2VsZWN0ZWRPYmplY3QgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuJGFwcGx5KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfSkiLCIvLy8g5a2X56ym6L2s56CBXHJcbjsgYW5ndWxhci5tb2R1bGUoJ2NoYXQuZmlsdGVyJywgW10pXHJcbiAgICAuZmlsdGVyKCd0cnVzdEh0bWwnLCBmdW5jdGlvbiAoJHNjZSkge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoaW5wdXQpIHtcclxuICAgICAgICAgICAgcmV0dXJuICRzY2UudHJ1c3RBc0h0bWwoaW5wdXQpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4iLCIndXNlIHN0cmljdCc7XHJcbmFuZ3VsYXIubW9kdWxlKCdjaGF0LnJvdXRlJywgW10pXHJcbiAgICAuY29uZmlnKFsnJHN0YXRlUHJvdmlkZXInLCBmdW5jdGlvbiAoJHN0YXRlUHJvdmlkZXIpIHtcclxuICAgICAgICAkc3RhdGVQcm92aWRlclxyXG4gICAgICAgICAgICAuc3RhdGUoJ3RhYi5jYWxsJywge1xyXG4gICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgdXJsOiAnL2NhbGwvOmNvbnRhY3ROYW1lP2lzQ2FsbGluZycsXHJcbiAgICAgICAgICAgICAgICBjb250cm9sbGVyOiAnQ2FsbEN0cmwnLFxyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdtb2R1bGUvY2hhdC9wYWdlcy9jYWxsL2NhbGwuaHRtbCdcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLnN0YXRlKCd0YWIuY2hhdCcsIHtcclxuICAgICAgICAgICAgICAgIHVybDogJy9jaGF0JyxcclxuICAgICAgICAgICAgICAgIHZpZXdzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ3RhYi1jaGF0Jzoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogJ21vZHVsZS9jaGF0L3RwbC9jb250YWN0cy5odG1sJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogJ2NvbnRhY3RzJ1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLnN0YXRlKCd0YWIuZnJpZW5kSW5mbycsIHtcclxuICAgICAgICAgICAgICAgIHVybDogJy9mcmllbmRJbmZvLzp0YXJnZXRJZC86dGFyZ2V0TmFtZS86Y29udmVyc2F0aW9uVHlwZScsXHJcbiAgICAgICAgICAgICAgICBjYWNoZTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICB2aWV3czoge1xyXG4gICAgICAgICAgICAgICAgICAgICd0YWItY2hhdCc6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdtb2R1bGUvY2hhdC9wYWdlcy9mcmllbmRpbmZvL2ZyaWVuZGluZm8uaHRtbCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6ICdmcmllbmRJbmZvQ3RybCdcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5zdGF0ZSgndGFiLmdyb3VwSW5mbycsIHtcclxuICAgICAgICAgICAgICAgIHVybDogJy9ncm91cEluZm8vOnRhcmdldElkLzp0YXJnZXROYW1lLzpncm91cFR5cGUvOmNvbnZlcnNhdGlvblR5cGUnLFxyXG4gICAgICAgICAgICAgICAgY2FjaGU6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgdmlld3M6IHtcclxuICAgICAgICAgICAgICAgICAgICAndGFiLWNoYXQnOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnbW9kdWxlL2NoYXQvcGFnZXMvZ3JvdXBpbmZvL2dyb3VwaW5mby5odG1sJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogJ2dyb3VwSW5mb0N0cmwnXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuc3RhdGUoJ3RhYi5jaGF0RGV0YWlsJywge1xyXG4gICAgICAgICAgICAgICAgdXJsOiAnL2NoYXQtZGV0YWlsJyxcclxuICAgICAgICAgICAgICAgIHBhcmFtczogeyBtZXNzYWdlSWQ6IG51bGwsIG5hbWU6IG51bGwsIHRhcmdldElkOiBudWxsLCBjb252ZXJzYXRpb25UeXBlOiBudWxsIH0sXHJcbiAgICAgICAgICAgICAgICB2aWV3czoge1xyXG4gICAgICAgICAgICAgICAgICAgICd0YWItY2hhdCc6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICdtb2R1bGUvY2hhdC9wYWdlcy9jaGF0ZGV0YWlsL2NoYXRkZXRhaWwuaHRtbCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6ICdjaGF0RGV0YWlsJ1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLnN0YXRlKCd0YWIuYWRkR3JvdXAnLCB7XHJcbiAgICAgICAgICAgICAgICB1cmw6ICcvYWRkR3JvdXAnLFxyXG4gICAgICAgICAgICAgICAgdmlld3M6IHtcclxuICAgICAgICAgICAgICAgICAgICAndGFiLWNoYXQnOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnbW9kdWxlL2NoYXQvcGFnZXMvYWRkZ3JvdXAvYWRkZ3JvdXAuaHRtbCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6ICdhZGRHcm91cEN0cmwnXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuc3RhdGUoJ3RhYi5hZGRHcm91cG1lbWJlcicsIHtcclxuICAgICAgICAgICAgICAgIHVybDogJy9hZGRHcm91cG1lbWJlcicsXHJcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHsgR3JvdXBJRDogbnVsbCB9LFxyXG4gICAgICAgICAgICAgICAgdmlld3M6IHtcclxuICAgICAgICAgICAgICAgICAgICAndGFiLWNoYXQnOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnbW9kdWxlL2NoYXQvcGFnZXMvYWRkZ3JvdXBtZW1iZXIvYWRkZ3JvdXBtZW1iZXIuaHRtbCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXI6ICdhZGRHcm91cG1lbWJlcidcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5zdGF0ZSgndGFiLmFkZEZyaWVuZCcsIHtcclxuICAgICAgICAgICAgICAgIHVybDogJy9hZGRGcmllbmQnLFxyXG4gICAgICAgICAgICAgICAgdmlld3M6IHtcclxuICAgICAgICAgICAgICAgICAgICAndGFiLWNoYXQnOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlVXJsOiAnbW9kdWxlL2NoYXQvcGFnZXMvYWRkZnJpZW5kL2FkZGZyaWVuZC5odG1sJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlcjogJ2FkZEZyaWVuZEN0cmwnXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1dKTtcclxuIiwiO1xyXG52YXIgY2hhdHMgPSBhbmd1bGFyLm1vZHVsZSgnY2hhdC5zZXJ2aWNlcycsIFtdKTtcclxuXHJcbi8vIOeUqOaIt+WFqOWxgOW8leeUqFxyXG5jaGF0cy5mYWN0b3J5KCdpbml0Um9uZycsIGZ1bmN0aW9uICgkcm9vdFNjb3BlLCAkc3RhdGUsIFJPTkdZVU5fQVBQS0VZKSB7XHJcbiAgICBmdW5jdGlvbiBpbml0Um9uZyh0b2tlbikge1xyXG4gICAgICAgICRyb290U2NvcGUuYXJyTXNncyA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgICRyb290U2NvcGUuYXJyQ29ucyA9IG5ldyBBcnJheSgpO1xyXG4gICAgICAgIC8vIOiejeS6keWIneWni+WMllxyXG4gICAgICAgIFJvbmdDbG91ZExpYlBsdWdpbi5pbml0KHtcclxuICAgICAgICAgICAgYXBwS2V5OiBST05HWVVOX0FQUEtFWVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChyZXQsIGVycikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJldCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGFsZXJ0KCdpbml0OicgKyBKU09OLnN0cmluZ2lmeShyZXQpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBhbGVydCgnaW5pdCBlcnJvcjonICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICAgIFJvbmdDbG91ZExpYlBsdWdpbi5zZXRDb25uZWN0aW9uU3RhdHVzTGlzdGVuZXIoXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChyZXQsIGVycikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJldCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWPquWFgeiuuOWNleeUqOaIt+eZu+W9lVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXQucmVzdWx0LmNvbm5lY3Rpb25TdGF0dXMgPT0gJ0tJQ0tFRCcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ+aCqOeahOW4kOWPt+W3suWcqOWFtuS7luerr+eZu+W9lSEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS5oaWRlVGFicyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyRpb25pY0hpc3RvcnkuY2xlYXJDYWNoZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc3RhdGUuZ28oJ2xvZ2luJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGFsZXJ0KCdzZXRDb25uZWN0aW9uU3RhdHVzTGlzdGVuZXIgZXJyb3I6JyArIEpTT04uc3RyaW5naWZ5KGVycikpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgICAvLyDlu7rnq4vov57mjqVcclxuICAgICAgICBSb25nQ2xvdWRMaWJQbHVnaW4uY29ubmVjdCh7XHJcbiAgICAgICAgICAgIHRva2VuOiB0b2tlblxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChyZXQsIGVycikge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ2luaXQgZXJyb3I6JyArIEpTT04uc3RyaW5naWZ5KGVycikpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgICAvLyDmtojmga/mjqXmlLZcclxuICAgICAgICBSb25nQ2xvdWRMaWJQbHVnaW4uc2V0T25SZWNlaXZlTWVzc2FnZUxpc3RlbmVyKFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAocmV0LCBlcnIpIHtcclxuICAgICAgICAgICAgICAgIC8vIOaOpeaUtua2iOaBr1xyXG4gICAgICAgICAgICAgICAgaWYgKHJldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuYXJyTXNncy5wdXNoKEpTT04uc3RyaW5naWZ5KHJldC5yZXN1bHQubWVzc2FnZSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ3NldE9uUmVjZWl2ZU1lc3NhZ2VMaXN0ZW5lciBlcnJvcjonICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBpbml0OiBpbml0Um9uZ1xyXG4gICAgfTtcclxufSlcclxuICAgIC8vIOWlveWPi+acjeWKoVxyXG4gICAgLmZhY3RvcnkoJ0ZyaWVuZHMnLCBmdW5jdGlvbiAoUmVxdWVzdFVybCwgU2lnbmFsaW5nLCBVc2VyU2VydmljZSwgJGludGVydmFsLCBMT0FEX0ZSSUVORFNfVVJMLCBIdHRwUHJvbWlzZVNlcnZpY2UpIHtcclxuICAgICAgICB2YXIgY3VycmVudFVzZXIgPSBVc2VyU2VydmljZS5nZXRVc2VyaW5mbygpO1xyXG4gICAgICAgIHZhciBsb2FkZWQgPSBmYWxzZTtcclxuICAgICAgICB2YXIgZnJpZW5kcyA9IFtdO1xyXG4gICAgICAgIHZhciB1c2VyaWRzID0gW107XHJcbiAgICAgICAgdmFyIGN1clVJRCA9ICcnO1xyXG4gICAgICAgIGZ1bmN0aW9uIGdldEZyaWVuZHMoY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHtcclxuICAgICAgICAgICAgICAgIHVzZXJuYW1lOiBjdXJyZW50VXNlci51c2VybmFtZSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgSHR0cFByb21pc2VTZXJ2aWNlLmdldERhdGEoTE9BRF9GUklFTkRTX1VSTCwgcGFyYW1zKS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGRhdGEuZnJpZW5kcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBsb2FkRGF0YShjYWxsYmFjaykge1xyXG4gICAgICAgICAgICBnZXRGcmllbmRzKGZ1bmN0aW9uIChyZXRkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBmcmllbmRzID0gW107XHJcbiAgICAgICAgICAgICAgICB2YXIgZGF0YUxlbiA9IHJldGRhdGEubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhTGVuOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqLmlkID0gcmV0ZGF0YVtpXS5faWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqLm5hbWUgPSByZXRkYXRhW2ldLm5pY2tuYW1lID09IG51bGwgPyByZXRkYXRhW2ldLnVzZXJuYW1lIDogcmV0ZGF0YVtpXS5uaWNrbmFtZTtcclxuICAgICAgICAgICAgICAgICAgICBvYmouYWxwaGEgPSBtYWtlUHkob2JqLm5hbWUpWzBdWzBdLnRvVXBwZXJDYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqLmNvbnZlcnNhdGlvblR5cGUgPSAnUFJJVkFURSc7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JqLm9ubGluZSA9ICcwJztcclxuICAgICAgICAgICAgICAgICAgICBvYmouTW9iaWxlID0gXCIyMTIzMTIzMTIyMjJcIjsvL+a1i+ivlVxyXG4gICAgICAgICAgICAgICAgICAgIG9iai5wb3J0cmFpdCA9IHJldGRhdGFbaV0uaGVhZGltZyA/IChSZXF1ZXN0VXJsICsgJ0ltYWdlcy9QaG90by8nICsgcmV0ZGF0YVtpXS5oZWFkaW1nKSA6IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgZnJpZW5kcy5wdXNoKG9iaik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyDmjInpppblrZfmr43mjpLluo9cclxuICAgICAgICAgICAgICAgIGZyaWVuZHMgPSBmcmllbmRzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYm9vbCA9IGEuYWxwaGEgPiBiLmFscGhhO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBib29sID8gMSA6IC0xO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAvLyDliKDpmaTmnKzkurpcclxuICAgICAgICAgICAgICAgIHZhciByZXRJbmRleDtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZnJpZW5kcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmcmllbmRzW2ldLmlkID09IGN1clVJRCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXRJbmRleCA9IGk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChyZXRJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZyaWVuZHMuc3BsaWNlKHJldEluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIOmmluWtl+avjee0ouW8leS9jee9ruiuoeeul1xyXG4gICAgICAgICAgICAgICAgdmFyIGZyaWVuZENvdW50ID0gZnJpZW5kcy5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICB2YXIgbm93YWxwaGEgPSAnJztcclxuICAgICAgICAgICAgICAgIHZhciBhbHBoYUNvdW50ID0gMDtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIG0gPSAwOyBtIDwgZnJpZW5kQ291bnQ7IG0rKykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSBmcmllbmRzW21dO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0bXAuYWxwaGEgIT0gbm93YWxwaGEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm93YWxwaGEgPSBvYmouYWxwaGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFscGhhQ291bnQrKztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlcmlkcy5wdXNoKHRtcC5pZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhmcmllbmRzKTtcclxuICAgICAgICAgICAgICAgIFNpZ25hbGluZy5lbWl0KCdjaGVja09ubGluZScsIHVzZXJpZHMpO1xyXG4gICAgICAgICAgICAgICAgY2hlY2tPbmxpbmVDYWxsYmFjayhjYWxsYmFjayk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDliLfmlrDlnKjnur/liJfooagoMTBzKVxyXG4gICAgICAgICRpbnRlcnZhbChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmIChsb2FkZWQpIHtcclxuICAgICAgICAgICAgICAgIFNpZ25hbGluZy5lbWl0KCdjaGVja09ubGluZScsIHVzZXJpZHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwgMTAwMDApO1xyXG4gICAgICAgIC8vIOiOt+WPluWcqOe6v+WIl+ihqFxyXG4gICAgICAgIGZ1bmN0aW9uIGNoZWNrT25saW5lQ2FsbGJhY2soY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgaWYgKCFsb2FkZWQpIHtcclxuICAgICAgICAgICAgICAgIGxvYWRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBTaWduYWxpbmcub24oJ2NoZWNrT25saW5lX3N1YycsIGZ1bmN0aW9uIChpZHMpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZnJpZW5kbGlzdENvdW50ID0gZnJpZW5kcy5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbSA9IDA7IG0gPCBmcmllbmRsaXN0Q291bnQ7IG0rKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gZnJpZW5kc1ttXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbiA9IDA7IG4gPCBpZHMubGVuZ3RoOyBuKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0bXAuaWQgPT0gaWRzW25dLmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJpZW5kc1ttXS5vbmxpbmUgPSBcIjFcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZnJpZW5kcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIC8vIOiOt+WPluWlveWPi+WIl+ihqFxyXG4gICAgICAgICAgICBhbGw6IGZ1bmN0aW9uIChjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgLy9yZXR1cm47XHJcbiAgICAgICAgICAgICAgICBpZiAoZnJpZW5kcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZnJpZW5kcyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvYWREYXRhKGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgICAgICAkaW50ZXJ2YWwoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsb2FkRGF0YShjYWxsYmFjayk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgMjAwMDApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAvLyDojrflj5bljZXkuKrlpb3lj4tcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZnJpZW5kSWQpIHtcclxuICAgICAgICAgICAgICAgIHZhciByZXRJbmRleCA9IC0xO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmllbmRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZyaWVuZHNbaV0uaWQgPT0gZnJpZW5kSWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0SW5kZXggPSBpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmV0SW5kZXggPiAtMSA/IGZyaWVuZHNbcmV0SW5kZXhdIDogbnVsbDtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgLy/vvIjmnKrlkK/nlKjvvIlcclxuICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsKSB7XHJcbiAgICAgICAgICAgICAgICBmcmllbmRzID0gdmFsO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAvL++8iOacquWQr+eUqO+8iVxyXG4gICAgICAgICAgICBhZGQ6IGZ1bmN0aW9uIChmcmllbmQpIHsgfVxyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbiAgICAvLyDmkJzlpJrnlKjmiLfmt7vliqDlpb3lj4tcclxuICAgIC5mYWN0b3J5KCdTZWFyY2hVc2VycycsIGZ1bmN0aW9uIChVc2VyU2VydmljZSwgJGludGVydmFsLCBTRUFSQ0hfRlJJRU5EU19VUkwsIEh0dHBQcm9taXNlU2VydmljZSkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGxvYWQ6IGZ1bmN0aW9uIChzdHIpIHtcclxuICAgICAgICAgICAgICAgIHZhciBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWU6IHN0clxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEh0dHBQcm9taXNlU2VydmljZS5nZXREYXRhKFNFQVJDSF9GUklFTkRTX1VSTCwgcGFyYW1zKS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbiAgICAvLyDnvqTnu4TmnI3liqFcclxuICAgIC5mYWN0b3J5KCdHcm91cHMnLCBmdW5jdGlvbiAoU2lnbmFsaW5nLCBVc2VyU2VydmljZSwgJHJvb3RTY29wZSxcclxuICAgICAgICAkaW50ZXJ2YWwsIExPQURfR1JPVVBTX1VSTCwgSHR0cFByb21pc2VTZXJ2aWNlKSB7XHJcbiAgICAgICAgdmFyIGdyb3VwcyA9IFtdO1xyXG4gICAgICAgIHZhciBjdXJVSUQgPSAnJztcclxuICAgICAgICB2YXIgY3VycmVudFVzZXIgPSBVc2VyU2VydmljZS5nZXRVc2VyaW5mbygpO1xyXG4gICAgICAgIC8vIOWQjuWPsOivt+axguaVsOaNrlxyXG4gICAgICAgIGZ1bmN0aW9uIGxvYWREYXRhKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgICAgICB1c2VybmFtZTogY3VycmVudFVzZXIudXNlcm5hbWUsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIEh0dHBQcm9taXNlU2VydmljZS5nZXREYXRhKExPQURfR1JPVVBTX1VSTCwgcGFyYW1zKS50aGVuKGZ1bmN0aW9uIChncm91cGxpc3QpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGdyb3VwbGlzdCk7XHJcbiAgICAgICAgICAgICAgICBncm91cHMgPSBbXTtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZ3JvdXBsaXN0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGdyb3VwID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXAuaWQgPSBncm91cGxpc3RbaV0uX2lkO1xyXG4gICAgICAgICAgICAgICAgICAgIGdyb3VwLm5hbWUgPSBncm91cGxpc3RbaV0uZ3JvdXBuYW1lO1xyXG4gICAgICAgICAgICAgICAgICAgIGdyb3VwLm51bWJlciA9IDEyO1xyXG4gICAgICAgICAgICAgICAgICAgIGdyb3VwLm1heF9udW1iZXIgPSAxMztcclxuICAgICAgICAgICAgICAgICAgICBncm91cC5jb252ZXJzYXRpb25UeXBlID0gJ0dST1VQJztcclxuICAgICAgICAgICAgICAgICAgICBncm91cC50eXBlID0gJ2NyZWF0ZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXAubWVtYmVycyA9IGdyb3VwbGlzdFtpXS5tZW1iZXJzO1xyXG4gICAgICAgICAgICAgICAgICAgIGdyb3Vwcy5wdXNoKGdyb3VwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNhbGxiYWNrKGdyb3VwcylcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBhbGw6IGZ1bmN0aW9uIChjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGdyb3Vwcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZ3JvdXBzKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbG9hZERhdGEoY2FsbGJhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgICRpbnRlcnZhbChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWREYXRhKGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAxMDAwMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kb24oXCJjaGFuZ2UgUHJvamVjdFwiLCBmdW5jdGlvbiAoZXZ0LCBQQ29kZSwgUE5hbWUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9hZERhdGEoY2FsbGJhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWwpIHtcclxuICAgICAgICAgICAgICAgIGdyb3VwcyA9IHZhbDtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZ3JvdXBJZCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJldEluZGV4ID0gLTE7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGdyb3Vwcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChncm91cHNbaV0uaWQgPT0gZ3JvdXBJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXRJbmRleCA9IGk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiByZXRJbmRleCA+IC0xID8gZ3JvdXBzW3JldEluZGV4XSA6IG51bGw7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIC8vIOiOt+WPlue7hOWGheaIkOWRmFxyXG4gICAgICAgICAgICBnZXRHcm91cE1lbWJlcnM6IGZ1bmN0aW9uIChncm91cElkLCBjYikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJldEluZGV4ID0gLTE7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGdyb3Vwcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChncm91cElkID09IGdyb3Vwc1tpXS5pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2IoZ3JvdXBzW2ldLm1lbWJlcnMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbiAgICAvLyDliJvlu7rnu4RcclxuICAgIC5mYWN0b3J5KCdDcmVhdGVHcm91cHMnLCBmdW5jdGlvbiAoVXNlclNlcnZpY2UsIEh0dHBQcm9taXNlU2VydmljZSwgQ1JFQVRFX0dST1VQX1VSTCkgeyAvLyDmiJDlip9cclxuICAgICAgICB2YXIgY3VycmVudFVzZXIgPSBVc2VyU2VydmljZS5nZXRVc2VyaW5mbygpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGNyZWF0ZTogZnVuY3Rpb24gKGdyb3VwKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcGFyYW1zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJpZDogY3VycmVudFVzZXIuX2lkLFxyXG4gICAgICAgICAgICAgICAgICAgIGdyb3VwbmFtZTogZ3JvdXAubmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBncm91cGltZzogJycsXHJcbiAgICAgICAgICAgICAgICAgICAgbWVtYmVyczogZ3JvdXAubWVtYmVyXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEh0dHBQcm9taXNlU2VydmljZS5nZXREYXRhKENSRUFURV9HUk9VUF9VUkwsIHBhcmFtcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KVxyXG4gICAgLy8g5Y+R6YCB5Yqg5aW95Y+L6K+35rGCXHJcbiAgICAuZmFjdG9yeSgnQWRkRnJpZW5kUmVxdWVzdCcsIGZ1bmN0aW9uIChVc2VyU2VydmljZSwgSHR0cFByb21pc2VTZXJ2aWNlLCBSRVFfRlJJRU5EX1VSTCkgeyAvLyDmiJDlip9cclxuICAgICAgICB2YXIgY3VycmVudFVzZXIgPSBVc2VyU2VydmljZS5nZXRVc2VyaW5mbygpO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uIChmcmllbmRpZCwgY2IpIHtcclxuICAgICAgICAgICAgICAgIHZhciBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdXNlcmlkOiBjdXJyZW50VXNlci5faWQsXHJcbiAgICAgICAgICAgICAgICAgICAgZnJpZW5kaWQ6IGZyaWVuZGlkXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgSHR0cFByb21pc2VTZXJ2aWNlLmdldERhdGEoUkVRX0ZSSUVORF9VUkwsIHBhcmFtcykudGhlbihmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KVxyXG4gICAgLy8g5Y+R6YCB5YWl576k6K+35rGCXHJcbiAgICAuZmFjdG9yeSgnQWRkR3JvdXBSZXF1ZXN0JywgZnVuY3Rpb24gKFVzZXJTZXJ2aWNlLCBIdHRwUHJvbWlzZVNlcnZpY2UsIFJFUV9HUk9VUF9NRU1CRVJfVVJMKSB7IC8vIOaIkOWKn1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uIChmcmllbmRpZCwgZ3JvdXBpZCwgY2IpIHtcclxuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VXNlciA9IFVzZXJTZXJ2aWNlLmdldFVzZXJpbmZvKCk7XHJcbiAgICAgICAgICAgICAgICB2YXIgcGFyYW1zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJpZDogY3VycmVudFVzZXIuX2lkLFxyXG4gICAgICAgICAgICAgICAgICAgIGZyaWVuZGlkOiBmcmllbmRpZCxcclxuICAgICAgICAgICAgICAgICAgICBncm91cGlkOiBncm91cGlkXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgSHR0cFByb21pc2VTZXJ2aWNlLmdldERhdGEoUkVRX0dST1VQX01FTUJFUl9VUkwsIHBhcmFtcykudGhlbihmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNiKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KVxyXG4gICAgLy8g5Yqg6L295aW95Y+L6K+35rGCXHJcbiAgICAuc2VydmljZShcIkZpbmRGcmllbmRzUmVxXCIsIGZ1bmN0aW9uICgkaHR0cCwgaHR0cFhociwgJGludGVydmFsLCBVc2VyU2VydmljZSwgSHR0cFByb21pc2VTZXJ2aWNlLCBMT0FEX0ZSSUVORF9SRVFVRVNUX1VSTCkge1xyXG4gICAgICAgIHZhciBmcmllbmRScXVlc3RMaXN0ID0gW107XHJcbiAgICAgICAgdmFyIGludGVydmFsaWQgPSAwO1xyXG4gICAgICAgIHZhciBjdXJyZW50VXNlciA9IFVzZXJTZXJ2aWNlLmdldFVzZXJpbmZvKCk7XHJcbiAgICAgICAgZnVuY3Rpb24gRmluZEZyaWVuZHNSZXEoY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHtcclxuICAgICAgICAgICAgICAgIHVzZXJuYW1lOiBjdXJyZW50VXNlci51c2VybmFtZSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgSHR0cFByb21pc2VTZXJ2aWNlLmdldERhdGEoTE9BRF9GUklFTkRfUkVRVUVTVF9VUkwsIHBhcmFtcykudGhlbihmdW5jdGlvbiAocmVzX2ZyaWVuZGxpc3QpIHtcclxuICAgICAgICAgICAgICAgIGZyaWVuZFJxdWVzdExpc3QgPSBbXTtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzX2ZyaWVuZGxpc3QubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmVxZnJvbSA9IHJlc19mcmllbmRsaXN0W2ldLmZyb207XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzX2ZyaWVuZGxpc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBmcmllbmRScXVlc3QgPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICBmcmllbmRScXVlc3QuaWQgPSByZXFmcm9tLl9pZDtcclxuICAgICAgICAgICAgICAgICAgICBmcmllbmRScXVlc3QubmFtZSA9IHJlcWZyb20ubmlja25hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgZnJpZW5kUnF1ZXN0LmluZm8gPSBcIltcIiArIHJlcWZyb20ubmlja25hbWUgKyBcIl1cIiArIFwi6K+35rGC5re75Yqg5oKo5Li65aW95Y+L77yBXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgZnJpZW5kUnF1ZXN0LnBvcnRyYWl0ID0gcmVxZnJvbS5oZWFkaW1nO1xyXG4gICAgICAgICAgICAgICAgICAgIGZyaWVuZFJxdWVzdC50eXBlID0gXCJQUklWQVRFXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgZnJpZW5kUnF1ZXN0TGlzdC5wdXNoKGZyaWVuZFJxdWVzdCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhmcmllbmRScXVlc3RMaXN0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YXIgZnJpZW5kc1JlcUFwaSA9IHtcclxuICAgICAgICAgICAgYWxsOiBmdW5jdGlvbiAodXNlcmlkLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZyaWVuZFJxdWVzdExpc3QubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZyaWVuZFJxdWVzdExpc3QpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBGaW5kRnJpZW5kc1JlcSh1c2VyaWQsIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGludGVydmFsaWQgPSAkaW50ZXJ2YWwoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBGaW5kRnJpZW5kc1JlcSh1c2VyaWQsIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAyMDAwMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBmcmllbmRzUmVxQXBpO1xyXG4gICAgfSlcclxuICAgIC8vIOWKoOi9veWboumYn+ivt+axglxyXG4gICAgLnNlcnZpY2UoXCJmaW5kVGVhbXNSZXFcIiwgZnVuY3Rpb24gKCRodHRwLCBodHRwWGhyLCAkaW50ZXJ2YWwsIFVzZXJTZXJ2aWNlLCBIdHRwUHJvbWlzZVNlcnZpY2UsIExPQURfR1JPVVBfUkVRVUVTVF9VUkwpIHtcclxuICAgICAgICB2YXIgdGVhbVJxdWVzdExpc3QgPSBbXTtcclxuICAgICAgICB2YXIgaW50ZXJ2YWxpZCA9IDA7XHJcbiAgICAgICAgdmFyIGN1cnJlbnRVc2VyID0gVXNlclNlcnZpY2UuZ2V0VXNlcmluZm8oKTtcclxuICAgICAgICBmdW5jdGlvbiBmaW5kVGVhbXNSZXEoY2FsbGJhY2spIHtcclxuICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHtcclxuICAgICAgICAgICAgICAgIHVzZXJuYW1lOiBjdXJyZW50VXNlci51c2VybmFtZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBIdHRwUHJvbWlzZVNlcnZpY2UuZ2V0RGF0YShMT0FEX0dST1VQX1JFUVVFU1RfVVJMLCBwYXJhbXMpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgdGVhbVJxdWVzdExpc3QgPSBbXTtcclxuICAgICAgICAgICAgICAgIHZhciBkYXRhTGVuID0gZGF0YS5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGFMZW47IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBncm91cFJxdWVzdCA9IHt9O1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wZGF0YSA9IGRhdGFbaV07XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXBScXVlc3QuaWQgPSB0ZW1wZGF0YS5ncm91cGlkLl9pZDtcclxuICAgICAgICAgICAgICAgICAgICBncm91cFJxdWVzdC5uYW1lID0gdGVtcGRhdGEuZ3JvdXBpZC5ncm91cG5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXBScXVlc3QuaW5mbyA9ICh0ZW1wZGF0YS5mcm9tLm5pY2tuYW1lID09IG51bGwgPyBcIijml6DlkI0pXCIgOiB0ZW1wZGF0YS5mcm9tLm5pY2tuYW1lKSArIFwi6YKA5oKo5Yqg5YWl576kOlwiICsgXCJbXCIgKyB0ZW1wZGF0YS5ncm91cGlkLmdyb3VwbmFtZSArIFwiXVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIGdyb3VwUnF1ZXN0LnBvcnRyYWl0ID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICBncm91cFJxdWVzdC50eXBlID0gXCJHUk9VUFwiO1xyXG4gICAgICAgICAgICAgICAgICAgIHRlYW1ScXVlc3RMaXN0LnB1c2goZ3JvdXBScXVlc3QpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2FsbGJhY2sodGVhbVJxdWVzdExpc3QpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHRlYW1zUmVxQXBpID0ge1xyXG4gICAgICAgICAgICBhbGw6IGZ1bmN0aW9uICh1c2VyaWQsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGVhbVJxdWVzdExpc3QubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRlYW1ScXVlc3RMaXN0KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmluZFRlYW1zUmVxKHVzZXJpZCwgY2FsbGJhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxpZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWxpZCA9ICRpbnRlcnZhbChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmRUZWFtc1JlcSh1c2VyaWQsIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAxMDAwMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiB0ZWFtc1JlcUFwaTtcclxuICAgIH0pXHJcbiAgICAvLyDlpb3lj4vor7fmsYLmnI3liqFcclxuICAgIC5zZXJ2aWNlKFwiUmVzRnJpZW5kXCIsIGZ1bmN0aW9uICgkaHR0cCwgaHR0cFhociwgJHRpbWVvdXQsIFVzZXJTZXJ2aWNlLCBIdHRwUHJvbWlzZVNlcnZpY2UsIFJFU19GUklFTkRfUkVRVUVTVCkge1xyXG4gICAgICAgIC8vIFVzZXJJRCDoh6rlt7FcclxuICAgICAgICAvLyBGcmllbmRJRDrmjqXmlLbkurpcclxuICAgICAgICAvLyBzdGF0ZXsw77ya5Y+R6YKA6K+377yMMTrmjqXlj5fvvIwtMe+8muaLkue7nX1cclxuICAgICAgICB2YXIgY3VycmVudFVzZXIgPSBVc2VyU2VydmljZS5nZXRVc2VyaW5mbygpO1xyXG4gICAgICAgIGZ1bmN0aW9uIFJlc0ZyaWVuZChGcmllbmRJRCwgc3RhdGUsIGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgIHZhciBwYXJhbXMgPSB7XHJcbiAgICAgICAgICAgICAgICB1c2VyaWQ6IGN1cnJlbnRVc2VyLl9pZCxcclxuICAgICAgICAgICAgICAgIGZyaWVuZGlkOiBGcmllbmRJRCxcclxuICAgICAgICAgICAgICAgIHN0YXRlOiBzdGF0ZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBIdHRwUHJvbWlzZVNlcnZpY2UuZ2V0RGF0YShSRVNfRlJJRU5EX1JFUVVFU1QsIHBhcmFtcykudGhlbihmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhkYXRhKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBSZXNGcmllbmQ7XHJcbiAgICB9KVxyXG4gICAgLy8g576k57uE6K+35rGC5pyN5YqhXHJcbiAgICAuc2VydmljZShcIlJlc1RlYW1cIiwgZnVuY3Rpb24gKCRodHRwLCBodHRwWGhyLCAkdGltZW91dCwgSHR0cFByb21pc2VTZXJ2aWNlLCBSRVNfR1JPVVBfUkVRVUVTVCkge1xyXG4gICAgICAgIC8vIGdyb3VwSUQg576k57uE5ZCN56ewXHJcbiAgICAgICAgLy8gRnJpZW5kSUQ65Y+R6LW36K+35rGC55qE5Lq6XHJcbiAgICAgICAgLy8gTWVtYmVySUQ66Ieq5bexXHJcbiAgICAgICAgLy8gc3RhdGV7MO+8muWPkemCgOivt++8jDE65o6l5Y+X77yMLTHvvJrmi5Lnu519XHJcbiAgICAgICAgZnVuY3Rpb24gUmVzVGVhbShncm91cElELCBGcmllbmRJRCwgTWVtYmVySUQsIHN0YXRlLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICB2YXIgb2JqID0geyBncm91cElEOiBncm91cElELnN1YnN0cig0KSwgTWVtYmVySUQ6IE1lbWJlcklELCBzdGF0ZTogc3RhdGUgfTtcclxuICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHtcclxuICAgICAgICAgICAgICAgIHVzZXJpZDogTWVtYmVySUQsXHJcbiAgICAgICAgICAgICAgICBmcmllbmRpZDogRnJpZW5kSUQsXHJcbiAgICAgICAgICAgICAgICBncm91cGlkOiBncm91cElELFxyXG4gICAgICAgICAgICAgICAgc3RhdGU6IHN0YXRlXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIEh0dHBQcm9taXNlU2VydmljZS5nZXREYXRhKFJFU19HUk9VUF9SRVFVRVNULCBwYXJhbXMpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnZ2VyO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XHJcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhkYXRhKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBSZXNUZWFtO1xyXG4gICAgfSlcclxuXHJcbiAgICAvLyDljY/lkIzlhajlsYDmnKror7vmtojmga/orqHnrpdcclxuICAgIC5zZXJ2aWNlKFwiY2hhdFVucmVhZE1lc3NhZ2VcIiwgZnVuY3Rpb24gKCRyb290U2NvcGUpIHtcclxuICAgICAgICB2YXIgbWVzc2FnZXMgPSAwO1xyXG4gICAgICAgIHZhciBjaGF0VW5yZWFkTWVzc2FnZXNlcnZpdmUgPSB7XHJcbiAgICAgICAgICAgIGdldFVucmVhZE1lc3NhZ2U6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBtZXNzYWdlcztcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc2V0VW5yZWFkTWVzc2FnZTogZnVuY3Rpb24gKHZhbCkge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZXMgPSB2YWw7XHJcbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLmNoYXRVbnJlYWRNZXNzYWdlTnVtID0gdmFsO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBhZGRVbnJlYWRNZXNzYWdlOiBmdW5jdGlvbiAodmFsKSB7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlcyArPSB2YWw7XHJcbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLmNoYXRVbnJlYWRNZXNzYWdlTnVtID0gbWVzc2FnZXM7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNoYXRVbnJlYWRNZXNzYWdlc2Vydml2ZTtcclxuICAgIH0pXHJcbiAgICAvLyDlhajlsYDmtojmga/nm5HlkKxcclxuICAgIC5zZXJ2aWNlKFwibmV3TWVzc2FnZUV2ZW50U2VydmljZVwiLCBmdW5jdGlvbiAoJHJvb3RTY29wZSkge1xyXG4gICAgICAgIHZhciBtc2dTZXJ2aWNlID0ge1xyXG4gICAgICAgICAgICBicm9hZGNhc3Q6IGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoXCJuZXdNc2dcIiwgZGF0YSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGxpc3RlbjogZnVuY3Rpb24gKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRvbihcIm5ld01zZ1wiLCBjYWxsYmFjayk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBtc2dTZXJ2aWNlO1xyXG4gICAgfSlcclxuICAgIC8vIOacquivu+a2iOaBr+aooeaLn++8iEZvciBQQ++8iVxyXG4gICAgLnNlcnZpY2UoXCJ1bnJlYWRNZXNzYWdlc1wiLCBmdW5jdGlvbiAoJGh0dHAsICRyb290U2NvcGUsICR0aW1lb3V0KSB7XHJcbiAgICAgICAgdmFyIHVucmVhZE1lc3NhZ2VzID0gW1xyXG4gICAgICAgICAgICB7IHVucmVhZE1lc3NhZ2VDb3VudDogMiwgbGF0ZXN0TWVzc2FnZTogJ2ZpY2wgdXBpJyB9LFxyXG4gICAgICAgIF07XHJcbiAgICAgICAgdmFyIHV0aWwgPSB7XHJcbiAgICAgICAgICAgIGdldFVucmVhZExpc3Q6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIHZhciBhcnIgPSBbe1xyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldElkOiAxMSxcclxuICAgICAgICAgICAgICAgICAgICBzZW5kZXJVc2VySWQ6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgc2VudFRpbWU6ICcyMDE2LTA2LTAxIDEwOjAwJyxcclxuICAgICAgICAgICAgICAgICAgICB1bnJlYWRNZXNzYWdlQ291bnQ6IDIsXHJcbiAgICAgICAgICAgICAgICAgICAgbGF0ZXN0TWVzc2FnZTogJ2kgYW0gYmF0MTEhJyxcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25UeXBlOiAnUFJJVkFURScsXHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uVGl0bGU6ICfpmYznlJ/kuronXHJcbiAgICAgICAgICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0SWQ6IDEyLFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbmRlclVzZXJJZDogMSxcclxuICAgICAgICAgICAgICAgICAgICBzZW50VGltZTogJzIwMTYtMDYtMDEgMTA6MDAnLFxyXG4gICAgICAgICAgICAgICAgICAgIHVucmVhZE1lc3NhZ2VDb3VudDogMixcclxuICAgICAgICAgICAgICAgICAgICBsYXRlc3RNZXNzYWdlOiAnaSBhbSBiYXQxMiEnLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvblR5cGU6ICdQUklWQVRFJyxcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25UaXRsZTogJ+mZjOeUn+S6uidcclxuICAgICAgICAgICAgICAgIH0sIHtcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRJZDogMTQsXHJcbiAgICAgICAgICAgICAgICAgICAgc2VuZGVyVXNlcklkOiAxLFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbnRUaW1lOiAnMjAxNi0wNi0wMSAxMDowMCcsXHJcbiAgICAgICAgICAgICAgICAgICAgdW5yZWFkTWVzc2FnZUNvdW50OiAyLFxyXG4gICAgICAgICAgICAgICAgICAgIGxhdGVzdE1lc3NhZ2U6ICdpIGFtIGJhdDE0IScsXHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uVHlwZTogJ1BSSVZBVEUnLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvblRpdGxlOiAn6ZmM55Sf5Lq6J1xyXG4gICAgICAgICAgICAgICAgfSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldElkOiAxMyxcclxuICAgICAgICAgICAgICAgICAgICBzZW5kZXJVc2VySWQ6IDEsXHJcbiAgICAgICAgICAgICAgICAgICAgc2VudFRpbWU6ICcyMDE2LTA2LTAxIDEwOjAwJyxcclxuICAgICAgICAgICAgICAgICAgICB1bnJlYWRNZXNzYWdlQ291bnQ6IDIsXHJcbiAgICAgICAgICAgICAgICAgICAgbGF0ZXN0TWVzc2FnZTogJ2kgYW0gYmF0MTMhJyxcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25UeXBlOiAnUFJJVkFURScsXHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uVGl0bGU6ICfpmYznlJ/kuronXHJcbiAgICAgICAgICAgICAgICB9LCB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0SWQ6IDE2LFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbmRlclVzZXJJZDogMSxcclxuICAgICAgICAgICAgICAgICAgICBzZW50VGltZTogJzIwMTYtMDYtMDEgMTA6MDAnLFxyXG4gICAgICAgICAgICAgICAgICAgIHVucmVhZE1lc3NhZ2VDb3VudDogMixcclxuICAgICAgICAgICAgICAgICAgICBsYXRlc3RNZXNzYWdlOiAnaSBhbSBiYXQhMTInLFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvblR5cGU6ICdQUklWQVRFJyxcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25UaXRsZTogJ+mZjOeUn+S6uidcclxuICAgICAgICAgICAgICAgIH0sXTtcclxuICAgICAgICAgICAgICAgIC8vIOaooeaLn+aWsOa2iOaBr1xyXG4gICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdChcIm5ld01zZ1wiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAne1widGFyZ2V0SWRcIjogMTEsIFwic2VuZGVyVXNlcklkXCI6IDEsIFwic2VudFRpbWVcIjpcIjIwMTYtMDYtMDEgMTA6MDBcIiwgJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICArICdcImNvbnRlbnRcIjoge1widGV4dFwiOlwibmV3IG1lc3NhZ2VcIn0sIFwiY29udmVyc2F0aW9uVHlwZVwiOiBcIlBSSVZBVEVcIiwgXCJvYmplY3ROYW1lXCI6IFwiUkM6VHh0TXNnXCJ9Jyk7XHJcbiAgICAgICAgICAgICAgICB9LCA0MDAwKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhcnI7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1dGlsO1xyXG4gICAgfSlcclxuICAgIC8vIOm7keWQjeWNleacjeWKoVxyXG4gICAgLmZhY3RvcnkoJ0JsYWNrbGlzdCcsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB2YXIgbGlzdHMgPSBbXHJcbiAgICAgICAgICAgIHsgaWQ6ICdncm91cDEnLCB1c2VybmFtZTogJ2dyb3VwMScsIHBvcnRyYWl0OiAnaW1nL3BlcnNvblBob3RvLnBuZycgfSxcclxuICAgICAgICBdO1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGFsbDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGxpc3RzO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWwpIHtcclxuICAgICAgICAgICAgICAgIGxpc3RzID0gdmFsO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBhZGRPbmU6IGZ1bmN0aW9uICh2YWwpIHtcclxuICAgICAgICAgICAgICAgIGxpc3RzLnB1c2godmFsKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVtb3ZlT25lOiBmdW5jdGlvbiAodmFsKSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3RzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RzW2ldLmlkID09IHZhbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsaXN0cy5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoaWQpIHtcclxuICAgICAgICAgICAgICAgIC8vIFNpbXBsZSBpbmRleCBsb29rdXBcclxuICAgICAgICAgICAgICAgIHZhciByZXRJbmRleCA9IC0xO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChsaXN0c1tpXS5pZCA9PSBpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXRJbmRleCA9IGk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiByZXRJbmRleCA+IC0xID8gbGlzdHNbcmV0SW5kZXhdIDogbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbiAgICAvLyDmoLzlvI/ljJbono3kupHplJnor69cclxuICAgIC5mYWN0b3J5KCdGb3JtYXRlUm9uZ3l1bkVycicsIGZ1bmN0aW9uIChteU5vdGUpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBmb3JtYXRlOiBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgZXJyY29kZSA9IDE7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyICYmIGVyci5jb2RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXJyY29kZSA9IGVyci5jb2RlO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlcnIgJiYgZXJyLnJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGVycmNvZGUgPSBlcnIucmVzdWx0LmNvZGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGVycmNvZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIDMwMDAxOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBteU5vdGUubXlOb3RpY2UoJ+e9kee7nOWHuueOsOmXrumimO+8jOivt+ajgOafpee9kee7nCEgMzAwMDEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAtMTAwMDA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG15Tm90ZS5teU5vdGljZSgn572R57uc5Ye6546w6Zeu6aKY77yM6K+35qOA5p+l572R57ucIS0xMDAwMCcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIC0xOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBteU5vdGUubXlOb3RpY2UoJ+WIneWni+WMluWksei0pe+8gemHjeWQr+ivleivle+8nyEgLTEnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KVxyXG4gICAgLy8g6J6N5LqR5pyN5YqhXHJcbiAgICAuZmFjdG9yeSgncm9uZ3l1blNlcnZpY2UnLCBmdW5jdGlvbiAoJHEsIEZvcm1hdGVSb25neXVuRXJyKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIOiOt+WPluWOhuWPsuaVsOaNrlxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgZ2V0Q29udmVyc2F0aW9uTGlzdDogZnVuY3Rpb24gKHRhcmdldGlkLCBjdHlwZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIG9sZGVzdE1lc3NhZ2VJZCA9IDA7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLmRlZmVyKCk7XHJcbiAgICAgICAgICAgICAgICBSb25nQ2xvdWRMaWJQbHVnaW4uZ2V0Q29udmVyc2F0aW9uTGlzdChcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmV0LCBlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKHJldCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgRm9ybWF0ZVJvbmd5dW5FcnIuZm9ybWF0ZShlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0SGlzdG9yeU1zZzogZnVuY3Rpb24gKHRhcmdldGlkLCBjdHlwZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIG9sZGVzdE1lc3NhZ2VJZCA9IDA7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLmRlZmVyKCk7XHJcbiAgICAgICAgICAgICAgICBSb25nQ2xvdWRMaWJQbHVnaW4uZ2V0SGlzdG9yeU1lc3NhZ2VzKHtcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25UeXBlOiBjdHlwZSxcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRJZDogdGFyZ2V0aWQsXHJcbiAgICAgICAgICAgICAgICAgICAgY291bnQ6IDUsXHJcbiAgICAgICAgICAgICAgICAgICAgb2xkZXN0TWVzc2FnZUlkOiBvbGRlc3RNZXNzYWdlSWRcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJldCwgZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBuZXcgQXJyYXkoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gcmV0LnJlc3VsdC5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcCA9IHJldC5yZXN1bHRbaV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gbXlVdGlsLnJlc29sdmVNc2codG1wKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0bXApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhpc0FyciA9IHJlc3VsdC5jb25jYXQoJHNjb3BlLmhpc01zZ3MpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKGhpc0Fycik7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KFwiZ2V0SGlzdG9yeU1lc3NhZ2VzIGVycm9yOiBcIiArIEpTT04uc3RyaW5naWZ5KGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc2VuZE1lc3NhZ2U6IGZ1bmN0aW9uIChjdHlwZSwgdGFyZ2V0LCBjb250ZW50KSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLmRlZmVyKCk7XHJcbiAgICAgICAgICAgICAgICBSb25nQ2xvdWRMaWJQbHVnaW4uc2VuZFRleHRNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25UeXBlOiBjdHlwZSxcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRJZDogdGFyZ2V0LFxyXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IGNvbnRlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgZXh0cmE6IFwiZXh0cmEgdGV4dFwiXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChyZXQsIGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL+a2iOaBr+atpOaXtuacquWPkemAgeaIkOWKn++8jOWPr+S7peWKoOWFpeagt+W8j+agh+aYjlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldC5zdGF0dXMgPT0gXCJwcmVwYXJlXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbGVydCgn5L2g5Y+R5LqG5paH5a2X5raI5oGv77yaJyArSlNPTi5zdHJpbmdpZnkocmV0KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKHJldC5yZXN1bHQubWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL+aIkOWKn+WQjuabtOaWsOagt+W8j1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldC5zdGF0dXMgPT0gXCJzdWNjZXNzXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbGVydChcInN1Y2Nlc3NcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoXCLlj5HpgIHmlofmnKzmtojmga8gZXJyb3I6IFwiICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBjbGVhck1lc3NhZ2VzVW5yZWFkU3RhdHVzOiBmdW5jdGlvbiAoY29udmVyc2F0aW9uVHlwZSwgdGFyZ2V0SWQpIHtcclxuICAgICAgICAgICAgICAgIHZhciBwcm9taXNlID0gJHEuZGVmZXIoKTtcclxuICAgICAgICAgICAgICAgIFJvbmdDbG91ZExpYlBsdWdpbi5jbGVhck1lc3NhZ2VzVW5yZWFkU3RhdHVzKHtcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25UeXBlOiBjb252ZXJzYXRpb25UeXBlLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldElkOiB0YXJnZXRJZFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmV0LCBlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKHJldCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KFwi5qCH5Li65bey6K+7IGVycm9yOiBcIiArIEpTT04uc3RyaW5naWZ5KGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZ2V0TGF0ZXN0TXNnOiBmdW5jdGlvbiAodGFyZ2V0aWQsIGN0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLmRlZmVyKCk7XHJcbiAgICAgICAgICAgICAgICBSb25nQ2xvdWRMaWJQbHVnaW4uZ2V0TGF0ZXN0TWVzc2FnZXMoe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvblR5cGU6IGN0eXBlLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldElkOiB0YXJnZXRpZCxcclxuICAgICAgICAgICAgICAgICAgICBjb3VudDogMTVcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJldCwgZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vYWxlcnQoXCJnZXRMYXRlc3RNZXNzYWdlcyByZXQ6XCIgKyBKU09OLnN0cmluZ2lmeShyZXQpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSByZXQucmVzdWx0Lmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG1wID0gcmV0LnJlc3VsdFtpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3R5cGUgPT0gXCJHUk9VUFwiICYmIG1lbWJlcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBtID0gMDsgbSA8IG1lbWJlcnMubGVuZ3RoOyBtKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZW1iZXJzW21dLmlkID09IHRtcC5zZW5kZXJVc2VySWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXAubmFtZSA9IG1lbWJlcnNbbV0ubmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXAgPSBteVV0aWwucmVzb2x2ZU1zZyh0bXApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIOWkhOeQhklPU+WAkuW6j+mhuuW6j2J1Z1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0lPUykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0bXApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC51bnNoaWZ0KHRtcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoXCJnZXRMYXRlc3RNZXNzYWdlcyBlcnJvcjogXCIgKyBKU09OLnN0cmluZ2lmeShlcnIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHNlbmRJbWFnZU1lc3NhZ2U6IGZ1bmN0aW9uIChjdHlwZSwgdGFyZ2V0SWQsIGltYWdlVVJJKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgaXNJT1MgPSBpb25pYy5QbGF0Zm9ybS5pc0lPUygpO1xyXG4gICAgICAgICAgICAgICAgdmFyIGlzQW5kcm9pZCA9IGlvbmljLlBsYXRmb3JtLmlzQW5kcm9pZCgpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHBpY1BhdGggPSBpbWFnZVVSSTtcclxuICAgICAgICAgICAgICAgIGlmIChpc0lPUykge1xyXG4gICAgICAgICAgICAgICAgICAgIHBpY1BhdGggPSBpbWFnZVVSSS5yZXBsYWNlKCdmaWxlOi8vJywgJycpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGlzQW5kcm9pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpbWFnZVVSSS5pbmRleE9mKCc/JykgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpY1BhdGggPSBpbWFnZVVSSS5zdWJzdHJpbmcoMCwgaW1hZ2VVUkkuaW5kZXhPZignPycpKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLmRlZmVyKCk7XHJcbiAgICAgICAgICAgICAgICBSb25nQ2xvdWRMaWJQbHVnaW4uc2VuZEltYWdlTWVzc2FnZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uVHlwZTogY3R5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0SWQ6IHRhcmdldElkLFxyXG4gICAgICAgICAgICAgICAgICAgIGltYWdlUGF0aDogcGljUGF0aCxcclxuICAgICAgICAgICAgICAgICAgICBleHRyYTogXCJcIlxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmV0LCBlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy/mtojmga/mraTml7bmnKrlj5HpgIHmiJDlip/vvIzlj6/ku6XliqDlhaXmoLflvI/moIfmmI7vvJvmiJDlip/lkI7mm7TmlrDmoLflvI9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQuc3RhdHVzID09IFwicHJlcGFyZVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWxlcnQoXCJwcmVwYXJlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UucmVzb2x2ZShyZXQucmVzdWx0Lm1lc3NhZ2UpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQuc3RhdHVzID09IFwic3VjY2Vzc1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9hbGVydChcInN1Y2Nlc3NcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoXCJzZW5kSW1hZ2VNZXNzYWdlIGVycm9yOiBcIiArIEpTT04uc3RyaW5naWZ5KGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc2VuZFZvaWNlTWVzc2FnZTogZnVuY3Rpb24gKGN0eXBlLCB0YXJnZXRJZCwgdG1wUGF0aCwgZHVyKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLmRlZmVyKCk7XHJcbiAgICAgICAgICAgICAgICAvLyDlj5HpgIHor63pn7Pmtojmga9cclxuICAgICAgICAgICAgICAgIFJvbmdDbG91ZExpYlBsdWdpbi5zZW5kVm9pY2VNZXNzYWdlKHtcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25UeXBlOiBjdHlwZSxcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRJZDogdGFyZ2V0SWQsXHJcbiAgICAgICAgICAgICAgICAgICAgdm9pY2VQYXRoOiB0bXBQYXRoLFxyXG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBkdXIsXHJcbiAgICAgICAgICAgICAgICAgICAgZXh0cmE6IFwiXCJcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJldCwgZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5sc3RSZXN1bHQgPSBcInNlbmRWb2ljZU1lc3NhZ2U6XCIgKyBKU09OLnN0cmluZ2lmeShyZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzrmtojmga/mraTml7bmnKrlj5HpgIHmiJDlip/vvIzlj6/ku6XliqDlhaXmoLflvI/moIfmmI7vvJvmiJDlip/lkI7mm7TmlrDmoLflvI9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQuc3RhdHVzID09IFwicHJlcGFyZVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWxlcnQoXCJzZW5kVm9pY2VNZXNzYWdlIHByZXBhcmUyOlwiICsgSlNPTi5zdHJpbmdpZnkocmV0KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzrlkI7nu63liqDlhaXlj5HpgIHmiJDlip/lkI7kv67mlLnmmL7npLrmoLflvI9cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQuc3RhdHVzID09IFwic3VjY2Vzc1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWxlcnQoXCJzdWNjZXNzXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHsgLy8gVE9ETzrov5nph4zpnIDopoHlr7nplJnor6/nirbmgIHov5vooYzliKTmlq3lubblj4vlpb3nmoTmj5DnpLrnlKjmiLdcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KFwi6K+t6Z+z5raI5oGv6L6T5YWl6L+H55+tISBcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2FsZXJ0KFwi6K+t6Z+z5raI5oGv5Y+R6YCB6ZSZ6K+vOiBcIiArIEpTT04uc3RyaW5naWZ5KGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgY2xlYXJDb252ZXJzaXRpb246IGZ1bmN0aW9uIChjdHlwZSwgdGFyZ2V0SWQsIHRtcFBhdGgsIGR1cikge1xyXG4gICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSAkcS5kZWZlcigpO1xyXG4gICAgICAgICAgICAgICAgUm9uZ0Nsb3VkTGliUGx1Z2luLmNsZWFyQ29udmVyc2F0aW9ucyh7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uVHlwZXM6IFtcIlBSSVZBVEVcIiwgXCJHUk9VUFwiXVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmV0LCBlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoXCLlt7LmuIXpmaTmiYDmnInkvJror506IFwiICsgcmVzdWx0LnN0YXR1cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBGb3JtYXRlUm9uZ3l1bkVyci5mb3JtYXRlKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBjbGVhck1lc3NhZ2VzVW5yZWFkU3RhdHVzOiBmdW5jdGlvbiAodGFyZ2V0aWQsIGN0eXBlKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLmRlZmVyKCk7XHJcbiAgICAgICAgICAgICAgICBSb25nQ2xvdWRMaWJQbHVnaW4uY2xlYXJNZXNzYWdlc1VucmVhZFN0YXR1cyh7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVyc2F0aW9uVHlwZTogdHlwZSxcclxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRJZDogdGFyZ2V0SWRcclxuICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChyZXQsIGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHRlc3Qgc3VjY2VlZFxyXG4gICAgICAgICAgICAgICAgICAgIHByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgRm9ybWF0ZVJvbmd5dW5FcnIuZm9ybWF0ZShlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZW1vdmVDb252ZXJzYXRpb246IGZ1bmN0aW9uICh0YXJnZXRpZCwgY3R5cGUpIHtcclxuICAgICAgICAgICAgICAgIHZhciBwcm9taXNlID0gJHEuZGVmZXIoKTtcclxuICAgICAgICAgICAgICAgIFJvbmdDbG91ZExpYlBsdWdpbi5yZW1vdmVDb252ZXJzYXRpb24oe1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnNhdGlvblR5cGU6IHR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0SWQ6IHRhcmdldElkXHJcbiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAocmV0LCBlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnJlc29sdmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAvL2FsZXJ0KHJldC5zdGF0dXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgRm9ybWF0ZVJvbmd5dW5FcnIuZm9ybWF0ZShlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSlcclxuICAgIC8vIOWqkuS9k+acjeWKoSjpn7PpopEpXHJcbiAgICAuZmFjdG9yeSgnbWVkaWFTZXJ2aWNlJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciBpc0lPUyA9IGlvbmljLlBsYXRmb3JtLmlzSU9TKCk7XHJcbiAgICAgICAgdmFyIGlzQW5kcm9pZCA9IGlvbmljLlBsYXRmb3JtLmlzQW5kcm9pZCgpO1xyXG4gICAgICAgIHZhciBtZWRpYVJlYztcclxuICAgICAgICB2YXIgcGF0aCA9IFwiXCI7XHJcbiAgICAgICAgdmFyIHNyYyA9IFwiY29yZG92YUlNVm9pY2UuYW1yXCI7XHJcbiAgICAgICAgaWYgKHdpbmRvdy5jb3Jkb3ZhICYmIGlzSU9TKSB7XHJcbiAgICAgICAgICAgIHBhdGggPSBjb3Jkb3ZhLmZpbGUuZG9jdW1lbnRzRGlyZWN0b3J5O1xyXG4gICAgICAgICAgICBzcmMgPSBcImNvcmRvdmFJTVZvaWNlLndhdlwiO1xyXG4gICAgICAgIH0gZWxzZSBpZiAod2luZG93LmNvcmRvdmEpIHtcclxuICAgICAgICAgICAgcGF0aCA9IGNvcmRvdmEuZmlsZS5leHRlcm5hbEFwcGxpY2F0aW9uU3RvcmFnZURpcmVjdG9yeTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZnVuY3Rpb24gZ2V0TWVkaWFVUkwocykge1xyXG4gICAgICAgICAgICBpZiAoZGV2aWNlLnBsYXRmb3JtLnRvTG93ZXJDYXNlKCkgPT09IFwiYW5kcm9pZFwiKSByZXR1cm4gcGF0aCArIHM7XHJcbiAgICAgICAgICAgIHJldHVybiAocGF0aCArIHMpLnJlcGxhY2UoJ2ZpbGU6Ly8nLCAnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZ1bmN0aW9uIGdldE5ld01lZGlhVVJMKHMpIHtcclxuICAgICAgICAgICAgaWYgKGRldmljZS5wbGF0Zm9ybS50b0xvd2VyQ2FzZSgpID09PSBcImFuZHJvaWRcIikgcmV0dXJuIHBhdGggKyBzO1xyXG4gICAgICAgICAgICByZXR1cm4gXCJkb2N1bWVudHM6Ly9cIiArIHM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZ1bmN0aW9uIGdldFBob25lR2FwUGF0aCgpIHtcclxuICAgICAgICAgICAgLy8gYnVnXHJcbiAgICAgICAgICAgIHZhciBwYXRoID0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lO1xyXG4gICAgICAgICAgICBwYXRoID0gcGF0aC5zdWJzdHIocGF0aCwgcGF0aC5sZW5ndGggLSA5KTtcclxuICAgICAgICAgICAgaWYgKGlzSU9TKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ2ltZy92ZWRpby1jaGF0Lm1wMyc7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvL2FsZXJ0KCdmaWxlOi8vJyArIHBhdGggKyAnaW1nL3ZlZGlvLWNoYXQubXAzJyk7Ly/ot6/lvoTmnInpl67pophcclxuICAgICAgICAgICAgICAgIHJldHVybiAnZmlsZTovLycgKyBwYXRoICsgJ2ltZy92ZWRpby1jaGF0Lm1wMyc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHBsYXlTb3VuZDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgLy/lrp7kvovljJblvZXpn7PnsbssIHNyYzrpnIDopoHmkq3mlL7nmoTlvZXpn7PnmoTot6/lvoRcclxuICAgICAgICAgICAgICAgIHZhciByaW5nID0gbmV3IE1lZGlhKGdldFBob25lR2FwUGF0aCgpLFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIC8v5byA5aeL5pKt5pS+5b2V6Z+zXHJcbiAgICAgICAgICAgICAgICByaW5nLnBsYXkoKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgc3RhcnRSZWNvcmQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGlmIChtZWRpYVJlYykge1xyXG4gICAgICAgICAgICAgICAgICAgIG1lZGlhUmVjLnJlbGVhc2UoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8v5a6e5L6L5YyW5b2V6Z+z57G7XHJcbiAgICAgICAgICAgICAgICBtZWRpYVJlYyA9IG5ldyBNZWRpYShnZXROZXdNZWRpYVVSTChzcmMpLFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsgfSxcclxuICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZXJyKSB7IH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAvL+W8gOWni+W9lemfs1xyXG4gICAgICAgICAgICAgICAgbWVkaWFSZWMuc3RhcnRSZWNvcmQoKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZmluaXNoUmVjb3JkOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLmRlZmVyKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAobWVkaWFSZWMpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZWRpYVJlYy5zdG9wUmVjb3JkKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVkaWFSZWMucmVsZWFzZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy/lrp7kvovljJblvZXpn7PnsbssIHNyYzrpnIDopoHmkq3mlL7nmoTlvZXpn7PnmoTot6/lvoRcclxuICAgICAgICAgICAgICAgIG1lZGlhUmVjID0gbmV3IE1lZGlhKGdldE1lZGlhVVJMKHNyYyksXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInRvdWNoZW5kKCk6QXVkaW8gU3VjY2Vzc1wiKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJ0b3VjaGVuZCgpOkF1ZGlvIEVycm9yOiBcIiArIGVyci5jb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgbWVkaWFSZWMucGxheSgpO1xyXG4gICAgICAgICAgICAgICAgbWVkaWFSZWMuc3RvcCgpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8v5ZyoaHRtbOS4reaYvuekuuW9k+WJjeeKtuaAgVxyXG4gICAgICAgICAgICAgICAgdmFyIGNvdW50ZXIgPSAwO1xyXG4gICAgICAgICAgICAgICAgdmFyIHRpbWVyRHVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvdW50ZXIgPSBjb3VudGVyICsgMTAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjb3VudGVyID4gMjAwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVyRHVyKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGR1ciA9IG1lZGlhUmVjLmdldER1cmF0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR1ciA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lckR1cik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFsZXJ0KCdtZWRpYVJlYy5nZXREdXJhdGlvbigpOicgKyBkdXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBhbGVydCgnbWVkaWFSZWMuc3JjOicgKyBtZWRpYVJlYy5zcmMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wUGF0aCA9IG1lZGlhUmVjLnNyYztcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzSU9TKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0bXBQYXRoID0gcGF0aCArIHNyYztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0bXBQYXRoID0gdG1wUGF0aC5yZXBsYWNlKCdmaWxlOi8vJywgJycpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9taXNlLnJlc29sdmUodG1wUGF0aCwgbWVkaWFSZWMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sIDEwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9KVxyXG4gICAgLy8gcGhvbmVydGPmnI3liqFcclxuICAgIC5mYWN0b3J5KCdwaG9uZVJUQ1NlcnZpY2UnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgY3JlYXRlU2Vzc2lvbjogZnVuY3Rpb24gKGlzSW5pdGlhdG9yKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNJbml0aWF0b3IpIHtcclxuICAgICAgICAgICAgICAgICAgICBzZW5kTWVzc2FnZSgnW+WPkei1t+inhumikemAmuivnV0nKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKG5ldyBEYXRlKCkudG9TdHJpbmcoKSArICc6IGNhbGxpbmcgdG8gJyArXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGFjdE5hbWUgKyAnLCBpc0luaXRpYXRvcjogJyArIGlzSW5pdGlhdG9yKTtcclxuICAgICAgICAgICAgICAgIC8vIOiHquS4qumDqOe9sueahOacjeWKoeWZqHR1cm4gc2VydmVyXHJcbiAgICAgICAgICAgICAgICB2YXIgY29uZmlnID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlzSW5pdGlhdG9yOiBpc0luaXRpYXRvcixcclxuICAgICAgICAgICAgICAgICAgICBzdHVuOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhvc3Q6ICdzdHVuOjExNS4yOS41MS4xOTYnXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB0dXJuOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhvc3Q6ICd0dXJuOjExNS4yOS41MS4xOTYnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogJ3Rlc3QnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXNzd29yZDogJ3Rlc3QnXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBzdHJlYW1zOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvOiB0cnVlLCAvLyDmlK/mjIHpn7PpopFcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW86IHRydWUsIC8vIOaUr+aMgeinhumikVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIHNlc3Npb24gPSBuZXcgY29yZG92YS5wbHVnaW5zLnBob25lcnRjLlNlc3Npb24oY29uZmlnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4iLCJhbmd1bGFyLm1vZHVsZSgnY2hhdC5jb250cm9sbGVycycsIFtdKVxyXG5cclxuICAgIC8qKuiBiuWkqeeVjOmdoiAqL1xyXG4gICAgLmNvbnRyb2xsZXIoJ2NvbnRhY3RzJywgZnVuY3Rpb24gKCRzY29wZSwgJHN0YXRlLFxyXG4gICAgICAgICRpb25pY1Njcm9sbERlbGVnYXRlLCAkdGltZW91dCwgJGludGVydmFsLCBGcmllbmRzLCBHcm91cHMsICRyb290U2NvcGUsXHJcbiAgICAgICAgbmV3TWVzc2FnZUV2ZW50U2VydmljZSwgRmluZEZyaWVuZHNSZXEsIGZpbmRUZWFtc1JlcSwgcm9uZ3l1blNlcnZpY2UsXHJcbiAgICAgICAgdW5yZWFkTWVzc2FnZXMsIGNoYXRVbnJlYWRNZXNzYWdlLFNpZ25hbGluZykge1xyXG4gICAgICAgIFNpZ25hbGluZy5lbWl0KCdsb2dpbicsICdjYycsICdjYycsICdjYycpO1xyXG4gICAgICAgIC8vIOagh+iusOWcqOe6v1xyXG4gICAgICAgIFNpZ25hbGluZy5vbignbG9naW5fc3VjY2Vzc2Z1bCcsIGZ1bmN0aW9uIChpbmZvKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpIGFtIGhlcmUhJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgJHNjb3BlLmRhdGEgPSB7XHJcbiAgICAgICAgICAgIHNlYXJjaHdvcmQ6ICcnXHJcbiAgICAgICAgfTtcclxuICAgICAgICAkc2NvcGUuY2xlYXJLZXl3b3JkID0gZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgZGF0YS5zY29yZWFyY2h3b3JkID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vID09PSB0YWLliIfmjaJb5raI5oGvL+iBlOezu+S6ul0gPT09XHJcbiAgICAgICAgaWYgKCEkc2NvcGUuY3VycmVudEZlZWRzVHlwZSkge1xyXG4gICAgICAgICAgICAkc2NvcGUuY3VycmVudEZlZWRzVHlwZSA9IFwiY29udGFjdHRhYlwiO1xyXG4gICAgICAgIH1cclxuICAgICAgICAkc2NvcGUubWVzc2FnZXRhYiA9IFwibWVzc2FnZXRhYlwiO1xyXG4gICAgICAgICRzY29wZS5jb250YWN0dGFiID0gXCJjb250YWN0dGFiXCI7XHJcbiAgICAgICAgdmFyIHNjcm9sbFBvc2l0b25SZWMgPSB7ICd0b3AnOiAwLCAnbGVmdCc6IDAgfTtcclxuICAgICAgICB2YXIgc2Nyb2xsUG9zaXRvbkpvYiA9IHsgJ3RvcCc6IDAsICdsZWZ0JzogMCB9O1xyXG4gICAgICAgICRzY29wZS50YWJzd2l0Y2ggPSBmdW5jdGlvbiAoZmVlZHNUeXBlKSB7XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuY3VycmVudEZlZWRzVHlwZSA9PSBcIm1lc3NhZ2V0YWJcIikge1xyXG4gICAgICAgICAgICAgICAgc2Nyb2xsUG9zaXRvblJlYyA9ICRpb25pY1Njcm9sbERlbGVnYXRlLmdldFNjcm9sbFBvc2l0aW9uKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoJHNjb3BlLmN1cnJlbnRGZWVkc1R5cGUgPT0gXCJjb250YWN0dGFiXCIpIHtcclxuICAgICAgICAgICAgICAgIHNjcm9sbFBvc2l0b25Kb2IgPSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS5nZXRTY3JvbGxQb3NpdGlvbigpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoZmVlZHNUeXBlID09IFwibWVzc2FnZXRhYlwiKSB7XHJcbiAgICAgICAgICAgICAgICAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS5zY3JvbGxUbyhzY3JvbGxQb3NpdG9uUmVjLmxlZnQsIHNjcm9sbFBvc2l0b25SZWMudG9wKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChmZWVkc1R5cGUgPT0gXCJjb250YWN0dGFiXCIpIHtcclxuICAgICAgICAgICAgICAgICRpb25pY1Njcm9sbERlbGVnYXRlLnNjcm9sbFRvKHNjcm9sbFBvc2l0b25Kb2IubGVmdCwgc2Nyb2xsUG9zaXRvbkpvYi50b3ApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAkc2NvcGUuY3VycmVudEZlZWRzVHlwZSA9IGZlZWRzVHlwZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgICRzY29wZS5ncm91cHMgPSBbXTtcclxuICAgICAgICAkc2NvcGUuZnJpZW5kc19saXN0ID0gW107XHJcbiAgICAgICAgJHNjb3BlLmZyaWVuZHNfbWVzc2FnZSA9IFtdO1xyXG4gICAgICAgIC8vIOWlveWPiy/lm6LpmJ/pgoDor7dcclxuICAgICAgICAkc2NvcGUuZnJpZW5kaW52aXRlTGlzdCA9IFtdO1xyXG4gICAgICAgICRzY29wZS5ncm91cGludml0ZUxpc3QgPSBbXTtcclxuICAgICAgICAvLyDliqDovb3lpb3lj4vliJfooahcclxuICAgICAgICAkc2NvcGUubmF2Q2hhckFycmF5ID0gW107XHJcbiAgICAgICAgRnJpZW5kcy5hbGwoZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHNfbGlzdCA9IGRhdGE7XHJcbiAgICAgICAgICAgIHZhciBhbHBoYUFyciA9IFtdO1xyXG4gICAgICAgICAgICB2YXIgYWxwaGFfbm93ID0gJyc7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGFscGhhX25vdyAhPSBkYXRhW2ldLmFscGhhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWxwaGFBcnIucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0Q2hhcjogZGF0YVtpXS5hbHBoYSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGRhdGFbaV0uaWRcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBhbHBoYV9ub3cgPSBkYXRhW2ldLmFscGhhO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICRzY29wZS5uYXZDaGFyQXJyYXkgPSBhbHBoYUFycjtcclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyDliqDovb3nvqTnu4RcclxuICAgICAgICBHcm91cHMuYWxsKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5ncm91cHMgPSBkYXRhO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIOWKoOi9veWlveWPi+mCgOivt1xyXG4gICAgICAgIEZpbmRGcmllbmRzUmVxLmFsbChmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAkc2NvcGUuZnJpZW5kaW52aXRlTGlzdCA9IGRhdGE7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICRzY29wZS5uYXZDYWxsQmFjayA9IGZ1bmN0aW9uICgpIHsgfVxyXG5cclxuICAgICAgICAvLyDliqDovb3nvqTnu4TpgoDor7dcclxuICAgICAgICBmaW5kVGVhbXNSZXEuYWxsKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5ncm91cGludml0ZUxpc3QgPSBkYXRhO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIOWQjOaEj+S4juaLkue7neivt+axgizmiJDlip/lkI7liKDmjonorrDlvZXlubbliLfmlrDlpb3lj4vliJfooahcclxuICAgICAgICBmdW5jdGlvbiByZXNwb25zZVJlcShvYmosICRpbmRleCwgdHlwZSkge1xyXG4gICAgICAgICAgICBpZiAodHlwZSA9PSBcIlBSSVZBVEVcIikge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHNfbGlzdC51bnNoaWZ0KG9iaik7XHJcbiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmZyaWVuZGludml0ZUxpc3Quc3BsaWNlKCRpbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICB9LCA0MDApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmdyb3Vwcy51bnNoaWZ0KG9iaik7XHJcbiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmdyb3VwaW52aXRlTGlzdC5zcGxpY2UoJGluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgIH0sIDQwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5re75Yqg5Zui6Zif5LiO5re75Yqg5aW95Y+LXHJcbiAgICAgICAgJHNjb3BlLmFkZEdyb3VwID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkc3RhdGUuZ28oJ3RhYi5hZGRHcm91cCcpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgJHNjb3BlLmFkZEZyaWVuZCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgJHN0YXRlLmdvKCd0YWIuYWRkRnJpZW5kJyk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8gPT09IOiejeS6kea2iOaBr+ebkeWQrCA9PT1cclxuICAgICAgICB2YXIgbmV3TXNnQ2FsbEJhY2sgPSBmdW5jdGlvbiAoZCwgZGF0YSkge1xyXG4gICAgICAgICAgICBqc29uTXNnID0gSlNPTi5wYXJzZShkYXRhKTtcclxuICAgICAgICAgICAganNvbk1zZy51bnJlYWRNZXNzYWdlQ291bnQgPSBcIjFcIjtcclxuICAgICAgICAgICAgdmFyIHRhcmdldDtcclxuICAgICAgICAgICAgdmFyIGdyb3VwTWVtYmVyaW5mbyA9IG51bGw7XHJcbiAgICAgICAgICAgIGlmIChqc29uTXNnLmNvbnZlcnNhdGlvblR5cGUgPT0gXCJQUklWQVRFXCIpIHtcclxuICAgICAgICAgICAgICAgIHZhciBmcmllbmRzID0gJHNjb3BlLmZyaWVuZHNfbGlzdDtcclxuICAgICAgICAgICAgICAgIHZhciBmcmllbmRfbnVtcyA9IGZyaWVuZHMubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmllbmRfbnVtczsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZyaWVuZHNbaV0uaWQgPT0ganNvbk1zZy50YXJnZXRJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQgPSBmcmllbmRzW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoanNvbk1zZy5jb252ZXJzYXRpb25UeXBlID09IFwiR1JPVVBcIikge1xyXG4gICAgICAgICAgICAgICAgdmFyIGdyb3VwcyA9ICRzY29wZS5ncm91cHM7XHJcbiAgICAgICAgICAgICAgICB2YXIgZ3JvdXBzX251bXMgPSBncm91cHMubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cHNfbnVtczsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdyb3Vwc1tpXS5pZCA9PSBqc29uTXNnLnRhcmdldElkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IGdyb3Vwc1tpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBNZW1iZXJpbmZvID0gR3JvdXBzLmdldEdyb3VwTWVtYmVyKGpzb25Nc2cudGFyZ2V0SWQsIGpzb25Nc2cuc2VuZGVyVXNlcklkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGpzb25Nc2cgPSBteVV0aWwucmVzb2x2ZUNvbihqc29uTXNnLCAxLCB0YXJnZXQsIGdyb3VwTWVtYmVyaW5mbyk7XHJcbiAgICAgICAgICAgIHZhciBmcmllbmRzX21lc3NhZ2UgPSAkc2NvcGUuZnJpZW5kc19tZXNzYWdlO1xyXG4gICAgICAgICAgICB2YXIgZnJpZW5kTGVuID0gZnJpZW5kc19tZXNzYWdlLmxlbmd0aDtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmllbmRMZW47IGkrKykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZyaWVuZHNfbWVzc2FnZVtpXS50YXJnZXRJZCA9PSBqc29uTXNnLnRhcmdldElkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHNfbWVzc2FnZVtpXS51bnJlYWRNZXNzYWdlQ291bnQgPSAkc2NvcGUuZnJpZW5kc19tZXNzYWdlW2ldLnVucmVhZE1lc3NhZ2VDb3VudCArIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHNfbWVzc2FnZVtpXS5sYXRlc3RNZXNzYWdlID0ganNvbk1zZy5sYXRlc3RNZXNzYWdlO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBhbGVydCgnTkVXIE1FRyBwdXNoIG5vdycpO1xyXG4gICAgICAgICAgICAkc2NvcGUuZnJpZW5kc19tZXNzYWdlLnB1c2goanNvbk1zZyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG5ld01lc3NhZ2VFdmVudFNlcnZpY2UubGlzdGVuKG5ld01zZ0NhbGxCYWNrKTtcclxuICAgICAgICAvLyDmuIXpmaTmiYDmnInkvJror51cclxuICAgICAgICAkc2NvcGUuY2xlYXJDb252ZXJzaXRpb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHJvbmd5dW5TZXJ2aWNlLmNsZWFyQ29udmVyc2F0aW9ucygpLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHNfbWVzc2FnZSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDlsIbmn5Dkurrmtojmga/orr7kuLrlt7Lor7tcclxuICAgICAgICBmdW5jdGlvbiBjbGVhclNvbWVvbmVDb252ZXJzaXRpb24odGFyZ2V0SWQsIHR5cGUpIHtcclxuICAgICAgICAgICAgcm9uZ3l1blNlcnZpY2UuY2xlYXJNZXNzYWdlc1VucmVhZFN0YXR1cyh0YXJnZXRJZCwgdHlwZSkudGhlbihmdW5jdGlvbiAoKSB7IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDlsIbmn5Dkurrmtojmga/liKDpmaRcclxuICAgICAgICBmdW5jdGlvbiByZW1vdmVTb21lb25lQ29udmVyc2l0aW9uKHRhcmdldElkLCB0eXBlKSB7XHJcbiAgICAgICAgICAgIHJvbmd5dW5TZXJ2aWNlLnJlbW92ZUNvbnZlcnNhdGlvbih0YXJnZXRJZCwgdHlwZSkudGhlbihmdW5jdGlvbiAoKSB7IH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5piv5ZCm5bey5a2Y5Zyo5raI5oGvXHJcbiAgICAgICAgZnVuY3Rpb24gZmluZEluRnJpZW5kcyh2YWwpIHtcclxuICAgICAgICAgICAgdmFyIGZyaWVuZHNfbWVzc2FnZSA9ICRzY29wZS5mcmllbmRzX21lc3NhZ2U7XHJcbiAgICAgICAgICAgIHZhciBmcmllbmRMZW4gPSBmcmllbmRzX21lc3NhZ2UubGVuZ3RoO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZyaWVuZExlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZnJpZW5kc19tZXNzYWdlW2ldLnRhcmdldElkID09IHZhbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiAtMTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOiuvuS4uuW3suivu1xyXG4gICAgICAgICRzY29wZS5tYXJrTWVzc2FnZSA9IGZ1bmN0aW9uIChpbmRleCkge1xyXG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9ICRzY29wZS5mcmllbmRzX21lc3NhZ2VbaW5kZXhdO1xyXG4gICAgICAgICAgICBjaGF0VW5yZWFkTWVzc2FnZS5hZGRVbnJlYWRNZXNzYWdlKC1tZXNzYWdlLnVucmVhZE1lc3NhZ2VDb3VudCk7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UudW5yZWFkTWVzc2FnZUNvdW50ID0gMDtcclxuICAgICAgICAgICAgY2xlYXJTb21lb25lQ29udmVyc2l0aW9uKG1lc3NhZ2UudGFyZ2V0SWQsIG1lc3NhZ2UuY29udmVyc2F0aW9uVHlwZSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICAvLyDliKDpmaTmtojmga9cclxuICAgICAgICAvLyBUT0RP77ya6ZyA6KaB5riF6Zmk5raI5oGv54q25oCB77yM5ZCm5YiZ5Yi35paw5ZCO5Lya5YaN5Ye65p2lKOW+hea1iylcclxuICAgICAgICAkc2NvcGUuZGVsZXRlTWVzc2FnZSA9IGZ1bmN0aW9uIChpbmRleCkge1xyXG4gICAgICAgICAgICB2YXIgbWVzc2FnZSA9ICRzY29wZS5mcmllbmRzX21lc3NhZ2VbaW5kZXhdO1xyXG4gICAgICAgICAgICBjaGF0VW5yZWFkTWVzc2FnZS5hZGRVbnJlYWRNZXNzYWdlKC1tZXNzYWdlLnVucmVhZE1lc3NhZ2VDb3VudCk7XHJcbiAgICAgICAgICAgICRzY29wZS5mcmllbmRzX21lc3NhZ2Uuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICAgICAgcmVtb3ZlU29tZW9uZUNvbnZlcnNpdGlvbihtZXNzYWdlLnRhcmdldElkLCBtZXNzYWdlLmNvbnZlcnNhdGlvblR5cGUpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgICRzY29wZS5nb3RvQ2hhdERldGlscyA9IGZ1bmN0aW9uIChmcmllbmQsICRpbmRleCkge1xyXG4gICAgICAgICAgICAvLyDmuIXnqbrmnKror7vmtojmga9cclxuICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHNfbWVzc2FnZVskaW5kZXhdLnVucmVhZE1lc3NhZ2VDb3VudCA9IDA7XHJcbiAgICAgICAgICAgIHZhciB0YXJnZXQ7XHJcbiAgICAgICAgICAgIGlmIChmcmllbmQuY29udmVyc2F0aW9uVHlwZSA9PSBcIlBSSVZBVEVcIikge1xyXG4gICAgICAgICAgICAgICAgdmFyIGZyaWVuZHMgPSAkc2NvcGUuZnJpZW5kc19saXN0O1xyXG4gICAgICAgICAgICAgICAgdmFyIGZyaWVuZF9udW1zID0gZnJpZW5kcy5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZyaWVuZF9udW1zOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZnJpZW5kc1tpXS5pZCA9PSBmcmllbmQudGFyZ2V0SWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gZnJpZW5kc1tpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZyaWVuZC5jb252ZXJzYXRpb25UeXBlID09IFwiR1JPVVBcIikge1xyXG4gICAgICAgICAgICAgICAgdmFyIGdyb3VwcyA9ICRzY29wZS5ncm91cHM7XHJcbiAgICAgICAgICAgICAgICB2YXIgZ3JvdXBzX251bXMgPSBncm91cHMubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cHNfbnVtczsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdyb3Vwc1tpXS5pZCA9PSBmcmllbmQudGFyZ2V0SWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gZ3JvdXBzW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8g6L2s5Yiw6IGK5aSp5Li755WM6Z2iXHJcbiAgICAgICAgICAgIHZhciBuYW1lID0gdGFyZ2V0ID8gdGFyZ2V0Lm5hbWUgOiAnW+mZjOeUn+S6ul0nO1xyXG4gICAgICAgICAgICAkc3RhdGUuZ28oXCJ0YWIuY2hhdERldGFpbFwiLCB7IHRhcmdldElkOiBmcmllbmQudGFyZ2V0SWQsIG5hbWU6IG5hbWUsIGNvbnZlcnNhdGlvblR5cGU6IGZyaWVuZC5jb252ZXJzYXRpb25UeXBlIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDojrflj5bmtojmga/liJfooahcclxuICAgICAgICB2YXIgZ2V0Q29udmVyc2F0aW9uTGlzdCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcm9uZ3l1blNlcnZpY2UuZ2V0Q29udmVyc2F0aW9uTGlzdCgpLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdExlbiA9IHJlc3VsdC5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0O1xyXG4gICAgICAgICAgICAgICAgdmFyIGdyb3VwTWVtYmVyaW5mbyA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3VsdExlbjsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdFtpXS5jb252ZXJzYXRpb25UeXBlID09IFwiUFJJVkFURVwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IEZyaWVuZHMuZ2V0KHJlc3VsdFtpXS50YXJnZXRJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXN1bHRbaV0uY29udmVyc2F0aW9uVHlwZSA9PSBcIkdST1VQXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gR3JvdXBzLmdldChyZXN1bHRbaV0udGFyZ2V0SWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBNZW1iZXJpbmZvID0gR3JvdXBzLmdldEdyb3VwTWVtYmVyKHJlc3VsdFtpXS50YXJnZXRJZCwgcmVzdWx0W2ldLnNlbmRlclVzZXJJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KCdncm91cE1lbWJlcmluZm8gZXJyOicgKyBKU09OLnN0cmluZ2lmeShlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXN1bHRbaV0gPSBteVV0aWwucmVzb2x2ZUNvbihyZXN1bHRbaV0sIDAsIHRhcmdldCwgZ3JvdXBNZW1iZXJpbmZvKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlTGVuID0gMDtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcmVzdWx0TGVuOyBqKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBmaW5kSW5GcmllbmRzKHJlc3VsdFtqXS50YXJnZXRJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5mcmllbmRzX21lc3NhZ2UucHVzaChyZXN1bHRbal0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlTGVuICs9IHJlc3VsdFtqXS51bnJlYWRNZXNzYWdlQ291bnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHNfbWVzc2FnZVtpbmRleF0udW5yZWFkTWVzc2FnZUNvdW50ID0gcmVzdWx0W2pdLnVucmVhZE1lc3NhZ2VDb3VudDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHNfbWVzc2FnZVtpbmRleF0ubGF0ZXN0TWVzc2FnZSA9IHJlc3VsdFtqXS5sYXRlc3RNZXNzYWdlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlTGVuICs9IHJlc3VsdFtqXS51bnJlYWRNZXNzYWdlQ291bnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2hhdFVucmVhZE1lc3NhZ2Uuc2V0VW5yZWFkTWVzc2FnZShtZXNzYWdlTGVuKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOiejeS6keWIneWni+WMllxyXG4gICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkc2NvcGUuZnJpZW5kc19tZXNzYWdlID0gW107XHJcbiAgICAgICAgICAgIC8vIFRPRE8656uL5Y2z5Yqg6L295Zyo5L+h5oGv6IGU57O75Lq65pyq5Yqg6L295a6M5oiQ55qE5oOF5Ya15LiL5aSx5pWIXHJcbiAgICAgICAgICAgIC8vIGdldENvbnZlcnNhdGlvbkxpc3QoKTtcclxuICAgICAgICAgICAgJGludGVydmFsKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGdldENvbnZlcnNhdGlvbkxpc3QoKTtcclxuICAgICAgICAgICAgfSwgMzAwMCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL2luaXQoKTtcclxuXHJcbiAgICAgICAgaW5pdFRlc3QoKTtcclxuICAgICAgICBmdW5jdGlvbiBpbml0VGVzdCgpIHtcclxuICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHNfbWVzc2FnZSA9IFtdO1xyXG4gICAgICAgICAgICB2YXIgbWVzc2FnZUxlbiA9IDA7XHJcbiAgICAgICAgICAgICRpbnRlcnZhbChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbXMgPSB1bnJlYWRNZXNzYWdlcy5nZXRVbnJlYWRMaXN0KCk7XHJcbiAgICAgICAgICAgICAgICBtcyA9IG15VXRpbC5yZXNvbHZlQ29uKG1zLCAwLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIHZhciBtc0xlbiA9IG1zLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2VMZW4gPSAwO1xyXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBtc0xlbjsgaisrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gZmluZEluRnJpZW5kcyhtc1tqXS50YXJnZXRJZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VMZW4gKz0gbXNbal0udW5yZWFkTWVzc2FnZUNvdW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuZnJpZW5kc19tZXNzYWdlLnB1c2gobXNbal0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5mcmllbmRzX21lc3NhZ2VbaW5kZXhdLnVucmVhZE1lc3NhZ2VDb3VudCA9IG1zW2pdLnVucmVhZE1lc3NhZ2VDb3VudDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZUxlbiArPSBtc1tqXS51bnJlYWRNZXNzYWdlQ291bnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5mcmllbmRzX21lc3NhZ2VbaW5kZXhdLmxhdGVzdE1lc3NhZ2UgPSBtc1tqXS5sYXRlc3RNZXNzYWdlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNoYXRVbnJlYWRNZXNzYWdlLnNldFVucmVhZE1lc3NhZ2UobWVzc2FnZUxlbik7XHJcbiAgICAgICAgICAgIH0sIDEwMDAwKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuIiwiYW5ndWxhci5tb2R1bGUoJ2NoYXQuY29udHJvbGxlcnMnKVxyXG4gICAgLmNvbnRyb2xsZXIoJ2FkZEZyaWVuZEN0cmwnLCBmdW5jdGlvbiAoJHNjb3BlLCBTZWFyY2hVc2VycywgQWRkRnJpZW5kUmVxdWVzdCkge1xyXG4gICAgICAgICRzY29wZS5mcmllbmRSZXN1bHRzID0gW107XHJcbiAgICAgICAgJHNjb3BlLnVzZXJuYW1lID0gJyc7XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIOebkea1i+aQnOe0ouWQjeensFxyXG4gICAgICAgICAqL1xyXG4gICAgICAgICRzY29wZS4kd2F0Y2goJ3VzZXJuYW1lJywgZnVuY3Rpb24gKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAobmV3VmFsdWUgIT0gXCJcIiAmJiBuZXdWYWx1ZSAhPSBvbGRWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoKG5ld1ZhbHVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvKlxyXG4gICAgICAgICog5riF56m66L6T5YWlXHJcbiAgICAgICAgKi9cclxuICAgICAgICAkc2NvcGUuc2VhcmNoQ2xlYXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICRzY29wZS51c2VybmFtZSA9ICcnO1xyXG4gICAgICAgICAgICAkc2NvcGUuZnJpZW5kUmVzdWx0cyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBzZWFyY2gobmFtZSkge1xyXG4gICAgICAgICAgICBTZWFyY2hVc2Vycy5sb2FkKG5hbWUpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIHZhciByZXQgPSBbXTtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmlja25hbWU6IGRhdGFbaV0ubmlja25hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9pZDogZGF0YVtpXS5faWRcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICRzY29wZS5mcmllbmRSZXN1bHRzID0gcmV0O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKlxyXG4gICAgICAgICog5Y+R6LW35re75Yqg5aW95Y+L6K+35rGCXHJcbiAgICAgICAgKi9cclxuICAgICAgICAkc2NvcGUuYWRkID0gZnVuY3Rpb24gKEZyaWVuZElEKSB7XHJcbiAgICAgICAgICBcclxuICAgICAgICAgICAgLy9BZGRGcmllbmRSZXF1ZXN0KEZyaWVuZElELGZ1bmN0aW9uKGRhdGEpe30pO1xyXG4gICAgICAgIH07XHJcbiAgICB9KTsiLCJhbmd1bGFyLm1vZHVsZSgnY2hhdC5jb250cm9sbGVycycpXHJcbiAgICAuY29udHJvbGxlcignYWRkR3JvdXBDdHJsJywgZnVuY3Rpb24gKCRzY29wZSwgJGlvbmljUG9wdXAsIEh0dHBGYWN0b3J5LFxyXG4gICAgICAgICRpb25pY0hpc3RvcnksICRjb3Jkb3ZhQ29udGFjdHMsIG15Tm90ZSwgJHRpbWVvdXQsIEZyaWVuZHMsIENyZWF0ZUdyb3Vwcykge1xyXG4gICAgICAgICRzY29wZS5ncm91cCA9IHt9O1xyXG4gICAgICAgIHZhciBteVBvcHVwID0gJGlvbmljUG9wdXAuc2hvdyh7XHJcbiAgICAgICAgICAgIHRlbXBsYXRlOiAnPGlucHV0IHR5cGU9XCJ0ZXh0XCIgbmctbW9kZWw9XCJncm91cC5uYW1lXCI+JyxcclxuICAgICAgICAgICAgdGl0bGU6ICfovpPlhaXnu4TlkI3vvJonLFxyXG4gICAgICAgICAgICBzY29wZTogJHNjb3BlLFxyXG4gICAgICAgICAgICBidXR0b25zOiBbe1xyXG4gICAgICAgICAgICAgICAgdGV4dDogJ+WPlua2iCcsXHJcbiAgICAgICAgICAgICAgICBvblRhcDogZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAkaW9uaWNIaXN0b3J5LmdvQmFjaygtMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIHtcclxuICAgICAgICAgICAgICAgIHRleHQ6ICc8Yj7kv53lrZg8L2I+JyxcclxuICAgICAgICAgICAgICAgIHR5cGU6ICdidXR0b24tcG9zaXRpdmUnLFxyXG4gICAgICAgICAgICAgICAgb25UYXA6IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEkc2NvcGUuZ3JvdXAubmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBteU5vdGUubXlOb3RpY2UoJ+e7hOWQjeS4jeiDveS4uuepuu+8gScsIDMwMDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF1cclxuICAgICAgICB9KTtcclxuICAgICAgICBteVBvcHVwLnRoZW4oZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBteVBvcHVwLmNsb3NlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgRnJpZW5kcy5hbGwoZnVuY3Rpb24gKGZyaWVuZHMpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmllbmRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBmcmllbmRzW2ldLmNoZWNrZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPSBmcmllbmRzO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkc2NvcGUuc3VyZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCIkc2NvcGUuZnJpZW5kczpcIiwgJHNjb3BlLmZyaWVuZHMpO1xyXG4gICAgICAgICAgICAkc2NvcGUuZ3JvdXAubWVtYmVyID0gW107XHJcbiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCgkc2NvcGUuZnJpZW5kcywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGlmICghIWRhdGEuY2hlY2tlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS5ncm91cC5tZW1iZXIucHVzaChkYXRhLmlkKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGNyZWF0ZWdyb3VwKCRzY29wZS5ncm91cCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gY3JlYXRlZ3JvdXAodGVhbSkge1xyXG4gICAgICAgICAgICBDcmVhdGVHcm91cHMuY3JlYXRlKHRlYW0pLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgaWYoZGF0YS5zdGF0ZSA9PSAtMSl7XHJcbiAgICAgICAgICAgICAgICAgICAgYWxlcnQoXCLliJvlu7rlpLHotKXvvIFcIik7XHJcbiAgICAgICAgICAgICAgICB9ZWxzZSBpZihkYXRhLnN0YXRlID0gMSl7XHJcbiAgICAgICAgICAgICAgICAgICAgYWxlcnQoXCLliJvlu7rmiJDlip/vvIFcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAkaW9uaWNIaXN0b3J5LmdvQmFjaygtMSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICog5LuO6YCa6K6v5b2V5Lit6I635Y+W5aW95Y+LIChUT0RPKVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgICRzY29wZS5nZXRBbGxDb250YWN0cyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7fTtcclxuICAgICAgICAgICAgb3B0aW9ucy5tdWx0aXBsZSA9IHRydWU7XHJcbiAgICAgICAgICAgICRjb3Jkb3ZhQ29udGFjdHMuZmluZChvcHRpb25zKS50aGVuKGZ1bmN0aW9uIChhbGxDb250YWN0cykge1xyXG4gICAgICAgICAgICAgICAgLy8gb21pdHRpbmcgcGFyYW1ldGVyIHRvIC5maW5kKCkgY2F1c2VzIGFsbCBjb250YWN0cyB0byBiZSByZXR1cm5lZFxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmNvbnRhY3RzID0gYWxsQ29udGFjdHM7XHJcbiAgICAgICAgICAgICAgICBhbGVydChhbmd1bGFyLnRvSnNvbigkc2NvcGUuY29udGFjdHNbMF0pKTtcclxuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgICAgICAgICAgYWxlcnQoZXJyKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH0pOyIsImFuZ3VsYXIubW9kdWxlKCdjaGF0LmNvbnRyb2xsZXJzJylcclxuICAgIC5jb250cm9sbGVyKCdjaGF0RGV0YWlsJywgZnVuY3Rpb24gKCRzY29wZSwgJHJvb3RTY29wZSwgJHN0YXRlUGFyYW1zLCBuZXdNZXNzYWdlRXZlbnRTZXJ2aWNlLCBDYWNoZUZhY3RvcnksXHJcbiAgICAgICAgJGlvbmljU2Nyb2xsRGVsZWdhdGUsICR0aW1lb3V0LCAkc3RhdGUsIEZyaWVuZHMsIEdyb3VwcywgJGludGVydmFsLCAkaW9uaWNNb2RhbCwgUGhvdG9BbmRJbWFnZXMsXHJcbiAgICAgICAgcm9uZ3l1blNlcnZpY2UsIG1lZGlhU2VydmljZSkge1xyXG4gICAgICAgIHZhciB2aWV3U2Nyb2xsID0gJGlvbmljU2Nyb2xsRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdtZXNzYWdlRGV0YWlsc1Njcm9sbCcpO1xyXG4gICAgICAgIC8qKipcclxuICAgICAgICAgKiBidWdmaXggcHVycG9zZVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgICRzY29wZS5maXhSZWZsb3d0YWcgPSBmYWxzZTtcclxuICAgICAgICB2YXIgdGFyZ2V0SWQgPSAkc3RhdGVQYXJhbXMudGFyZ2V0SWQ7XHJcbiAgICAgICAgdmFyIGNvbnZlcnNhdGlvblR5cGUgPSAkc3RhdGVQYXJhbXMuY29udmVyc2F0aW9uVHlwZTtcclxuICAgICAgICAkc2NvcGUubmFtZSA9ICRzdGF0ZVBhcmFtcy5uYW1lID8gJHN0YXRlUGFyYW1zLm5hbWUgOiBcIlwiO1xyXG4gICAgICAgICRzY29wZS5jb252ZXJzYXRpb25UeXBlID0gY29udmVyc2F0aW9uVHlwZTtcclxuICAgICAgICAvLyDliqDovb3miJDlkZjvvIznlKjkuo7mmL7npLrlp5PlkI1cclxuICAgICAgICBpZiAoJHNjb3BlLmNvbnZlcnNhdGlvblR5cGUgPT0gXCJHUk9VUFwiKSB7XHJcbiAgICAgICAgICAgIGdldEdyb3VwTWVtKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBtZW1iZXJzID0gW107XHJcbiAgICAgICAgZnVuY3Rpb24gZ2V0R3JvdXBNZW0oKSB7XHJcbiAgICAgICAgICAgIGlmICh0YXJnZXRJZCAmJiB0YXJnZXRJZC5zdWJzdHIoMCwgNCkgPT0gXCJjcmVfXCIpIHtcclxuICAgICAgICAgICAgICAgIGdldEdyb3VwTWVtYmVycyh0YXJnZXRJZC5zdWJzdHIoNCksIGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGRhdGEuZGF0YTtcclxuICAgICAgICAgICAgICAgIHZhciBsZW5ndGggPSBkYXRhLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBvYmogPSB7fTtcclxuICAgICAgICAgICAgICAgICAgICBvYmouaWQgPSBkYXRhW2ldLlVzZXJJRDtcclxuICAgICAgICAgICAgICAgICAgICBvYmoubmFtZSA9IGRhdGFbaV0uVXNlck5hbWU7XHJcbiAgICAgICAgICAgICAgICAgICAgbWVtYmVycy5wdXNoKG9iaik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBnZXRMYXRlc3RNc2codGFyZ2V0SWQsIFwiR1JPVVBcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOivremfs+a2iOaBr+S6pOS6kihCRUdJTilcclxuICAgICAgICAkc2NvcGUucmVjb3JkV2FpdCA9IGZhbHNlO1xyXG4gICAgICAgICRzY29wZS5pc1N0YXJ0UmVjb3JkID0gZmFsc2U7XHJcbiAgICAgICAgJHNjb3BlLm9uVm9pY2VIb2xkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAkc2NvcGUuaXNTdGFydFJlY29yZCA9IHRydWU7XHJcbiAgICAgICAgICAgICRzY29wZS5yZWNvcmRXYWl0ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAvL+WunuS+i+WMluW9lemfs+exu1xyXG4gICAgICAgICAgICAgICAgVm9pY2VjaGFuZ2VBbmltYXRpb24oKTtcclxuICAgICAgICAgICAgICAgIG1lZGlhU2VydmljZS5zdGFydFJlY29yZCgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgICAgICAgIGRpYWxvZy5zaG93KCdlcnIgbTonICsgZXJyKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgICRzY29wZS5vblZvaWNlUmVsZWFzZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgJHNjb3BlLnJlY29yZFdhaXQgPSB0cnVlO1xyXG4gICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuaXNTdGFydFJlY29yZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9LCAxMDAwKTtcclxuICAgICAgICAgICAgbWVkaWFTZXJ2aWNlLmZpbmlzaFJlY29yZCgpLnRoZW4oZnVuY3Rpb24gKHRtcFBhdGgsIG1lZGlhUmVjKSB7XHJcbiAgICAgICAgICAgICAgICByb25neXVuU2VydmljZS5zZW5kVm9pY2VNZXNzYWdlKGNvbnZlcnNhdGlvblR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0SWQsIHRtcFBhdGgsIGR1cikudGhlbihmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZWRpYVJlYy5yZWxlYXNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcGVuZE5ld01zZyhkYXRhLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gIOW3peWFt+agj+S6pOS6klxyXG4gICAgICAgICRzY29wZS5zZW5kX2NvbnRlbnQgPSB7XHJcbiAgICAgICAgICAgIHRleHQ6ICcnXHJcbiAgICAgICAgfTtcclxuICAgICAgICAkc2NvcGUuc2hvd1Bob25lYmFyID0gZmFsc2U7XHJcbiAgICAgICAgJHNjb3BlLm9uU2hvd1Bob25lYmFyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoISRzY29wZS5zaG93UGhvbmViYXIpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5zaG93UGhvbmViYXIgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dXWEZhY2UgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHNjcm9sbHRvQm90dG9tKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoJHNjb3BlLnNob3dQaG9uZWJhciAmJiAkc2NvcGUuc2hvd1dYRmFjZSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dXWEZhY2UgPSBmYWxzZTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICgkc2NvcGUuc2hvd1Bob25lYmFyICYmICEkc2NvcGUuc2hvd1dYRmFjZSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLnNob3dQaG9uZWJhciA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgICRzY29wZS5zaG93V1hGYWNlID0gZmFsc2U7XHJcbiAgICAgICAgJHNjb3BlLm9uU2hvd1dYRmFjZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKCEkc2NvcGUuc2hvd1Bob25lYmFyKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd1Bob25lYmFyID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICRzY29wZS5zaG93V1hGYWNlID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHNjcm9sbHRvQm90dG9tKCk7XHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3RleHRfY29udGVudFwiKS5mb2N1cygpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKCRzY29wZS5zaG93UGhvbmViYXIgJiYgISRzY29wZS5zaG93V1hGYWNlKSB7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2hvd1dYRmFjZSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3RleHRfY29udGVudFwiKS5mb2N1cygpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKCRzY29wZS5zaG93UGhvbmViYXIgJiYgJHNjb3BlLnNob3dXWEZhY2UpIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5zaG93UGhvbmViYXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICRzY29wZS5zaG93V1hGYWNlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgJHNjb3BlLnNlbGVjdFFRRmFjZSA9IGZ1bmN0aW9uICh0ZXh0X2NvbnRlbnQpIHtcclxuICAgICAgICAgICAgJHNjb3BlLnNlbmRfY29udGVudC50ZXh0ID0gJHNjb3BlLnNlbmRfY29udGVudC50ZXh0ICsgdGV4dF9jb250ZW50O1xyXG4gICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3RleHRfY29udGVudFwiKS5mb2N1cygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDmi4nlj5bljoblj7Lmtojmga9cclxuICAgICAgICAkc2NvcGUuZG9SZWZyZXNoID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnUmVmcmVzaGluZyEnKTtcclxuICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgLy8g5ouJ5Y+W5Y6G5Y+y5raI5oGvXHJcbiAgICAgICAgICAgICAgICByb25neXVuU2VydmljZS5nZXRIaXN0b3J5TXNnKHRhcmdldElkLCBjb252ZXJzYXRpb25UeXBlKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5oaXNNc2dzID0gZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICRzY29wZS4kYnJvYWRjYXN0KCdzY3JvbGwucmVmcmVzaENvbXBsZXRlJyk7XHJcbiAgICAgICAgICAgIH0sIDIwMCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICAkc2NvcGUub25TZW5kVGV4dE1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBtZXNzYWdlID0gJHNjb3BlLnNlbmRfY29udGVudC50ZXh0O1xyXG4gICAgICAgICAgICBzZW5kTWVzc2FnZShjb252ZXJzYXRpb25UeXBlLCB0YXJnZXRJZCwgbWVzc2FnZSk7XHJcbiAgICAgICAgICAgICRzY29wZS5zZW5kX2NvbnRlbnQudGV4dCA9ICcnO1xyXG4gICAgICAgICAgICBzY3JvbGx0b0JvdHRvbSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAkc2NvcGUuaGlzTXNncyA9IFtdO1xyXG4gICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoY29udmVyc2F0aW9uVHlwZSA9PSAnUFJJVkFURScpIHtcclxuICAgICAgICAgICAgICAgIGdldExhdGVzdE1zZyh0YXJnZXRJZCwgJ1BSSVZBVEUnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjbGVhck1lc3NhZ2VzVW5yZWFkU3RhdHVzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vaW5pdCgpO1xyXG5cclxuICAgICAgICAvLyA9PT0gIOiejeS6kea2iOaBr+WkhOeQhihCRUdJTikgPT09XHJcbiAgICAgICAgLy8g5Y+R6YCB5paH5pys5raI5oGvXHJcbiAgICAgICAgZnVuY3Rpb24gc2VuZE1lc3NhZ2UoY3R5cGUsIHRhcmdldCwgY29udGVudCkge1xyXG4gICAgICAgICAgICByb25neXVuU2VydmljZS5zZW5kTWVzc2FnZShjdHlwZSwgdGFyZ2V0LCBjb250ZW50KS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBhcHBlbmROZXdNc2coZGF0YSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOagh+S4uuW3suivu1xyXG4gICAgICAgIGZ1bmN0aW9uIGNsZWFyTWVzc2FnZXNVbnJlYWRTdGF0dXMoKSB7XHJcbiAgICAgICAgICAgIHZhciBjdHlwZSA9IGNvbnZlcnNhdGlvblR5cGU7XHJcbiAgICAgICAgICAgIHZhciB0YXJnZXRpZCA9IHRhcmdldElkO1xyXG4gICAgICAgICAgICByb25neXVuU2VydmljZS5jbGVhck1lc3NhZ2VzVW5yZWFkU3RhdHVzKGN0eXBlLCB0YXJnZXQpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOiOt+WPluacgOaWsOa2iOaBr1xyXG4gICAgICAgIGZ1bmN0aW9uIGdldExhdGVzdE1zZyh0YXJnZXRpZCwgY3R5cGUpIHtcclxuICAgICAgICAgICAgcm9uZ3l1blNlcnZpY2UuZ2V0TGF0ZXN0TXNnKHRhcmdldGlkLCBjdHlwZSkudGhlbihmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmhpc01zZ3MgPSByZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICBzY3JvbGx0b0JvdHRvbSgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgJHNjb3BlLnNlbmRQaG90byA9IHNlbmRQaG90bztcclxuICAgICAgICAvLyDlj5HpgIHlm77niYcoY2hhdHRvb2xiYXLlj5HotbcpXHJcbiAgICAgICAgZnVuY3Rpb24gc2VuZFBob3RvKGltYWdlVVJJKSB7XHJcbiAgICAgICAgICAgIHJvbmd5dW5TZXJ2aWNlLnNlbmRJbWFnZU1lc3NhZ2UoY29udmVyc2F0aW9uVHlwZSwgdGFyZ2V0SWQsIGltYWdlVVJJKS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBhcHBlbmROZXdNc2coZGF0YSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgLy8gPT09ICDono3kupHmtojmga/lpITnkIYoRU5EKSA9PT1cclxuXHJcbiAgICAgICAgLy8g5rua5Yqo6Iez5bqV6YOoKOaciWJ1ZylcclxuICAgICAgICBmdW5jdGlvbiBzY3JvbGx0b0JvdHRvbSgpIHtcclxuICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdmlld1Njcm9sbC5zY3JvbGxCb3R0b20odHJ1ZSk7XHJcbiAgICAgICAgICAgIH0sIDUwKTtcclxuICAgICAgICAgICAgJHNjb3BlLmZpeFJlZmxvd3RhZyA9ICEkc2NvcGUuZml4UmVmbG93dGFnO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5re75Yqg5paw5raI5oGvXHJcbiAgICAgICAgZnVuY3Rpb24gYXBwZW5kTmV3TXNnKG1zZywgZmxhZykge1xyXG4gICAgICAgICAgICB2YXIgY3VyTXNnID0gbXlVdGlsLnJlc29sdmVNc2cobXNnKTtcclxuICAgICAgICAgICAgJHNjb3BlLmhpc01zZ3MucHVzaChjdXJNc2cpO1xyXG4gICAgICAgICAgICBzY3JvbGx0b0JvdHRvbSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5qih5ouf5aOw6Z+z5aSn5bCP5Y+Y5YyWXHJcbiAgICAgICAgJHNjb3BlLnZvaWNlSW1nID0geyB1cmw6ICdhc3NldHMvaW1nL3ZvaWNlL3JlY29nMDAwLnBuZycgfTtcclxuICAgICAgICBmdW5jdGlvbiBWb2ljZWNoYW5nZUFuaW1hdGlvbigpIHtcclxuICAgICAgICAgICAgdmFyIHZvaWNlY2hhbmdlID0gJGludGVydmFsKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIGlmICghJHNjb3BlLnJlY29yZFdhaXQpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIDkpO1xyXG4gICAgICAgICAgICAgICAgICAgICRzY29wZS52b2ljZUltZy51cmwgPSAnaW1nL3ZvaWNlL3JlY29nMDAnICsgaSArICcucG5nJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdm9pY2VjaGFuZ2UgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIDQwMCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOinhumikemAmuivnVxyXG4gICAgICAgICRzY29wZS5vblZvaWNlQ2FsbCA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgLy9hbGVydCgnY2hhdGRldGlhbDonICsgdGFyZ2V0SWQpO1xyXG4gICAgICAgICAgICB2YXIgb2JqID0geyBpc0NhbGxpbmc6IHRydWUsIGNvbnRhY3ROYW1lOiB0YXJnZXRJZCB9O1xyXG4gICAgICAgICAgICAkc3RhdGUuZ28oJ3RhYi5jYWxsJywgb2JqKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgJHNjb3BlLm9uVmVkaW9DYWxsID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAvL2FsZXJ0KCdjaGF0ZGV0aWFsOicgKyB0YXJnZXRJZCk7XHJcbiAgICAgICAgICAgIHZhciBvYmogPSB7IGlzQ2FsbGluZzogdHJ1ZSwgY29udGFjdE5hbWU6IHRhcmdldElkIH07XHJcbiAgICAgICAgICAgICRzdGF0ZS5nbygndGFiLmNhbGwnLCBvYmopO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDliJ3mrKHliqDovb1cclxuICAgICAgICAkc2NvcGUuJG9uKFwiJGlvbmljVmlldy5lbnRlclwiLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHNjcm9sbHRvQm90dG9tKCk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjaGF0ZGV0aWFsLmVudGVyJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJuYXRpdmUua2V5Ym9hcmRzaG93XCIsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIHNjcm9sbHRvQm90dG9tKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOebkeWQrOa2iOaBr+WPkemAgeS6i+S7tijlrp7ml7bliLfmlrDmtojmga8pXHJcbiAgICAgICAgdmFyIG5ld01zZ0NhbGxCYWNrID0gZnVuY3Rpb24gKGQsIGRhdGEpIHtcclxuICAgICAgICAgICAgdmFyIGpzb25Nc2cgPSBKU09OLnBhcnNlKGRhdGEpO1xyXG4gICAgICAgICAgICBpZiAodGFyZ2V0SWQgPT0ganNvbk1zZy50YXJnZXRJZCkge1xyXG4gICAgICAgICAgICAgICAgLy8gY2xlYXJNZXNzYWdlc1VucmVhZFN0YXR1cygpO1xyXG4gICAgICAgICAgICAgICAgLy8g6I635Y+W576k5oiQ5ZGY5aeT5ZCNXHJcbiAgICAgICAgICAgICAgICBpZiAoanNvbk1zZy5jb252ZXJzYXRpb25UeXBlID09IFwiR1JPVVBcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtZW1iZXJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbSA9IDA7IG0gPCBtZW1iZXJzLmxlbmd0aDsgbSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVtYmVyc1ttXS5pZCA9PSBqc29uTXNnLnNlbmRlclVzZXJJZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb25Nc2cubmFtZSA9IG1lbWJlcnNbbV0ubmFtZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdqc29uTXNnOicsIGpzb25Nc2cpO1xyXG4gICAgICAgICAgICAgICAgdmFyIHRtcE1zZyA9IG15VXRpbC5yZXNvbHZlTXNnKGpzb25Nc2cpO1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmhpc01zZ3MucHVzaCh0bXBNc2cpO1xyXG4gICAgICAgICAgICAgICAgc2Nyb2xsdG9Cb3R0b20oKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbmV3TWVzc2FnZUV2ZW50U2VydmljZS5saXN0ZW4obmV3TXNnQ2FsbEJhY2spO1xyXG4gICAgfSlcclxuIiwiYW5ndWxhci5tb2R1bGUoJ2NoYXQuY29udHJvbGxlcnMnKVxyXG4uY29udHJvbGxlcignZnJpZW5kSW5mb0N0cmwnLCBmdW5jdGlvbiAoJHNjb3BlLCBGcmllbmRzLCBCbGFja2xpc3QsICRzdGF0ZSwgJGlvbmljTG9hZGluZyxcclxuICAgICAkc3RhdGVQYXJhbXMsICR0aW1lb3V0LCBSZXNGcmllbmQpIHtcclxuICAgICAgICAkc2NvcGUuVGFyZ2V0ID0gRnJpZW5kcy5nZXQoJHN0YXRlUGFyYW1zLnRhcmdldElkKTtcclxuICAgICAgICB2YXIgdGFyZ2V0SWQgPSAkc3RhdGVQYXJhbXMudGFyZ2V0SWQ7XHJcbiAgICAgICAgdmFyIHRhcmdldE5hbWUgPSAkc3RhdGVQYXJhbXMudGFyZ2V0TmFtZTtcclxuICAgICAgICAkc2NvcGUuaXNGcmllbmQgPSB0cnVlO1xyXG5cclxuICAgICAgICAvLyDpnZ7lpb3lj4tcclxuICAgICAgICBpZiAoJHNjb3BlLlRhcmdldCA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICRzY29wZS5pc0ZyaWVuZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAkc2NvcGUuVGFyZ2V0ID0geyBuYW1lOiB0YXJnZXROYW1lLCBpZDogdGFyZ2V0SWQgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgICRzY29wZS5zZXR0aW5ncyA9IHtcclxuICAgICAgICAgICAgaW5CbGFja0xpc3Q6IGZhbHNlXHJcbiAgICAgICAgfTtcclxuICAgICAgICB2YXIgbGlzdHMgPSBCbGFja2xpc3QuYWxsKCk7XHJcbiAgICAgICAgaWYgKCFsaXN0cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgLy8g6I635Y+W6buR5ZCN5Y2VXHJcbiAgICAgICAgICAgIFJvbmdDbG91ZExpYlBsdWdpbi5nZXRCbGFja2xpc3QoXHJcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmV0LCBlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmV0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdnZXRCbGFja2xpc3Q6JyArIEpTT04uc3RyaW5naWZ5KHJldCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXNlcmluZm87XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmV0LnJlc3VsdC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcmluZm8gPSBGcmllbmRzLmdldChyZXQucmVzdWx0W2ldKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RzLnB1c2goeyBpZDogcmV0LnJlc3VsdFtpXSwgdXNlcm5hbWU6IHVzZXJpbmZvLnVzZXJuYW1lLCBwb3J0cmFpdDogdXNlcmluZm8ucG9ydHJhaXQgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgQmxhY2tsaXN0LnNldChsaXN0cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdCbGFja2xpc3Q6JyArIEpTT04uc3RyaW5naWZ5KEJsYWNrbGlzdC5hbGwoKSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygkc3RhdGVQYXJhbXMudGFyZ2V0SWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShCbGFja2xpc3QuZ2V0KCRzdGF0ZVBhcmFtcy50YXJnZXRJZCkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEJsYWNrbGlzdC5nZXQoJHN0YXRlUGFyYW1zLnRhcmdldElkKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5zZXR0aW5ncy5pbkJsYWNrTGlzdCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2xvZ291dCBlcnJvcjonICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KCdsb2dvdXQgZXJyb3I6JyArIEpTT04uc3RyaW5naWZ5KGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChCbGFja2xpc3QuZ2V0KCRzdGF0ZVBhcmFtcy50YXJnZXRJZCkpXHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuc2V0dGluZ3MuaW5CbGFja0xpc3QgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8g5Y+R6YCB5raI5oGvLOi3s+i9rOWIsOiBiuWkqeeVjOmdolxyXG4gICAgICAgICRzY29wZS5zZW5kTXNnID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAvL2FsZXJ0KCdwIHkgaXMgaGVyZSByZWFkeSB0byBob21lOicgKyAkc3RhdGVQYXJhbXMudGFyZ2V0SWQgKyBcIjpcIiArICRzdGF0ZVBhcmFtcy5jb252ZXJzYXRpb25UeXBlKTtcclxuICAgICAgICAgICAgJHN0YXRlLmdvKCd0YWIuY2hhdERldGFpbCcsIHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2VJZDogJzEnLCBuYW1lOiB0YXJnZXROYW1lLCB0YXJnZXRJZDogdGFyZ2V0SWQsXHJcbiAgICAgICAgICAgICAgICBjb252ZXJzYXRpb25UeXBlOiAkc3RhdGVQYXJhbXMuY29udmVyc2F0aW9uVHlwZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vd3MvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cclxuICAgICAgICAvLyDnm7TmjqXop4bpopHogYrlpKlcclxuICAgICAgICAkc2NvcGUudmVkaW9DaGF0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAvL2FsZXJ0KCdjaGF0ZGV0aWFsOicgKyAkc3RhdGVQYXJhbXMudGFyZ2V0SWQpO1xyXG4gICAgICAgICAgICB2YXIgb2JqID0geyBpc0NhbGxpbmc6IHRydWUsIGNvbnRhY3ROYW1lOiAkc3RhdGVQYXJhbXMudGFyZ2V0SWQgfTtcclxuICAgICAgICAgICAgJHN0YXRlLmdvKCdjYWxsJywgb2JqKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOa3u+WKoOmZjOeUn+S6uuS4uuWlveWPi1xyXG4gICAgICAgICRzY29wZS5hZGRGcmllbmQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIC8vIDAg5Li65Y+R6YCB5aW95Y+L6K+35rGCXHJcbiAgICAgICAgICAgIFJlc0ZyaWVuZCh0YXJnZXRJZCwgMCwgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgLy8g5oiQ5Yqf5ZCO5Yig5o6J6K6w5b2V5bm25Yi35paw5aW95Y+L5YiX6KGoXHJcbiAgICAgICAgICAgICAgICB2YXIgc2hvd01zZyA9IFwi5oKo5bey5Y+R6YCB5aW95Y+L6K+35rGCIVwiO1xyXG4gICAgICAgICAgICAgICAgJGlvbmljTG9hZGluZy5zaG93KHtcclxuICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogc2hvd01zZ1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGlvbmljTG9hZGluZy5oaWRlKCk7XHJcbiAgICAgICAgICAgICAgICB9LCA3NTApO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOa3u+WKoC/np7vpmaTpu5HlkI3ljZVcclxuICAgICAgICAkc2NvcGUuY2hCbGFja0xpc3QgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuc2V0dGluZ3MuaW5CbGFja0xpc3QpIHtcclxuICAgICAgICAgICAgICAgIFJvbmdDbG91ZExpYlBsdWdpbi5hZGRUb0JsYWNrbGlzdCh7IHVzZXJJZDogJHN0YXRlUGFyYW1zLnRhcmdldElkIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJldCwgZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KCfliqDlhaXpu5HlkI3ljZXmiJDlip8hJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXNlcmluZm8gPSBGcmllbmRzLmdldCgkc3RhdGVQYXJhbXMudGFyZ2V0SWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgQmxhY2tsaXN0LmFkZE9uZSh7IGlkOiAkc3RhdGVQYXJhbXMudGFyZ2V0SWQsIHVzZXJuYW1lOiB1c2VyaW5mby51c2VybmFtZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3J0cmFpdDogdXNlcmluZm8ucG9ydHJhaXQgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ2FkZFRvQmxhY2tsaXN0IGVycm9yOicgKyBKU09OLnN0cmluZ2lmeShlcnIpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBSb25nQ2xvdWRMaWJQbHVnaW4ucmVtb3ZlRnJvbUJsYWNrbGlzdCh7IHVzZXJJZDogJHN0YXRlUGFyYW1zLnRhcmdldElkIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJldCwgZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIEJsYWNrbGlzdC5yZW1vdmVPbmUoJHN0YXRlUGFyYW1zLnRhcmdldElkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KCfnp7vlh7rpu5HlkI3ljZXmiJDlip8hJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ3JlbW92ZUZyb21CbGFja2xpc3QgZXJyb3I6JyArIEpTT04uc3RyaW5naWZ5KGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbiIsImFuZ3VsYXIubW9kdWxlKCdjaGF0LmNhbGwnLCBbXSlcclxuICAgIC8vIOmAmuivnVxyXG4gICAgLmNvbnRyb2xsZXIoJ0NhbGxDdHJsJywgZnVuY3Rpb24gKCRzY29wZSwgJHN0YXRlLCAkcm9vdFNjb3BlLCAkdGltZW91dCwgJGlvbmljSGlzdG9yeSxcclxuICAgICAgICAkc3RhdGVQYXJhbXMsIHNpZ25hbGluZywgRnJpZW5kcywgcm9uZ3l1blNlcnZpY2UsIG1lZGlhU2VydmljZSkge1xyXG4gICAgICAgIHZhciBkdXBsaWNhdGVNZXNzYWdlcyA9IFtdO1xyXG4gICAgICAgIC8vIOiOt+WPluiBlOezu+S6ulxyXG4gICAgICAgICRzY29wZS5jb250YWN0cyA9IHt9O1xyXG4gICAgICAgIC8vIOmdmemfs1xyXG4gICAgICAgICRzY29wZS5tdXRlZCA9IGZhbHNlO1xyXG4gICAgICAgIC8vIOaYr+WQpumAmuivneS4rVxyXG4gICAgICAgICRzY29wZS5jYWxsSW5Qcm9ncmVzcyA9IGZhbHNlO1xyXG4gICAgICAgIC8vIOaYr+WQpuS4u+WKqOWPkei1t1xyXG4gICAgICAgICRzY29wZS5pc0NhbGxpbmcgPSAkc3RhdGVQYXJhbXMuaXNDYWxsaW5nID09PSAndHJ1ZSc7XHJcblxyXG4gICAgICAgIC8vIOWTjemTg1xyXG4gICAgICAgIGlmICghJHNjb3BlLmlzQ2FsbGluZykge1xyXG4gICAgICAgICAgICBtZWRpYVNlcnZpY2UucGxheVNvdW5kKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOafpeaJvuiBlOezu+S6uuS/oeaBr1xyXG4gICAgICAgIHZhciBjb250YWN0VXNlciA9IEZyaWVuZHMuZ2V0KCRzdGF0ZVBhcmFtcy5jb250YWN0TmFtZSk7XHJcbiAgICAgICAgaWYgKCFjb250YWN0VXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgICRzY29wZS5jb250YWN0VXNlciA9IGNvbnRhY3RVc2VyO1xyXG4gICAgICAgICRzY29wZS5jb250YWN0TmFtZSA9IGNvbnRhY3RVc2VyLmlkO1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBjYWxsKGlzSW5pdGlhdG9yLCBjb250YWN0TmFtZSkge1xyXG4gICAgICAgICAgICBpZiAoaXNJbml0aWF0b3IpIHtcclxuICAgICAgICAgICAgICAgIHNlbmRNZXNzYWdlKCdb5Y+R6LW36KeG6aKR6YCa6K+dXScpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIHNlc3Npb27pgJror53liJ3lp4vljJZcclxuICAgICAgICAgICAgdmFyIHNlc3Npb24gPSBwaG9uZVJUQ1NlcnZpY2UuY3JlYXRlU2Vzc2lvbigpO1xyXG4gICAgICAgICAgICBzZXNzaW9uLm9uKCdzZW5kTWVzc2FnZScsIGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBzaWduYWxpbmcuZW1pdCgnc2VuZE1lc3NhZ2UnLCBjb250YWN0TmFtZSwge1xyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdwaG9uZXJ0Y19oYW5kc2hha2UnLFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGRhdGEpXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHNlc3Npb24ub24oJ2Fuc3dlcicsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdBbnN3ZXJlZCEnKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHNlc3Npb24ub24oJ2Rpc2Nvbm5lY3QnLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLmNvbnRhY3RzW2NvbnRhY3ROYW1lXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSAkc2NvcGUuY29udGFjdHNbY29udGFjdE5hbWVdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKCRzY29wZS5jb250YWN0cykubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2lnbmFsaW5nLmVtaXQoJ3NlbmRNZXNzYWdlJywgY29udGFjdE5hbWUsIHsgdHlwZTogJ2lnbm9yZScgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy9qdW5tYmFjaygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGFsZXJ0KCcqKioqKioqKioqKipkaXNjb25uZWN0cyoqKioqKioqKioqKionKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHNlc3Npb24uY2FsbCgpO1xyXG4gICAgICAgICAgICAvLyDkv53lrZjov57mjqVcclxuICAgICAgICAgICAgJHNjb3BlLmNvbnRhY3RzW2NvbnRhY3ROYW1lXSA9IHNlc3Npb247XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOaLqOWPt1vlj5HotbddXHJcbiAgICAgICAgaWYgKCRzY29wZS5pc0NhbGxpbmcpIHtcclxuICAgICAgICAgICAgLy9hbGVydCgn5Y+R6LW36IGK5aSp77yaJyArICRzY29wZS5jb250YWN0TmFtZSArICdpcyBDYWxsaW5nOicgKyAkc2NvcGUuaXNDYWxsaW5nKTtcclxuICAgICAgICAgICAgc2lnbmFsaW5nLmVtaXQoJ3NlbmRNZXNzYWdlJywgJHNjb3BlLmNvbnRhY3ROYW1lLCB7IHR5cGU6ICdjYWxsJyB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOW/veeVpVxyXG4gICAgICAgICRzY29wZS5pZ25vcmUgPSBmdW5jdGlvbiAobXNnKSB7XHJcbiAgICAgICAgICAgIGFsZXJ0KCflv73nlaUnKTtcclxuICAgICAgICAgICAgaWYgKHJpbmcpIHtcclxuICAgICAgICAgICAgICAgIHJpbmcucmVsZWFzZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHNlbmRNZXNzYWdlKG1zZyk7XHJcbiAgICAgICAgICAgIHZhciBjb250YWN0TmFtZXMgPSBPYmplY3Qua2V5cygkc2NvcGUuY29udGFjdHMpO1xyXG4gICAgICAgICAgICBpZiAoY29udGFjdE5hbWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICRzY29wZS5jb250YWN0c1tjb250YWN0TmFtZXNbMF1dLmRpc2Nvbm5lY3QoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNpZ25hbGluZy5lbWl0KCdzZW5kTWVzc2FnZScsICRzY29wZS5jb250YWN0TmFtZSwgeyB0eXBlOiAnaWdub3JlJyB9KTtcclxuICAgICAgICAgICAgICAgICRzY29wZS5jYWxsSW5Qcm9ncmVzcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAganVubWJhY2soKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIOe7k+adn+mAmuivnVxyXG4gICAgICAgICRzY29wZS5lbmQgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGFsZXJ0KCfnu5PmnZ8nKTtcclxuICAgICAgICAgICAgc2VuZE1lc3NhZ2UoJ1vnu5PmnZ/pgJror51dJyk7XHJcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKCRzY29wZS5jb250YWN0cykuZm9yRWFjaChmdW5jdGlvbiAoY29udGFjdCkge1xyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmNvbnRhY3RzW2NvbnRhY3RdLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgJHNjb3BlLmNvbnRhY3RzW2NvbnRhY3RdO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgc2lnbmFsaW5nLmVtaXQoJ3NlbmRNZXNzYWdlJywgJHNjb3BlLmNvbnRhY3ROYW1lLCB7IHR5cGU6ICdlbmQnIH0pO1xyXG4gICAgICAgICAgICAkc2NvcGUuY2FsbEluUHJvZ3Jlc3MgPSBmYWxzZTtcclxuICAgICAgICAgICAganVubWJhY2soKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyDmjqXlkKxcclxuICAgICAgICAkc2NvcGUuYW5zd2VyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAvL2FsZXJ0KCfmjqXlkKwnKTtcclxuICAgICAgICAgICAgaWYgKHJpbmcpIHtcclxuICAgICAgICAgICAgICAgIHJpbmcucmVsZWFzZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICgkc2NvcGUuY2FsbEluUHJvZ3Jlc3MpIHtcclxuICAgICAgICAgICAgICAgIGFsZXJ0KCcqKioqKuato+WcqOmAmuivneS4reWTpioqKioqJyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgJHNjb3BlLmNhbGxJblByb2dyZXNzID0gdHJ1ZTtcclxuICAgICAgICAgICAgLy8gMXMg5ZCO5pi+56S66KeG6aKRXHJcbiAgICAgICAgICAgICR0aW1lb3V0KCRzY29wZS51cGRhdGVWaWRlb1Bvc2l0aW9uLCAxMDAwKTtcclxuICAgICAgICAgICAgY2FsbChmYWxzZSwgJHNjb3BlLmNvbnRhY3ROYW1lKTtcclxuICAgICAgICAgICAgLy8gMS41cyDlkI7mjqXlkKxcclxuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBzaWduYWxpbmcuZW1pdCgnc2VuZE1lc3NhZ2UnLCAkc2NvcGUuY29udGFjdE5hbWUsIHsgdHlwZTogJ2Fuc3dlcicgfSk7XHJcbiAgICAgICAgICAgIH0sIDE1MDApO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIOmdmemfs1xyXG4gICAgICAgIC8vICRzY29wZS50b2dnbGVNdXRlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIC8vICAgICAkc2NvcGUubXV0ZWQgPSAhJHNjb3BlLm11dGVkO1xyXG4gICAgICAgIC8vICAgICBPYmplY3Qua2V5cygkc2NvcGUuY29udGFjdHMpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHtcclxuICAgICAgICAvLyAgICAgICAgIHZhciBzZXNzaW9uID0gJHNjb3BlLmNvbnRhY3RzW2NvbnRhY3RdO1xyXG4gICAgICAgIC8vICAgICAgICAgc2Vzc2lvbi5zdHJlYW1zLmF1ZGlvID0gISRzY29wZS5tdXRlZDtcclxuICAgICAgICAvLyAgICAgICAgIHNlc3Npb24ucmVuZWdvdGlhdGUoKTtcclxuICAgICAgICAvLyAgICAgfSk7XHJcbiAgICAgICAgLy8gfTtcclxuXHJcbiAgICAgICAgJHNjb3BlLnVwZGF0ZVZpZGVvUG9zaXRpb24gPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgndmlkZW9WaWV3LnVwZGF0ZVBvc2l0aW9uJyk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8gPT09IHNvY2tldC5pb+a2iOaBr+WIhuexu+WkhOeQhihCRUdJTikgPT09XHJcbiAgICAgICAgZnVuY3Rpb24gb25NZXNzYWdlUmVjZWl2ZShuYW1lLCBtZXNzYWdlKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAobWVzc2FnZS50eXBlKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdhbnN3ZXInOlxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGFsZXJ0KCcqKioqKioqKioqKirliKvkurrngrnkuobmjqXlkKzlkYAqKioqKioqKioqKioqJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseShmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRzY29wZS5jYWxsSW5Qcm9ncmVzcyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICR0aW1lb3V0KCRzY29wZS51cGRhdGVWaWRlb1Bvc2l0aW9uLCAxMDAwKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ29udGFjdHMgPSBPYmplY3Qua2V5cygkc2NvcGUuY29udGFjdHMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ0NvbnRhY3RzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaWduYWxpbmcuZW1pdCgnc2VuZE1lc3NhZ2UnLCBuYW1lLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnYWRkX3RvX2dyb3VwJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhY3RzOiBleGlzdGluZ0NvbnRhY3RzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNJbml0aWF0b3I6IGZhbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjYWxsKHRydWUsIG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGFsZXJ0KCcqKioqKioqKioqKipjYWxsIOaWueazleayoeaciemXrumimOWRgCoqKioqKioqKioqKionKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIC8vIOaLkue7neaOpeWQrCjlv73nlaUpXHJcbiAgICAgICAgICAgICAgICBjYXNlICdpZ25vcmUnOlxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBsZW4gPSBPYmplY3Qua2V5cygkc2NvcGUuY29udGFjdHMpLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobGVuID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoJHNjb3BlLmNvbnRhY3RzW25hbWVdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY29udGFjdHNbbmFtZV0uY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSAkc2NvcGUuY29udGFjdHNbbmFtZV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSAkc2NvcGUuaGlkZUZyb21Db250YWN0TGlzdC5pbmRleE9mKG5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuaGlkZUZyb21Db250YWN0TGlzdC5zcGxpY2UoaSwgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cygkc2NvcGUuY29udGFjdHMpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNhbGxJblByb2dyZXNzID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqdW5tYmFjaygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNhbGxJblByb2dyZXNzID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGp1bm1iYWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgLy8g57uT5p2f6YCa6K+dXHJcbiAgICAgICAgICAgICAgICBjYXNlICdlbmQnOlxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGFsZXJ0KCflr7nmlrnlt7Lnu4/nu5PmnZ/pgJror50nKTtcclxuICAgICAgICAgICAgICAgICAgICBPYmplY3Qua2V5cygkc2NvcGUuY29udGFjdHMpLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNvbnRhY3RzW2NvbnRhY3RdLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSAkc2NvcGUuY29udGFjdHNbY29udGFjdF07XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuY2FsbEluUHJvZ3Jlc3MgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAganVubWJhY2soKTtcclxuICAgICAgICAgICAgICAgICAgICB9LCAxMDAwKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3Bob25lcnRjX2hhbmRzaGFrZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5pys5oSP5piv5bGP6JS96YeN5aSN5L+h5oGv77yM6L+Z6YeM5oiRQGtvYmVwZW5n5YWI5Y675o6J5LqGXHJcbiAgICAgICAgICAgICAgICAgICAgLy9pZiAoZHVwbGljYXRlTWVzc2FnZXMuaW5kZXhPZihtZXNzYWdlLmRhdGEpID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGtleSA6IHJlY2VpdmVNZXNzYWdlXHJcbiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmNvbnRhY3RzW25hbWVdLnJlY2VpdmVNZXNzYWdlKEpTT04ucGFyc2UobWVzc2FnZS5kYXRhKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICBkdXBsaWNhdGVNZXNzYWdlcy5wdXNoKG1lc3NhZ2UuZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnYWRkX3RvX2dyb3VwJzpcclxuICAgICAgICAgICAgICAgICAgICBhbGVydChcImFkZF90b19ncm91cFwiKTtcclxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmNvbnRhY3RzLmZvckVhY2goZnVuY3Rpb24gKGNvbnRhY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJHNjb3BlLmhpZGVGcm9tQ29udGFjdExpc3QucHVzaChjb250YWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbChtZXNzYWdlLmlzSW5pdGlhdG9yLCBjb250YWN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtZXNzYWdlLmlzSW5pdGlhdG9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lnbmFsaW5nLmVtaXQoJ3NlbmRNZXNzYWdlJywgY29udGFjdCwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnYWRkX3RvX2dyb3VwJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFjdHM6IFtDb250YWN0c1NlcnZpY2UuY3VycmVudE5hbWVdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0luaXRpYXRvcjogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMTUwMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ2NhbGxJblByb2dyZXNzJzpcclxuICAgICAgICAgICAgICAgICAgICBhbGVydCgn5a+55pa55q2j5Zyo6YCa6K+d5LitIScpO1xyXG4gICAgICAgICAgICAgICAgICAgIGp1bm1iYWNrKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OiBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBzaWduYWxpbmcub24oJ21lc3NhZ2VSZWNlaXZlZCcsIG9uTWVzc2FnZVJlY2VpdmUpO1xyXG4gICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBzaWduYWxpbmcucmVtb3ZlTGlzdGVuZXIoJ21lc3NhZ2VSZWNlaXZlZCcsIG9uTWVzc2FnZVJlY2VpdmUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGZ1bmN0aW9uIHNlbmRNZXNzYWdlKGNvbnRlbnQpIHtcclxuICAgICAgICAgICAgcm9uZ3l1blNlcnZpY2Uuc2VuZE1lc3NhZ2UoXCJQUklWQVRFXCIsIGNvbnRhY3RVc2VyLmlkLCBjb250ZW50KS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XHJcbiAgICAgICAgICAgICAgICBhcHBlbmROZXdNc2coZGF0YSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmdW5jdGlvbiBqdW5tYmFjaygpIHtcclxuICAgICAgICAgICAgJGlvbmljSGlzdG9yeS5nb0JhY2soLTEpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4iLCIvKipcclxuICog5b6F5rWLXHJcbiAqL1xyXG5cclxuYW5ndWxhci5tb2R1bGUoJ2NoYXQuY29udHJvbGxlcnMnKVxyXG4gICAgLmNvbnRyb2xsZXIoJ2FkZEdyb3VwbWVtYmVyJywgZnVuY3Rpb24gKCRzY29wZSwgJHN0YXRlUGFyYW1zLFxyXG4gICAgICAgICRpb25pY1BvcHVwLCAkY29yZG92YUNvbnRhY3RzLCAkaW9uaWNIaXN0b3J5LCBteU5vdGUsICR0aW1lb3V0LFxyXG4gICAgICAgIEZyaWVuZHMsIEdyb3VwcywgQWRkR3JvdXBSZXF1ZXN0KSB7XHJcbiAgICAgICAgdmFyIEdyb3VwSUQgPSAkc3RhdGVQYXJhbXMuR3JvdXBJRDtcclxuICAgICAgICB2YXIgZ3JvdXAgPSB7fTtcclxuXHJcbiAgICAgICAgLy8g6I635Y+W5aW95Y+L5YiX6KGoXHJcbiAgICAgICAgRnJpZW5kcy5hbGwoZnVuY3Rpb24gKGZybnMpIHtcclxuICAgICAgICAgICAgdmFyIGdycCA9IEdyb3Vwcy5nZXRHcm91cE1lbWJlcnMoR3JvdXBJRCwgZnVuY3Rpb24gKG1lbWJlcnMpIHtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZnJucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGZybnNbaV0uTWVtYmVySUQgPSBcIlwiO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbWVtYmVycy5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZnJuc1tpXS5pZCA9PSBtZW1iZXJzW2pdLl9pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJuc1tpXS5jaGVja2VkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZybnNbaV0uTWVtYmVySUQgPSBcIjEyM1wiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPSBmcm5zO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8g5o+Q5LqkXHJcbiAgICAgICAgJHNjb3BlLnN1cmUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBtZW1iZXJzID0gW107XHJcbiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaCgkc2NvcGUuZnJpZW5kcywgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgIGlmICghIWRhdGEuY2hlY2tlZCAmJiBkYXRhLk1lbWJlcklEID09IFwiXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBtZW1iZXJzLnB1c2goZGF0YS5pZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBhZGRHcm91cE1lbWJlcihtZW1iZXJzKTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvLyDlj5HpgIHlhaXnvqTor7fmsYJcclxuICAgICAgICBmdW5jdGlvbiBhZGRHcm91cE1lbWJlcihtZW1iZXJzKSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbWVtYmVycy5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgLy8gdXNlcmlk77yMZnJpbmRpZO+8jGdyb3VwaWTvvIwgXHJcbiAgICAgICAgICAgICAgICBBZGRHcm91cFJlcXVlc3QobWVtYmVyc1tpXSwgR3JvdXBJRCwgZnVuY3Rpb24gKGRhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgICBhbGVydChcIuivt+axguWlveWPi+S7rOWFpee+pOWPkemAgeaIkOWKn++8gVwiKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSkiLCJhbmd1bGFyLm1vZHVsZSgnY2hhdC5jb250cm9sbGVycycpXHJcbiAgICAuY29udHJvbGxlcignZ3JvdXBJbmZvQ3RybCcsIGZ1bmN0aW9uICgkc2NvcGUsIEdyb3VwcywgJHN0YXRlLFxyXG4gICAgICAgICRzdGF0ZVBhcmFtcywgUmVxdWVzdFVybCkge1xyXG4gICAgICAgICRzY29wZS5UYXJnZXQgPSBHcm91cHMuZ2V0KCRzdGF0ZVBhcmFtcy50YXJnZXRJZCk7XHJcbiAgICAgICAgdmFyIHRhcmdldElkID0gJHN0YXRlUGFyYW1zLnRhcmdldElkO1xyXG4gICAgICAgIHZhciB0YXJnZXROYW1lID0gJHN0YXRlUGFyYW1zLnRhcmdldE5hbWU7XHJcbiAgICAgICAgdmFyIGNvbnZlcnNhdGlvblR5cGUgPSAkc3RhdGVQYXJhbXMuY29udmVyc2F0aW9uVHlwZTtcclxuXHJcbiAgICAgICAgLy8g5Y+R6YCB576k5raI5oGvXHJcbiAgICAgICAgJHNjb3BlLnNlbmRNc2cgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICRzdGF0ZS5nbygndGFiLmNoYXREZXRhaWwnLFxyXG4gICAgICAgICAgICAgICAgeyBuYW1lOiB0YXJnZXROYW1lLCB0YXJnZXRJZDogdGFyZ2V0SWQsIGNvbnZlcnNhdGlvblR5cGU6IGNvbnZlcnNhdGlvblR5cGUgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOa3u+WKoOe+pOaIkOWRmFxyXG4gICAgICAgICRzY29wZS5hZGRHcm91cG1lbWJlciA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgJHN0YXRlLmdvKCd0YWIuYWRkR3JvdXBtZW1iZXInLFxyXG4gICAgICAgICAgICAgICAgeyBHcm91cElEOiB0YXJnZXRJZCB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgJHNjb3BlLm1lbWJlcnMgPSBbXTtcclxuICAgICAgICBmdW5jdGlvbiBnZXRHcm91cE1lbSgpIHtcclxuICAgICAgICAgICAgR3JvdXBzLmdldEdyb3VwTWVtYmVycyh0YXJnZXRJZCwgY2FsbGJhY2spO1xyXG4gICAgICAgICAgICBmdW5jdGlvbiBjYWxsYmFjayhtZW1iZXJzKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gbWVtYmVycy5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAkc2NvcGUuVGFyZ2V0Lm51bWJlciA9IGxlbmd0aDtcclxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0ge307XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbWRhdGEgPSBtZW1iZXJzW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgIG9iai5pZCA9IHRlbWRhdGEuX2lkO1xyXG4gICAgICAgICAgICAgICAgICAgIG9iai5uYW1lID0gdGVtZGF0YS5uaWNrbmFtZTtcclxuICAgICAgICAgICAgICAgICAgICBvYmoucG9ydHJhaXQgPSB0ZW1kYXRhLmhlYWRpbWcgPyBSZXF1ZXN0VXJsICsgJ0ltYWdlcy9QaG90by8nICsgdGVtZGF0YS5oZWFkaW1nIDogbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICAkc2NvcGUubWVtYmVycy5wdXNoKG9iaik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6I635Y+W576k57uE5oiQ5ZGYXHJcbiAgICAgICAgZ2V0R3JvdXBNZW0oKTtcclxuICAgIH0pOyIsIi8qKlxyXG4gKiBjaGF05qih5Z2X5pyN5YqhXHJcbiovXHJcbnZhciBjaGF0X21vZHVsZXMgPSBbJ2NoYXQucm91dGUnLCAnY2hhdC5jb250cm9sbGVycycsICdjaGF0LnNlcnZpY2VzJywgJ2NoYXQuZGlyZWN0aXZlJywgJ2NoYXQuZmlsdGVyJ107XHJcbmNoYXRfbW9kdWxlcy5jb25jYXQoW1wiY2hhdC5jYWxsXCJdKTtcclxuYW5ndWxhci5tb2R1bGUoJ2NoYXQnLCBjaGF0X21vZHVsZXMpXHJcbiAgLy8g6KeG6aKR5pyN5Yqh6YWN572uXHJcbiAgLmNvbmZpZyhmdW5jdGlvbiAoU2lnbmFsaW5nUHJvdmlkZXIsIFZFRElPX0NIQVRfVVJMKSB7XHJcbiAgICBTaWduYWxpbmdQcm92aWRlci5zZXRCYWNrZW5kVXJsKFZFRElPX0NIQVRfVVJMKTtcclxuICB9KVxyXG4gIC8qKlxyXG4gICAqIOacjeWKoeWIneWni+WMllxyXG4gICAqIEBwYXJhbSAge1tPYmplY3RdfSAkc3RhdGUgW+i3s+i9rOacjeWKoV1cclxuICAgKiBAcGFyYW0gIHtbT2JqZWN0XX0gU2lnbmFsaW5nIFtzb2NrZXQuaW/lrp7kvotdXHJcbiAgICogQHBhcmFtICB7W09iamVjdF19ICRpb25pY0xvYWRpbmcgW+WKoOi9veW8ueWxgl1cclxuICAgKiBAcGFyYW0gIHtbT2JqZWN0XX0gJHJvb3RTY29wZSBb5YWo5bGAc2NvcGVdXHJcbiAgICogQHBhcmFtICB7W09iamVjdF19IG5ld01lc3NhZ2VFdmVudFNlcnZpY2UgW+aWsOa2iOaBr+S6i+S7tuacjeWKoV1cclxuICAgKi9cclxuICAucnVuKGZ1bmN0aW9uICgkc3RhdGUsIFNpZ25hbGluZywgJGlvbmljTG9hZGluZywgJHJvb3RTY29wZSwgbmV3TWVzc2FnZUV2ZW50U2VydmljZSkge1xyXG4gICAgdmFyIGNoTXNnID0gZnVuY3Rpb24gKG5ld1ZhbHVlLCBvbGRWYWx1ZSkge1xyXG4gICAgICBpZiAobmV3VmFsdWUgIT09IG9sZFZhbHVlKSB7XHJcbiAgICAgICAgdmFyIGpzb25Nc2cgPSBuZXdWYWx1ZS5wb3AoKTtcclxuICAgICAgICBpZiAodHlwZW9mIGpzb25Nc2cgIT09IFwidW5kZWZpbmVkXCIgJiYganNvbk1zZyAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgbmV3TWVzc2FnZUV2ZW50U2VydmljZS5icm9hZGNhc3QoanNvbk1zZyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgLy8gd2F0Y2ggaXRlbXPnmoTlj5jljJZcclxuICAgIHZhciBsaXN0ZW5lciA9ICRyb290U2NvcGUuJHdhdGNoKCdhcnJNc2dzJywgY2hNc2csIHRydWUpO1xyXG4gICAgU2lnbmFsaW5nLm9uKCdtZXNzYWdlUmVjZWl2ZWQnLCBmdW5jdGlvbiAobmFtZSwgbWVzc2FnZSwgU2lnbmFsaW5nKSB7XHJcbiAgICAgIHN3aXRjaCAobWVzc2FnZS50eXBlKSB7XHJcbiAgICAgICAgY2FzZSAnY2FsbCc6XHJcbiAgICAgICAgICBpZiAoJHN0YXRlLmN1cnJlbnQubmFtZSA9PT0gJ2NhbGwnKSB7XHJcbiAgICAgICAgICAgIFNpZ25hbGluZy5lbWl0KCdzZW5kTWVzc2FnZScsIG5hbWUsIHsgdHlwZTogJ2NhbGxJblByb2dyZXNzJyB9KTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgJHN0YXRlLmdvKCdjYWxsJywgeyBpc0NhbGxpbmc6IGZhbHNlLCBjb250YWN0TmFtZTogbmFtZSB9KTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcblxyXG4iXX0=

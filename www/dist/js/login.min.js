angular.module('login.service', [])
  .factory('LogoutService', ['$state', '$ionicHistory',
    function ($state, $ionicHistory) {
      var _logout = function () {
        $ionicHistory.clearHistory();
        $state.go('tab.login');
      };
      return {
        logout: _logout,
      }
    }])
  .factory("LoginService", ["$http", "Services", '$q',
    function ($http, Services, $q) {
      var _login = function (user) {
        var deferred = $q.defer();
        user.password = EncryptService.rsa_encrypt(user.password);
        $http({ method: 'POST', url: Services.LOGIN.url, data: user }).success(function (data) {
          deferred.resolve(data);
        }).error(function (err) {
          deferred.reject(err);
        });
        return deferred.promise;
      };

      var _logout = function () {
        var deferred = $q.defer();
        $http({ method: 'POST', url: Services.LOGOUT.url }).success(function (data) {
          deferred.resolve(data);
        })
          .error(function (err) {
            deferred.reject(err);
          });
        return deferred.promise;
      };

      var _registerSms = function (mobile) {
        var deferred = $q.defer();
        $http({
          method: 'POST',
          url: Services.REGISTER_SMS.url,
          data: { "mobile": mobile }
        }).success(function (data) {
          deferred.resolve(data);
        })
          .error(function (err) {
            deferred.reject(err);
          });
        return deferred.promise;
      };

      var _register = function (user) {
        var deferred = $q.defer();
        user.password = EncryptService.rsa_encrypt(user.password);
        $http({ method: 'POST', url: Services.REGISTER.url, data: user })
          .success(function (data) {
            deferred.resolve(data);
          })
          .error(function (err) {
            deferred.reject(err);
          });
        return deferred.promise;
      };
      return {
        login: _login,
        logout: _logout,
        registerSms: _registerSms,
        register: _register
      };
    }])
  // 用户全局引用
  .service("currentUser", function (CacheFactory, $rootScope) {
    var userinfo = null;
    var projectinfo = null;
    // 项目切换
    $rootScope.$on("change Project", function (evt, PCode, PName) {
      userinfo.PCode = PCode;
      projectinfo.PName = PName;
    });
    var userservive = {
      getUserinfo: function () {
        if (userinfo == null) {
          var mockdata = {
            "_id": "5812ebdf4c0b0e79324f6cb1", "nickname": "彭奕", "username": "py",
            "password": "123", "headimg": "", "EMail": "yipeng.info@gmail.com",
          };
          userinfo = mockdata;
        }
        return userinfo;
      },
      setUserinfo: function (val) {
        userinfo = val;
        return;
      },
      getProjectinfo: function () {
        return projectinfo;
      },
      setProjectinfo: function (val) {
        projectinfo = val[0];
        return;
      }
    }
    return userservive;
  })
  ;

/**
 * 10-29
 */
'use strict';
angular.module('login.route', [])
  .config(['$stateProvider', function ($stateProvider) {
    $stateProvider
      .state('login', {
        url: '/login',
        templateUrl: 'module/login/tpl/login.html',
        controller: 'LoginController',
      })
      .state('register', {
        url: '/register',
        templateUrl: 'module/login/tpl/register.html',
        controller: 'RegisterController',
      })
  }])
  ;

angular.module('login.controller', [])
  .controller('LoginController', LoginController)
  .controller('RegisterController', RegisterController)

function LoginController($scope, $rootScope, $ionicLoading, $state, LOGIN_URL, HttpPromiseService, currentUser) {
  $scope.submitting = false;
  $scope.user = {};
  $scope.validateOptions = {
    blurTrig: false,
    showError: false,
    removeError: false
  };

  $scope.login = function () {
    var params = {
      username: $scope.user.username,
      password: $scope.user.password
    };
    HttpPromiseService.getData(LOGIN_URL, params).then(function (data) {
      console.log(data);
      if (data.state = 1) {
        currentUser.setUserinfo(data.user);
        $state.go('tab.chat');
      } else {
        alert("登录失败");
      }
    });
  };
}

LoginController.$inject = ['$scope', '$rootScope', '$ionicLoading', '$state', 'LOGIN_URL', 'HttpPromiseService', 'currentUser'];

function RegisterController($scope, $rootScope, $ionicBackdrop, $ionicHistory, REGISTER_URL, HttpPromiseService, $state) {
  $scope.submitting = false;
  $scope.user = {};
  $scope.validateOptions = {
    blurTrig: false,
    showError: false,
    removeError: false
  };

  $scope.register = function () {
    $scope.submitting = true;
    var params = {
      username: $scope.user.username,
      password: $scope.user.password,
      nickname: $scope.user.username
    };
    HttpPromiseService.getData(REGISTER_URL, params).then(function (data) {
      console.log(data);
      if (data.state = 1) {
        alert("注册成功！");
        $state.go('login');
      } else {
        alert("注册失败");
      }
    });
  };

  $scope.goBack = function () {
    $ionicHistory.goBack(-1);
  }
}
RegisterController.$inject = ['$scope', '$rootScope', '$ionicBackdrop', '$ionicHistory', 'REGISTER_URL', 'HttpPromiseService', '$state'];

'use strict';
angular.module('login', [
  'login.controller',
  'login.service',
  'login.route'
])

;
